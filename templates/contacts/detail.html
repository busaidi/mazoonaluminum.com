{% extends "sales/base_sales.html" %}
{% load i18n %}

{% block title %}{{ contact.name }} – {% trans "جهة اتصال" %}{% endblock %}

{% block sales_content %}

{# هيدر عام لجهة الاتصال #}
<div class="card border-0 shadow-sm mb-4 bg-body">
  <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
      <h1 class="h4 fw-bold mb-1 text-body">
        {{ contact.name }}
      </h1>
      <p class="text-secondary small mb-0">
        {% if contact.company %}
          <a href="{% url 'contacts:contact_detail' contact.company_id %}"
             class="link-secondary text-decoration-none">
            {{ contact.company.name }}
          </a>
        {% elif contact.company_name %}
          {{ contact.company_name }}
        {% else %}
          {% trans "جهة اتصال في نظام Mazoon ERP" %}
        {% endif %}
      </p>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'contacts:contact_list' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-right ms-1"></i>
        {% trans "رجوع للقائمة" %}
      </a>
      <a href="{% url 'contacts:contact_edit' contact.pk %}" class="btn btn-primary btn-sm">
        <i class="bi bi-pencil ms-1"></i>
        {% trans "تعديل" %}
      </a>
      <a href="{% url 'contacts:contact_delete' contact.pk %}" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-trash ms-1"></i>
        {% trans "حذف" %}
      </a>
    </div>
  </div>
</div>

<div class="row g-3">

  <div class="col-lg-8">

    <div class="card border-0 shadow-sm mb-3 bg-body">
      <div class="card-header border-0 pb-0 bg-transparent">
        <ul class="nav nav-tabs card-header-tabs small gap-1">

          <li class="nav-item">
            <button class="nav-link active px-3 py-1"
                    data-bs-toggle="tab"
                    data-bs-target="#tab-basic"
                    type="button">
              {% trans "البيانات" %}
            </button>
          </li>

          <li class="nav-item">
            <button class="nav-link px-3 py-1"
                    data-bs-toggle="tab"
                    data-bs-target="#tab-payments"
                    type="button">
              {% trans "الدفعات" %}
            </button>
          </li>

          {% with people=contact.people.all %}
            {% if contact.is_company and people %}
              <li class="nav-item">
                <button class="nav-link px-3 py-1"
                        data-bs-toggle="tab"
                        data-bs-target="#tab-people"
                        type="button">
                  {% trans "الأشخاص المرتبطون" %}
                </button>
              </li>
            {% endif %}
          {% endwith %}

        </ul>
      </div>

      <div class="card-body">
        <div class="tab-content">

          {# تبويب البيانات الأساسية + العناوين #}
          <div class="tab-pane fade show active" id="tab-basic">

            {# معلومات أساسية #}
            <div class="mb-3">
              <h2 class="h6 fw-semibold mb-3">
                {% trans "معلومات جهة الاتصال" %}
              </h2>

              <div class="row g-3">
                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "الاسم" %}</div>
                  <div class="fw-semibold">{{ contact.name }}</div>
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "نوع جهة الاتصال" %}</div>
                  {% if contact.kind %}
                    <div class="fw-semibold">{{ contact.get_kind_display }}</div>
                  {% else %}
                    <div class="text-secondary small">—</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "الشركة (جهة اتصال)" %}</div>
                  {% if contact.company %}
                    <div class="fw-semibold">
                      <a href="{% url 'contacts:contact_detail' contact.company_id %}"
                         class="link-body-emphasis text-decoration-none">
                        {{ contact.company.name }}
                      </a>
                    </div>
                  {% else %}
                    <div class="text-secondary small">—</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "اسم الشركة (نص حر)" %}</div>
                  {% if contact.company_name %}
                    <div class="fw-semibold">{{ contact.company_name }}</div>
                  {% else %}
                    <div class="text-secondary small">—</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "الأدوار" %}</div>
                  <div class="d-flex flex-wrap gap-1">
                    {% if contact.is_customer %}
                      <span class="badge bg-dark-subtle text-dark-emphasis small">{% trans "زبون" %}</span>
                    {% endif %}
                    {% if contact.is_supplier %}
                      <span class="badge bg-warning-subtle text-warning-emphasis small">{% trans "مورد / شريك" %}</span>
                    {% endif %}
                    {% if contact.is_owner %}
                      <span class="badge bg-info-subtle text-info-emphasis small">{% trans "مالك" %}</span>
                    {% endif %}
                    {% if contact.is_employee %}
                      <span class="badge bg-success-subtle text-success-emphasis small">{% trans "موظف" %}</span>
                    {% endif %}
                    {% if not contact.is_customer and not contact.is_supplier and not contact.is_owner and not contact.is_employee %}
                      <span class="text-secondary small">—</span>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "الهاتف" %}</div>
                  {% if contact.phone %}
                    <div class="fw-semibold">{{ contact.phone }}</div>
                  {% else %}
                    <div class="text-secondary small">—</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "البريد الإلكتروني" %}</div>
                  {% if contact.email %}
                    <div class="fw-semibold">{{ contact.email }}</div>
                  {% else %}
                    <div class="text-secondary small">—</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "الرقم الضريبي / VAT" %}</div>
                  {% if contact.tax_number %}
                    <div class="fw-semibold">{{ contact.tax_number }}</div>
                  {% else %}
                    <div class="text-secondary small">—</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <div class="small text-muted mb-1">{% trans "الحالة" %}</div>
                  {% if contact.is_active %}
                    <span class="badge bg-success-subtle text-success-emphasis small">
                      {% trans "نشط" %}
                    </span>
                  {% else %}
                    <span class="badge bg-secondary-subtle text-secondary-emphasis small">
                      {% trans "غير نشط" %}
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>

            {# العنوان الرئيسي #}
            <div class="mb-3">
              <h2 class="h6 fw-semibold mb-3">
                {% trans "العنوان الرئيسي" %}
              </h2>

              {% with primary=contact.primary_address %}
                {% if primary %}

                  {% if primary.address %}
                    <p class="mb-2 small">
                      {{ primary.address|linebreaksbr }}
                    </p>
                  {% endif %}

                  <p class="text-secondary small mb-1">
                    {% if primary.village %}
                      {{ primary.village }}
                    {% endif %}
                    {% if primary.village and primary.wilaya %}, {% endif %}
                    {% if primary.wilaya %}
                      {{ primary.wilaya }}
                    {% endif %}
                    {% if primary.governorate %}
                      <br>{{ primary.governorate }}
                    {% endif %}
                    {% if primary.country %}
                      {% if primary.governorate %}, {% else %}<br>{% endif %}
                      {{ primary.country }}
                    {% endif %}
                  </p>

                  {% if primary.po_box or primary.postal_code %}
                    <p class="text-secondary small mb-0">
                      {% if primary.po_box %}
                        {% trans "ص.ب" %} {{ primary.po_box }}
                      {% endif %}
                      {% if primary.po_box and primary.postal_code %} · {% endif %}
                      {% if primary.postal_code %}
                        {% trans "الرمز البريدي" %} {{ primary.postal_code }}
                      {% endif %}
                    </p>
                  {% endif %}

                {% else %}
                  <p class="text-secondary small mb-0">
                    {% trans "لا يوجد عنوان رئيسي مسجل لهذه الجهة." %}
                  </p>
                {% endif %}
              {% endwith %}
            </div>

            {# العناوين الأخرى #}
            <div class="mb-0">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 fw-semibold mb-0">
                  {% trans "العناوين الأخرى" %}
                </h2>
                <a href="{% url 'contacts:contact_edit' contact.pk %}"
                   class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-pencil ms-1"></i>
                  {% trans "إدارة العناوين" %}
                </a>
              </div>

              {% if addresses %}
                <div class="vstack gap-2">
                  {% for addr in addresses %}
                    <div class="card border-0 shadow-sm">
                      <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                          <div>
                            <div class="small fw-semibold">
                              {{ addr.get_address_type_display }}
                            </div>
                          </div>
                          <div class="text-end">
                            {% if addr.is_primary %}
                              <span class="badge bg-dark-subtle text-dark-emphasis small mb-1 d-inline-block">
                                {% trans "رئيسي" %}
                              </span><br>
                            {% endif %}
                            {% if addr.is_active %}
                              <span class="badge bg-success-subtle text-success-emphasis small">
                                {% trans "نشط" %}
                              </span>
                            {% else %}
                              <span class="badge bg-secondary-subtle text-secondary-emphasis small">
                                {% trans "غير نشط" %}
                              </span>
                            {% endif %}
                          </div>
                        </div>

                        {% if addr.address %}
                          <div class="small mb-1">
                            {{ addr.address|linebreaksbr }}
                          </div>
                        {% endif %}

                        <p class="text-secondary small mb-0">
                          {% if addr.village %}
                            {{ addr.village }}
                          {% endif %}
                          {% if addr.village and addr.wilaya %}, {% endif %}
                          {% if addr.wilaya %}
                            {{ addr.wilaya }}
                          {% endif %}
                          {% if addr.governorate %}
                            <br>{{ addr.governorate }}
                          {% endif %}
                          {% if addr.country %}
                            {% if addr.governorate %}, {% else %}<br>{% endif %}
                            {{ addr.country }}
                          {% endif %}
                        </p>

                        {% if addr.po_box or addr.postal_code %}
                          <p class="text-secondary small mb-0 mt-1">
                            {% if addr.po_box %}
                              {% trans "ص.ب" %} {{ addr.po_box }}
                            {% endif %}
                            {% if addr.po_box and addr.postal_code %} · {% endif %}
                            {% if addr.postal_code %}
                              {% trans "الرمز البريدي" %} {{ addr.postal_code }}
                            {% endif %}
                          </p>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-secondary small mb-0">
                  {% trans "لا توجد عناوين إضافية مسجلة لهذه الجهة." %}
                </p>
              {% endif %}
            </div>

          </div>

          {# تبويب الدفعات #}
          <div class="tab-pane fade" id="tab-payments">

            <div class="border bg-body-tertiary rounded-3 px-3 py-2 mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div class="d-flex flex-wrap gap-2 small">
                <span class="badge rounded-pill bg-success-subtle text-success-emphasis px-3 py-2">
                  <span class="text-secondary">{% trans "إجمالي القبض" %}:</span>
                  <span class="fw-bold ms-1">{{ payments_total_in }}</span>
                </span>
                <span class="badge rounded-pill bg-danger-subtle text-danger-emphasis px-3 py-2">
                  <span class="text-secondary">{% trans "إجمالي الصرف" %}:</span>
                  <span class="fw-bold ms-1">{{ payments_total_out }}</span>
                </span>
              </div>

              <a href="{% url 'accounting:payment_create' %}?contact={{ contact.pk }}"
                 class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg ms-1"></i>
                {% trans "إضافة دفعة جديدة" %}
              </a>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0 small">
                <thead class="table-light">
                  <tr>
                    <th class="text-nowrap">{% trans "الرقم" %}</th>
                    <th class="text-nowrap">{% trans "النوع" %}</th>
                    <th class="text-end text-nowrap">{% trans "المبلغ" %}</th>
                    <th class="text-nowrap">{% trans "التاريخ" %}</th>
                    <th class="text-nowrap">{% trans "طريقة الدفع" %}</th>
                    <th class="text-nowrap">{% trans "مرجع" %}</th>
                    <th class="text-end"></th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in payments %}
                    <tr>
                      <td class="fw-semibold text-nowrap">
                        {{ p.number|default:"—" }}
                      </td>
                      <td>
                        {% if p.type == "in" or p.type == "incoming" or p.type == "customer_receipt" %}
                          <span class="badge bg-success-subtle text-success-emphasis">
                            {% trans "قبض" %}
                          </span>
                        {% else %}
                          <span class="badge bg-danger-subtle text-danger-emphasis">
                            {% trans "صرف" %}
                          </span>
                        {% endif %}
                      </td>
                      <td class="text-end text-nowrap">
                        <span class="fw-semibold">{{ p.amount }}</span>
                        <span class="text-secondary">{{ p.currency }}</span>
                      </td>
                      <td class="text-nowrap">{{ p.date }}</td>
                      <td class="text-nowrap">{{ p.method }}</td>
                      <td class="text-secondary text-truncate" style="max-width: 150px;">
                        {{ p.reference|default:"—" }}
                      </td>
                      <td class="text-end text-nowrap">
                        <a href="{% url 'accounting:payment_detail' p.pk %}"
                           class="btn btn-sm btn-light border">
                          {% trans "عرض" %}
                        </a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="7" class="text-center text-secondary py-3">
                        {% trans "لا توجد دفعات مسجلة لهذه الجهة." %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>

          {# تبويب الأشخاص المرتبطين (لو شركة) #}
          {% with people=contact.people.all %}
            {% if contact.is_company and people %}
              <div class="tab-pane fade" id="tab-people">
                <h2 class="h6 fw-semibold mb-3">
                  {% trans "الأشخاص المرتبطون بهذه الشركة" %}
                </h2>
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0 align-middle small">
                    <thead class="table-light">
                      <tr>
                        <th>{% trans "الاسم" %}</th>
                        <th>{% trans "الهاتف / البريد" %}</th>
                        <th>{% trans "الأدوار" %}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for person in people %}
                        <tr>
                          <td>
                            <a href="{% url 'contacts:contact_detail' person.pk %}"
                               class="link-body-emphasis text-decoration-none fw-semibold">
                              {{ person.name }}
                            </a>
                          </td>
                          <td>
                            {% if person.phone %}
                              <div>{{ person.phone }}</div>
                            {% endif %}
                            {% if person.email %}
                              <div class="text-secondary">{{ person.email }}</div>
                            {% endif %}
                            {% if not person.phone and not person.email %}
                              <span class="text-secondary">—</span>
                            {% endif %}
                          </td>
                          <td>
                            <div class="d-flex flex-wrap gap-1">
                              {% if person.is_customer %}
                                <span class="badge bg-dark-subtle text-dark-emphasis small">{% trans "زبون" %}</span>
                              {% endif %}
                              {% if person.is_supplier %}
                                <span class="badge bg-warning-subtle text-warning-emphasis small">{% trans "مورد / شريك" %}</span>
                              {% endif %}
                              {% if person.is_owner %}
                                <span class="badge bg-info-subtle text-info-emphasis small">{% trans "مالك" %}</span>
                              {% endif %}
                              {% if person.is_employee %}
                                <span class="badge bg-success-subtle text-success-emphasis small">{% trans "موظف" %}</span>
                              {% endif %}
                              {% if not person.is_customer and not person.is_supplier and not person.is_owner and not person.is_employee %}
                                <span class="text-secondary small">—</span>
                              {% endif %}
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            {% endif %}
          {% endwith %}

        </div>
      </div>
    </div>

  </div>

  <div class="col-lg-4">

    {# ملخص مالي #}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-3">
          {% trans "ملخص مالي" %}
        </h2>

        <div class="vstack gap-2">
          <div class="d-flex justify-content-between align-items-center">
            <span class="small text-muted">{% trans "إجمالي الفواتير" %}</span>
            <span class="fw-semibold">{{ total_invoiced }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small text-muted">{% trans "إجمالي المدفوع" %}</span>
            <span class="fw-semibold">{{ total_paid }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small text-muted">{% trans "الرصيد" %}</span>
            <span class="fw-semibold">{{ balance }}</span>
          </div>
        </div>

        <p class="text-secondary small mt-2 mb-0">
          {% trans "يتم احتساب هذه الأرقام من الفواتير والمدفوعات المرتبطة بهذه الجهة." %}
        </p>
      </div>
    </div>

    {# معلومات إضافية #}
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-3">
          {% trans "معلومات إضافية" %}
        </h2>
        <dl class="row mb-0 small">
          <dt class="col-5 text-muted mb-1">{% trans "رقم التعريف" %}</dt>
          <dd class="col-7 mb-1">{{ contact.pk }}</dd>

          <dt class="col-5 text-muted mb-1">{% trans "تاريخ الإنشاء" %}</dt>
          <dd class="col-7 mb-1">
            {{ contact.created_at|date:"Y-m-d H:i" }}
          </dd>
        </dl>
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% extends "base.html" %}
{% load i18n %}

{% block title %}
  {% if object %}
    {% trans "تعديل جهة اتصال" %} – {{ object.name }}
  {% else %}
    {% trans "إضافة جهة اتصال جديدة" %}
  {% endif %}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-9">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h4 fw-bold mb-1">
          {% if object %}
            {% trans "تعديل جهة اتصال" %}
          {% else %}
            {% trans "إضافة جهة اتصال جديدة" %}
          {% endif %}
        </h1>
        <p class="text-muted small mb-0">
          {% trans "تعبئة بيانات جهة الاتصال العامة والعناوين المرتبطة بها." %}
        </p>
      </div>
    </div>

    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger small">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      {# 1) البيانات الأساسية #}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h6 fw-semibold mb-3">{% trans "البيانات الأساسية" %}</h2>

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label small mb-1" for="{{ form.kind.id_for_label }}">
                {{ form.kind.label }}
              </label>
              {{ form.kind }}
              {{ form.kind.errors }}
            </div>

            <div class="col-md-9">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="{{ form.name_ar.id_for_label }}">
                    {{ form.name_ar.label }}
                  </label>
                  {{ form.name_ar }}
                  {{ form.name_ar.errors }}
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="{{ form.name_en.id_for_label }}">
                    {{ form.name_en.label }}
                  </label>
                  {{ form.name_en }}
                  {{ form.name_en.errors }}
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.company_name_ar.id_for_label }}">
                {{ form.company_name_ar.label }}
              </label>
              {{ form.company_name_ar }}
              {{ form.company_name_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.company_name_en.id_for_label }}">
                {{ form.company_name_en.label }}
              </label>
              {{ form.company_name_en }}
              {{ form.company_name_en.errors }}
            </div>

            <div class="col-md-4">
              <label class="form-label small mb-1" for="{{ form.phone.id_for_label }}">
                {{ form.phone.label }}
              </label>
              {{ form.phone }}
              {{ form.phone.errors }}
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1" for="{{ form.email.id_for_label }}">
                {{ form.email.label }}
              </label>
              {{ form.email }}
              {{ form.email.errors }}
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1" for="{{ form.tax_number.id_for_label }}">
                {{ form.tax_number.label }}
              </label>
              {{ form.tax_number }}
              {{ form.tax_number.errors }}
            </div>
          </div>
        </div>
      </div>

      {# 2) العنوان الرئيسي #}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h6 fw-semibold mb-3">{% trans "العنوان الرئيسي" %}</h2>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.address_ar.id_for_label }}">
                {{ form.address_ar.label }}
              </label>
              {{ form.address_ar }}
              {{ form.address_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.address_en.id_for_label }}">
                {{ form.address_en.label }}
              </label>
              {{ form.address_en }}
              {{ form.address_en.errors }}
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.country_ar.id_for_label }}">
                {{ form.country_ar.label }}
              </label>
              {{ form.country_ar }}
              {{ form.country_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.country_en.id_for_label }}">
                {{ form.country_en.label }}
              </label>
              {{ form.country_en }}
              {{ form.country_en.errors }}
            </div>

            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.governorate_ar.id_for_label }}">
                {{ form.governorate_ar.label }}
              </label>
              {{ form.governorate_ar }}
              {{ form.governorate_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.governorate_en.id_for_label }}">
                {{ form.governorate_en.label }}
              </label>
              {{ form.governorate_en }}
              {{ form.governorate_en.errors }}
            </div>

            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.wilaya_ar.id_for_label }}">
                {{ form.wilaya_ar.label }}
              </label>
              {{ form.wilaya_ar }}
              {{ form.wilaya_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.wilaya_en.id_for_label }}">
                {{ form.wilaya_en.label }}
              </label>
              {{ form.wilaya_en }}
              {{ form.wilaya_en.errors }}
            </div>

            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.village_ar.id_for_label }}">
                {{ form.village_ar.label }}
              </label>
              {{ form.village_ar }}
              {{ form.village_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.village_en.id_for_label }}">
                {{ form.village_en.label }}
              </label>
              {{ form.village_en }}
              {{ form.village_en.errors }}
            </div>

            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.postal_code_ar.id_for_label }}">
                {{ form.postal_code_ar.label }}
              </label>
              {{ form.postal_code_ar }}
              {{ form.postal_code_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.postal_code_en.id_for_label }}">
                {{ form.postal_code_en.label }}
              </label>
              {{ form.postal_code_en }}
              {{ form.postal_code_en.errors }}
            </div>

            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.po_box_ar.id_for_label }}">
                {{ form.po_box_ar.label }}
              </label>
              {{ form.po_box_ar }}
              {{ form.po_box_ar.errors }}
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1" for="{{ form.po_box_en.id_for_label }}">
                {{ form.po_box_en.label }}
              </label>
              {{ form.po_box_en }}
              {{ form.po_box_en.errors }}
            </div>
          </div>
        </div>
      </div>

      {# 3) الأدوار والحالة #}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h6 fw-semibold mb-3">{% trans "الأدوار والحالة" %}</h2>

          <div class="row g-3">
            <div class="col-md-8">
              <div class="form-check form-check-inline">
                {{ form.is_customer }}
                <label class="form-check-label ms-1" for="{{ form.is_customer.id_for_label }}">
                  {{ form.is_customer.label }}
                </label>
                {{ form.is_customer.errors }}
              </div>
              <div class="form-check form-check-inline">
                {{ form.is_supplier }}
                <label class="form-check-label ms-1" for="{{ form.is_supplier.id_for_label }}">
                  {{ form.is_supplier.label }}
                </label>
                {{ form.is_supplier.errors }}
              </div>
              <div class="form-check form-check-inline">
                {{ form.is_owner }}
                <label class="form-check-label ms-1" for="{{ form.is_owner.id_for_label }}">
                  {{ form.is_owner.label }}
                </label>
                {{ form.is_owner.errors }}
              </div>
              <div class="form-check form-check-inline">
                {{ form.is_employee }}
                <label class="form-check-label ms-1" for="{{ form.is_employee.id_for_label }}">
                  {{ form.is_employee.label }}
                </label>
                {{ form.is_employee.errors }}
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-md-end">
              <div class="form-check">
                {{ form.is_active }}
                <label class="form-check-label ms-1" for="{{ form.is_active.id_for_label }}">
                  {{ form.is_active.label }}
                </label>
                {{ form.is_active.errors }}
              </div>
            </div>
          </div>
        </div>
      </div>

      {# 4) العناوين الإضافية (formset) #}
      {% if address_formset %}
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <h2 class="h6 fw-semibold mb-3">{% trans "العناوين الإضافية" %}</h2>
            <p class="text-muted small mb-3">
              {% trans "استخدم هذه العناوين للفوترة، الشحن، أو مواقع المشاريع والورش." %}
            </p>

            {{ address_formset.management_form }}
            {% for addr_form in address_formset %}
              {% if addr_form.non_field_errors %}
                <div class="alert alert-danger small">
                  {{ addr_form.non_field_errors }}
                </div>
              {% endif %}

              <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body">
                  {% for hidden in addr_form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}

                  <div class="row g-3 align-items-start">
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.label_ar.id_for_label }}">
                        {{ addr_form.label_ar.label }}
                      </label>
                      {{ addr_form.label_ar }}
                      {{ addr_form.label_ar.errors }}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.label_en.id_for_label }}">
                        {{ addr_form.label_en.label }}
                      </label>
                      {{ addr_form.label_en }}
                      {{ addr_form.label_en.errors }}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.address_type.id_for_label }}">
                        {{ addr_form.address_type.label }}
                      </label>
                      {{ addr_form.address_type }}
                      {{ addr_form.address_type.errors }}
                    </div>

                    <div class="col-md-6">
                      <label class="form-label small mb-1" for="{{ addr_form.address_ar.id_for_label }}">
                        {{ addr_form.address_ar.label }}
                      </label>
                      {{ addr_form.address_ar }}
                      {{ addr_form.address_ar.errors }}
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small mb-1" for="{{ addr_form.address_en.id_for_label }}">
                        {{ addr_form.address_en.label }}
                      </label>
                      {{ addr_form.address_en }}
                      {{ addr_form.address_en.errors }}
                    </div>

                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.country.id_for_label }}">
                        {{ addr_form.country.label }}
                      </label>
                      {{ addr_form.country }}
                      {{ addr_form.country.errors }}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.governorate.id_for_label }}">
                        {{ addr_form.governorate.label }}
                      </label>
                      {{ addr_form.governorate }}
                      {{ addr_form.governorate.errors }}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.wilaya.id_for_label }}">
                        {{ addr_form.wilaya.label }}
                      </label>
                      {{ addr_form.wilaya }}
                      {{ addr_form.wilaya.errors }}
                    </div>

                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.village.id_for_label }}">
                        {{ addr_form.village.label }}
                      </label>
                      {{ addr_form.village }}
                      {{ addr_form.village.errors }}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.postal_code.id_for_label }}">
                        {{ addr_form.postal_code.label }}
                      </label>
                      {{ addr_form.postal_code }}
                      {{ addr_form.postal_code.errors }}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="{{ addr_form.po_box.id_for_label }}">
                        {{ addr_form.po_box.label }}
                      </label>
                      {{ addr_form.po_box }}
                      {{ addr_form.po_box.errors }}
                    </div>

                    <div class="col-md-12 mt-1">
                      <div class="d-flex flex-wrap gap-3 align-items-center">
                        <div class="form-check">
                          {{ addr_form.is_primary }}
                          <label class="form-check-label ms-1" for="{{ addr_form.is_primary.id_for_label }}">
                            {{ addr_form.is_primary.label }}
                          </label>
                          {{ addr_form.is_primary.errors }}
                        </div>
                        <div class="form-check">
                          {{ addr_form.is_active }}
                          <label class="form-check-label ms-1" for="{{ addr_form.is_active.id_for_label }}">
                            {{ addr_form.is_active.label }}
                          </label>
                          {{ addr_form.is_active.errors }}
                        </div>

                        {% if address_formset.can_delete %}
                          <div class="form-check text-danger">
                            {{ addr_form.DELETE }}
                            <label class="form-check-label ms-1" for="{{ addr_form.DELETE.id_for_label }}">
                              {% trans "حذف هذا العنوان" %}
                            </label>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}

            <p class="text-muted small mb-0">
              {% trans "يمكنك إضافة المزيد من العناوين بحفظ البيانات ثم العودة للتعديل." %}
            </p>
          </div>
        </div>
      {% endif %}

      <div class="d-flex justify-content-between align-items-center mt-3">
        <a href="{% url 'contacts:contact_list' %}" class="btn btn-outline-secondary">
          {% trans "إلغاء" %}
        </a>
        <button type="submit" class="btn btn-dark">
          {% if object %}
            {% trans "حفظ التعديلات" %}
          {% else %}
            {% trans "حفظ جهة الاتصال" %}
          {% endif %}
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

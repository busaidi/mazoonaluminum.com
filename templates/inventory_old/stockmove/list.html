{% extends "inventory/base_inventory.html" %}
{% load i18n %}

{% block title %}{% trans "حركات المخزون" %}{% endblock %}

{% block inventory_content %}

{# ───── الهيدر + CTA ───── #}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body d-flex justify-content-between align-items-center gap-3">
    <div>
      <h1 class="h5 fw-bold mb-1">
        {% trans "حركات المخزون" %}
      </h1>
      <p class="text-muted small mb-0">
        {% trans "عرض جميع عمليات الإدخال والإخراج والتحويل بين المخازن والمواقع مع ملخص سريع للبنود." %}
      </p>
    </div>

    <div class="d-flex flex-wrap gap-2 align-items-center">

      {% if page_obj %}
        <span class="badge bg-light text-muted border small">
          {% blocktrans with count=page_obj.paginator.count %}
            {{ count }} حركة في النظام
          {% endblocktrans %}
        </span>
      {% endif %}

      {# شارة النوع لو محدد #}
      {% if request.GET.move_type %}
        <span class="badge bg-primary-subtle text-primary border small">
          {% if request.GET.move_type == "in" %}
            {% trans "فلتر: حركات الإدخال" %}
          {% elif request.GET.move_type == "out" %}
            {% trans "فلتر: حركات الإخراج" %}
          {% elif request.GET.move_type == "transfer" %}
            {% trans "فلتر: حركات التحويل" %}
          {% endif %}
        </span>
      {% endif %}

      {# شارة المخزن لو محدد #}
      {% if request.GET.warehouse %}
        <span class="badge bg-info-subtle text-info border small">
          {% trans "فلتر حسب مخزن محدد" %}
        </span>
      {% endif %}

      <a href="{% url 'inventory:move_create' %}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-lg ms-1"></i>
        {% trans "حركة جديدة" %}
      </a>
    </div>
  </div>
</div>

{# ───── البحث والفلاتر ───── #}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-center">

      <div class="col-md-4">
        <input type="text"
               name="q"
               class="form-control form-control-sm"
               value="{{ request.GET.q }}"
               placeholder="{% trans 'بحث بالمنتج أو المرجع أو رقم الحركة...' %}">
      </div>

      <div class="col-md-3">
        <select name="warehouse" class="form-select form-select-sm">
          <option value="">{% trans "كل المخازن" %}</option>
          {% for w in warehouses %}
            <option value="{{ w.id }}" {% if request.GET.warehouse == w.id|stringformat:"s" %}selected{% endif %}>
              {{ w.code }} — {{ w.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select name="move_type" class="form-select form-select-sm">
          <option value="">{% trans "كل الأنواع" %}</option>
          <option value="in"       {% if request.GET.move_type == "in"       %}selected{% endif %}>{% trans "إدخال" %}</option>
          <option value="out"      {% if request.GET.move_type == "out"      %}selected{% endif %}>{% trans "إخراج" %}</option>
          <option value="transfer" {% if request.GET.move_type == "transfer" %}selected{% endif %}>{% trans "تحويل" %}</option>
        </select>
      </div>

      <div class="col-md-2 d-flex justify-content-end gap-2">
        <button class="btn btn-outline-primary btn-sm flex-grow-1">
          <i class="bi bi-filter ms-1"></i>
          {% trans "تطبيق" %}
        </button>

        {% if request.GET.q or request.GET.warehouse or request.GET.move_type %}
          <a href="{% url 'inventory:move_list' %}"
             class="btn btn-link btn-sm text-decoration-none">
            <i class="bi bi-x-circle ms-1"></i>
            {% trans "إعادة تعيين" %}
          </a>
        {% endif %}
      </div>

    </form>
  </div>
</div>

{# ───── نتائج الحركات ───── #}
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0 table-sm">
      <thead class="table-light">
        <tr>
          <th style="width: 8%;">{% trans "التاريخ" %}</th>
          <th style="width: 13%;">{% trans "رقم الحركة" %}</th>
          <th style="width: 27%;">{% trans "ملخص البنود" %}</th>
          <th class="text-end" style="width: 8%;">{% trans "إجمالي الكمية" %}</th>
          <th style="width: 12%;">{% trans "من" %}</th>
          <th style="width: 12%;">{% trans "إلى" %}</th>
          <th style="width: 8%;">{% trans "الحالة" %}</th>
          <th style="width: 8%;">{% trans "النوع" %}</th>
          <th style="width: 14%;" class="text-center">{% trans "إجراءات" %}</th>
        </tr>
      </thead>

      <tbody>
        {% for move in object_list %}
          <tr>
            {# التاريخ #}
            <td class="small text-muted">
              {{ move.move_date|date:"Y-m-d" }}
            </td>

            {# رقم الحركة #}
            <td class="small">
              <a href="{% url 'inventory:move_detail' move.pk %}"
                 class="fw-semibold text-decoration-none" dir="ltr">
                {{ move.serial|default:move.pk }}
              </a>
              {% if move.reference %}
                <div class="text-muted small">
                  {{ move.reference }}
                </div>
              {% endif %}
            </td>

            {# ملخص البنود: عدد البنود + أول منتج #}
            <td class="small">
              {% with lines_count=move.lines.count %}
                {% if lines_count %}
                  {% blocktrans count cnt=lines_count %}
                    {{ cnt }} بند
                  {% plural %}
                    {{ cnt }} بنود
                  {% endblocktrans %}
                  {% with first_line=move.lines.first %}
                    {% if first_line %}
                      <div class="text-muted small">
                        {{ first_line.product.code }} – {{ first_line.product.name }}
                      </div>
                    {% endif %}
                  {% endwith %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              {% endwith %}
            </td>

            {# إجمالي الكمية #}
            <td class="text-end fw-semibold small">
              {{ move.total_lines_quantity }}
            </td>

            {# من مخزن #}
            <td class="small">
              {% if move.from_warehouse %}
                <span class="fw-semibold">{{ move.from_warehouse.code }}</span>
                <div class="text-muted small">
                  {{ move.from_warehouse.name }}
                </div>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>

            {# إلى مخزن #}
            <td class="small">
              {% if move.to_warehouse %}
                <span class="fw-semibold">{{ move.to_warehouse.code }}</span>
                <div class="text-muted small">
                  {{ move.to_warehouse.name }}
                </div>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>

            {# الحالة #}
            <td class="small">
              {% if move.status == "draft" %}
                <span class="badge bg-secondary-subtle text-secondary border">
                  {% trans "مسودة" %}
                </span>
              {% elif move.status == "done" %}
                <span class="badge bg-success-subtle text-success border">
                  {% trans "منفذة" %}
                </span>
              {% elif move.status == "cancelled" %}
                <span class="badge bg-danger-subtle text-danger border">
                  {% trans "ملغاة" %}
                </span>
              {% else %}
                <span class="badge bg-light text-muted border">
                  {{ move.get_status_display }}
                </span>
              {% endif %}
            </td>

            {# النوع #}
            <td class="small">
              {% if move.move_type == "in" %}
                <span class="badge bg-success-subtle text-success border">
                  {% trans "إدخال" %}
                </span>
              {% elif move.move_type == "out" %}
                <span class="badge bg-danger-subtle text-danger border">
                  {% trans "إخراج" %}
                </span>
              {% elif move.move_type == "transfer" %}
                <span class="badge bg-info-subtle text-info border">
                  {% trans "تحويل" %}
                </span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary border">
                  {{ move.get_move_type_display }}
                </span>
              {% endif %}
            </td>

            {# الإجراءات #}
            <td class="small text-center">
              <div class="btn-group btn-group-sm" role="group">

                {# عرض دائماً #}
                <a href="{% url 'inventory:move_detail' move.pk %}"
                   class="btn btn-outline-secondary"
                   title="{% trans 'عرض' %}">
                  <i class="bi bi-eye"></i>
                </a>

                {# تعديل / تأكيد / إلغاء فقط إذا مسودة ومعك صلاحية التعديل #}
                {% if perms.inventory.change_stockmove and move.status == "draft" %}
                  <a href="{% url 'inventory:move_update' move.pk %}"
                     class="btn btn-outline-primary"
                     title="{% trans 'تعديل' %}">
                    <i class="bi bi-pencil-square"></i>
                  </a>

                  <a href="{% url 'inventory:move_confirm' move.pk %}"
                     class="btn btn-success"
                     title="{% trans 'تأكيد' %}"
                     onclick="return confirm('{% trans 'هل تريد تأكيد هذه الحركة؟ سيتم تحديث الأرصدة.' %}');">
                    <i class="bi bi-check2"></i>
                  </a>

                  <a href="{% url 'inventory:move_cancel' move.pk %}"
                     class="btn btn-outline-danger"
                     title="{% trans 'إلغاء' %}"
                     onclick="return confirm('{% trans 'هل أنت متأكد من إلغاء هذه الحركة؟' %}');">
                    <i class="bi bi-x"></i>
                  </a>
                {% endif %}
              </div>
            </td>
          </tr>

        {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted py-4">
              {% trans "لا توجد حركات مسجلة." %}
            </td>
          </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>

  {% if is_paginated %}
    <div class="card-footer border-0">
      {% include "includes/_pagination.html" %}
    </div>
  {% endif %}
</div>

{% endblock %}

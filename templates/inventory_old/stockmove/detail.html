{# templates/inventory/stockmove/detail.html #}
{% extends "inventory/base_inventory.html" %}
{% load i18n %}

{% block title %}{% trans "تفاصيل حركة مخزون" %}{% endblock %}

{% block inventory_content %}

{# ========== هيدر حركة المخزون ========== #}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body d-flex justify-content-between align-items-start flex-wrap gap-3">

    <div class="flex-grow-1">
      <div class="d-flex align-items-center gap-2 mb-1">
        <h1 class="h5 fw-bold mb-0">
          {% trans "حركة مخزون" %}
        </h1>
        <span class="badge bg-light text-muted border small" dir="ltr">
          {{ stockmove.serial|default:stockmove.pk }}
        </span>
      </div>

      <p class="text-muted small mb-0">
        {% trans "عرض تفاصيل الحركة المسجلة على المخازن والمواقع مع جميع البنود المرتبطة بها." %}
      </p>
    </div>

    <div class="d-flex flex-column align-items-end gap-2">

      {# نوع الحركة + الحالة #}
      <div class="d-flex flex-wrap gap-1 justify-content-end">

        {# نوع الحركة #}
        {% if stockmove.move_type == "in" %}
          <span class="badge bg-success-subtle text-success border small">
            {% trans "إدخال" %}
          </span>
        {% elif stockmove.move_type == "out" %}
          <span class="badge bg-danger-subtle text-danger border small">
            {% trans "إخراج" %}
          </span>
        {% elif stockmove.move_type == "transfer" %}
          <span class="badge bg-info-subtle text-info border small">
            {% trans "تحويل" %}
          </span>
        {% else %}
          <span class="badge bg-secondary-subtle text-secondary border small">
            {{ stockmove.get_move_type_display|default:stockmove.move_type }}
          </span>
        {% endif %}

        {# حالة الحركة #}
        {% if stockmove.status == "draft" %}
          <span class="badge bg-secondary-subtle text-secondary border small">
            {% trans "مسودة" %}
          </span>
        {% elif stockmove.status == "done" %}
          <span class="badge bg-success-subtle text-success border small">
            {% trans "منفذة" %}
          </span>
        {% elif stockmove.status == "cancelled" %}
          <span class="badge bg-danger-subtle text-danger border small">
            {% trans "ملغاة" %}
          </span>
        {% else %}
          <span class="badge bg-light text-muted border small">
            {{ stockmove.get_status_display }}
          </span>
        {% endif %}
      </div>

      {# أزرار الإجراءات: تأكيد / إلغاء / تعديل / رجوع #}
      <div class="d-flex flex-wrap gap-2 justify-content-end">

        {% if stockmove.status == "draft" %}
          <form method="post"
                action="{% url 'inventory:move_confirm' stockmove.pk %}"
                class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-success btn-sm">
              <i class="bi bi-check2-circle ms-1"></i>
              {% trans "تأكيد الحركة" %}
            </button>
          </form>

          <form method="post"
                action="{% url 'inventory:move_cancel' stockmove.pk %}"
                class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-x-circle ms-1"></i>
              {% trans "إلغاء" %}
            </button>
          </form>
        {% endif %}

        <div class="btn-group btn-group-sm" role="group">
          {% if stockmove.status == "draft" %}
            <a href="{% url 'inventory:move_update' stockmove.pk %}"
               class="btn btn-outline-primary">
              <i class="bi bi-pencil-square ms-1"></i>
              {% trans "تعديل" %}
            </a>
          {% endif %}
          <a href="{% url 'inventory:move_list' %}"
             class="btn btn-outline-secondary">
            <i class="bi bi-arrow-right-short ms-1"></i>
            {% trans "رجوع" %}
          </a>
        </div>

      </div>

    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">

    {# بطاقة معلومات الحركة #}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 fw-bold mb-3">
          <i class="bi bi-info-circle ms-1"></i>
          {% trans "بيانات الحركة" %}
        </h2>

        <dl class="row mb-0 small">

          <dt class="col-sm-3">{% trans "رقم الحركة" %}</dt>
          <dd class="col-sm-9" dir="ltr">
            {{ stockmove.serial|default:stockmove.pk }}
          </dd>

          <dt class="col-sm-3">{% trans "نوع الحركة" %}</dt>
          <dd class="col-sm-9">
            {% if stockmove.move_type == "in" %}
              {% trans "إدخال" %}
            {% elif stockmove.move_type == "out" %}
              {% trans "إخراج" %}
            {% elif stockmove.move_type == "transfer" %}
              {% trans "تحويل" %}
            {% else %}
              {{ stockmove.get_move_type_display|default:stockmove.move_type }}
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "الحالة" %}</dt>
          <dd class="col-sm-9">
            {% if stockmove.status == "draft" %}
              <span class="badge bg-secondary-subtle text-secondary border">
                {% trans "مسودة" %}
              </span>
            {% elif stockmove.status == "done" %}
              <span class="badge bg-success-subtle text-success border">
                {% trans "منفذة" %}
              </span>
            {% elif stockmove.status == "cancelled" %}
              <span class="badge bg-danger-subtle text-danger border">
                {% trans "ملغاة" %}
              </span>
            {% else %}
              <span class="badge bg-light text-muted border">
                {{ stockmove.get_status_display }}
              </span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "من مخزن" %}</dt>
          <dd class="col-sm-9">
            {% if stockmove.from_warehouse %}
              <span class="fw-semibold">{{ stockmove.from_warehouse.code }}</span>
              <span class="text-muted small d-block">{{ stockmove.from_warehouse.name }}</span>
              {% if stockmove.from_location %}
                <div class="text-muted small">
                  {{ stockmove.from_location.code }} – {{ stockmove.from_location.name }}
                </div>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "إلى مخزن" %}</dt>
          <dd class="col-sm-9">
            {% if stockmove.to_warehouse %}
              <span class="fw-semibold">{{ stockmove.to_warehouse.code }}</span>
              <span class="text-muted small d-block">{{ stockmove.to_warehouse.name }}</span>
              {% if stockmove.to_location %}
                <div class="text-muted small">
                  {{ stockmove.to_location.code }} – {{ stockmove.to_location.name }}
                </div>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "تاريخ الحركة" %}</dt>
          <dd class="col-sm-9">
            {{ stockmove.move_date|date:"Y-m-d H:i" }}
          </dd>

          <dt class="col-sm-3">{% trans "المرجع" %}</dt>
          <dd class="col-sm-9">
            {{ stockmove.reference|default:"-" }}
          </dd>

          <dt class="col-sm-3">{% trans "ملاحظات" %}</dt>
          <dd class="col-sm-9">
            {{ stockmove.note|default:"-"|linebreaksbr }}
          </dd>

          <dt class="col-sm-3">{% trans "إجمالي الكمية" %}</dt>
          <dd class="col-sm-9 fw-semibold">
            {{ stockmove.total_lines_quantity }}
          </dd>

        </dl>
      </div>
    </div>

    {# بطاقة بنود الحركة #}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-light border-0 py-2">
        <h2 class="h6 fw-bold mb-0">
          {% trans "بنود الحركة" %}
        </h2>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>{% trans "المنتج" %}</th>
                <th class="text-end">{% trans "الكمية" %}</th>
                <th>{% trans "وحدة القياس" %}</th>
                <th>{% trans "ملاحظات البند" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for line in lines %}
                <tr>
                  <td class="small">
                    {{ line.product.code }} – {{ line.product.name }}
                  </td>
                  <td class="text-end fw-semibold small">
                    {{ line.quantity }}
                  </td>
                  <td class="small">
                    {% if line.uom %}
                      {{ line.uom.code }} – {{ line.uom.name }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="small">
                    {{ line.note|default:"-"|linebreaksbr }}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-3 small">
                    {% trans "لا توجد بنود مسجلة لهذه الحركة." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {# بطاقة الارتباطات (للاستخدام لاحقاً) #}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-light border-0 py-2">
        <h2 class="h6 fw-bold mb-0 d-flex align-items-center gap-2">
          <i class="bi bi-link-45deg ms-1"></i>
          <span>{% trans "الارتباطات" %}</span>
        </h2>
      </div>
      <div class="card-body small text-muted">
        <p class="mb-2">
          {% trans "في الإصدارات القادمة يمكن ربط حركة المخزون هذه مع فواتير البيع والشراء، أوامر الشراء/البيع، والإرجاعات." %}
        </p>
        <ul class="mb-0 ps-3">
          <li>{% trans "ربط الحركة بفواتير المبيعات لتحديث المخزون والقيود المحاسبية." %}</li>
          <li>{% trans "ربط الحركة بأوامر الشراء لتتبع الاستلام من الموردين." %}</li>
          <li>{% trans "إتاحة التتبع العكسي من المستند المحاسبي إلى حركة المخزون والعكس." %}</li>
        </ul>
      </div>
    </div>

  </div>

  {# العمود الجانبي: معلومات زمنية #}
  <div class="col-lg-4">
    <aside class="position-sticky" style="top: 80px;">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body small text-muted">
          <h2 class="h6 fw-bold mb-2">
            <i class="bi bi-clock-history ms-1"></i>
            {% trans "معلومات سجلّية" %}
          </h2>
          <p class="mb-1">
            <strong>{% trans "تاريخ الإنشاء" %}:</strong>
            {{ stockmove.created_at|date:"Y-m-d H:i" }}
          </p>
          <p class="mb-0">
            <strong>{% trans "آخر تحديث" %}:</strong>
            {{ stockmove.updated_at|date:"Y-m-d H:i" }}
          </p>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-body small text-muted">
          <h2 class="h6 fw-bold mb-2">
            <i class="bi bi-info-circle ms-1"></i>
            {% trans "ملاحظة" %}</h2>
          <p class="mb-0">
            {% trans "يمكن لاحقاً ربط هذه الحركات مع أوامر الشراء، أوامر البيع، والإرجاعات لتحديث المخزون والقيود المحاسبية تلقائياً." %}
          </p>
        </div>
      </div>
    </aside>
  </div>
</div>

{% endblock %}

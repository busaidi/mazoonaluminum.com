{% extends "base.html" %}
{% load i18n %}

{% block meta_title %}
  {% trans "الزبائن | مزون ألمنيوم" %}
{% endblock %}

{% block meta_description %}
  {% trans "قائمة الزبائن مع إمكانية البحث وإدارة بيانات العملاء في نظام المحاسبة." %}
{% endblock %}

{% block content %}
<div class="py-4">
  {# شريط تنقّل المحاسبة #}
  {% include "accounting/_nav.html" %}

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h1 class="h4 mb-0 text-mazoon">
      {% trans "الزبائن" %}
    </h1>
    <a href="{% url 'accounting:customer_create' %}" class="btn btn-primary btn-sm">
      {% trans "+ زبون جديد" %}
    </a>
  </div>

  {# ===================== البحث مع أوتوكمبليت ===================== #}
  <form method="get" class="row g-2 mb-3 align-items-center position-relative" autocomplete="off">
    <div class="col-auto position-relative">
      <input type="text"
             id="customer-search-input"
             name="q"
             class="form-control form-control-sm"
             placeholder="{% trans 'بحث بالاسم أو الشركة أو الهاتف أو البريد' %}"
             value="{{ request.GET.q|default:'' }}">

      {# صندوق الاقتراحات #}
      <div id="customer-autocomplete"
           class="list-group shadow-sm position-absolute w-100 d-none"
           style="z-index: 1050; max-height: 260px; overflow-y: auto; top: 100%; right: 0;">
        {# العناصر تضاف بالـ JS #}
      </div>
    </div>

    <div class="col-auto">
      <button type="submit" class="btn btn-outline-secondary btn-sm">
        {% trans "بحث" %}
      </button>
    </div>
  </form>

  <div class="card border-0 shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover table-sm mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>{% trans "العميل" %}</th>
            <th>{% trans "الموقع" %}</th>
            <th class="text-end">{% trans "الرصيد" %}</th>
            <th class="text-end"></th>
          </tr>
        </thead>
        <tbody>
          {% for c in customers %}
            <tr>
              {# ===================== عمود العميل مع بيانات مكدّسة ===================== #}
              <td>
                <div class="fw-semibold mb-1">
                  <a href="{% url 'accounting:customer_detail' pk=c.pk %}">
                    {{ c.name }}
                  </a>
                </div>

                {# الهاتف + البريد في سطر واحد muted #}
                <div class="small text-muted">
                  {% if c.phone %}
                    {{ c.phone }}
                  {% endif %}
                  {% if c.email %}
                    {% if c.phone %} · {% endif %}
                    {{ c.email }}
                  {% endif %}
                </div>

                {# الشركة + الرقم الضريبي في سطر آخر muted #}
                <div class="small text-muted">
                  {% if c.company_name %}
                    {{ c.company_name }}
                  {% endif %}
                  {% if c.tax_number %}
                    {% if c.company_name %} · {% endif %}
                    {% trans "الرقم الضريبي" %}: {{ c.tax_number }}
                  {% endif %}
                </div>
              </td>

              {# ===================== الموقع ===================== #}
              <td class="small text-muted">
                {% if c.country %}{{ c.country }}{% else %}-{% endif %}
                {% if c.governorate %} · {{ c.governorate }}{% endif %}
                {% if c.wilaya %} · {{ c.wilaya }}{% endif %}
              </td>

              {# ===================== الرصيد ===================== #}
              <td class="text-end">
                <span class="fw-semibold
                             {% if c.balance > 0 %}text-danger
                             {% elif c.balance < 0 %}text-success
                             {% endif %}">
                  {{ c.balance }}
                </span>
              </td>

              {# ===================== الإجراءات ===================== #}
              <td class="text-end">
                <a href="{% url 'accounting:customer_edit' pk=c.pk %}"
                   class="btn btn-sm btn-outline-primary">
                  {% trans "تعديل" %}
                </a>
                <a href="{% url 'accounting:customer_delete' pk=c.pk %}"
                   class="btn btn-sm btn-outline-danger">
                  {% trans "حذف" %}
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted py-3">
                {% trans "لا يوجد زبائن حاليًا." %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Pagination #}
    {% if is_paginated %}
      <div class="card-footer bg-body-tertiary">
        <nav aria-label="{% trans 'صفحات الزبائن' %}">
          <ul class="pagination justify-content-center mb-0">

            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                  {% trans "السابق" %}
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">
                  {% trans "السابق" %}
                </span>
              </li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">
                {% blocktrans with number=page_obj.number total=page_obj.paginator.num_pages %}
                  صفحة {{ number }} من {{ total }}
                {% endblocktrans %}
              </span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                  {% trans "التالي" %}
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">
                  {% trans "التالي" %}
                </span>
              </li>
            {% endif %}

          </ul>
        </nav>
      </div>
    {% endif %}

  </div>

</div>

{# ======================== JS للأوتوكمبليت ======================== #}
<script>
  (function() {
    const input = document.getElementById("customer-search-input");
    const box = document.getElementById("customer-autocomplete");
    if (!input || !box) return;

    let debounceTimer = null;

    function hideBox() {
      box.classList.add("d-none");
      box.innerHTML = "";
    }

    function showBox() {
      box.classList.remove("d-none");
    }

    function renderSuggestions(items) {
      if (!items.length) {
        hideBox();
        return;
      }

      box.innerHTML = "";
      items.forEach(function(item) {
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action small text-start";

        // نص السطر: الاسم + (الشركة) + الهاتف/البريد
        let line = item.name || "";
        if (item.company_name) {
          line += " — " + item.company_name;
        }
        if (item.phone) {
          line += " · " + item.phone;
        } else if (item.email) {
          line += " · " + item.email;
        }

        a.textContent = line;

        a.addEventListener("click", function() {
          input.value = item.name || item.company_name || item.phone || item.email || "";
          hideBox();
          // ممكن هنا نرسل الفورم مباشرة:
          input.form && input.form.submit();
        });

        box.appendChild(a);
      });

      showBox();
    }

    function fetchSuggestions(query) {
      if (!query || query.length < 2) {
        hideBox();
        return;
      }

      const url = "{% url 'accounting:customer_autocomplete' %}" + "?q=" + encodeURIComponent(query);

      fetch(url, {
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
        .then(function(response) {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.json();
        })
        .then(function(data) {
          renderSuggestions(data.results || []);
        })
        .catch(function(error) {
          console.error("Autocomplete error:", error);
          hideBox();
        });
    }

    input.addEventListener("input", function() {
      const query = input.value.trim();
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function() {
        fetchSuggestions(query);
      }, 250); // debounce 250ms
    });

    // إخفاء القائمة عند الضغط خارجها
    document.addEventListener("click", function(e) {
      if (!box.contains(e.target) && e.target !== input) {
        hideBox();
      }
    });

    // Esc يغلق القائمة
    input.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        hideBox();
      }
    });
  })();
</script>
{% endblock %}

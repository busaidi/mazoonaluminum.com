{# templates/accounting/dashboard.html #}
{% extends "accounting/base_accounting.html" %}
{% load i18n humanize %}

{% block title %}{% trans "لوحة المحاسبة" %}{% endblock %}

{% block accounting_content %}

{# ====== KPIs Cards ====== #}
<div class="row g-3 mb-4">

  {# كرت المبيعات #}
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase small fw-bold mb-2">{% trans "المبيعات" %}</h6>
        <div class="d-flex align-items-baseline">
          <h3 class="fw-bold text-dark mb-0">
            {{ sales_total_amount|default:"0"|intcomma }}
          </h3>
          <small class="text-muted ms-1">OMR</small>
        </div>
        <div class="mt-2 small text-secondary">
          <span>{{ sales_invoice_count|default:0 }}</span> {% trans "فاتورة مسجلة" %}
        </div>
      </div>
    </div>
  </div>

  {# كرت المشتريات #}
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase small fw-bold mb-2">{% trans "المشتريات" %}</h6>
        <div class="d-flex align-items-baseline">
          <h3 class="fw-bold text-dark mb-0">
            {{ purchase_total_amount|default:"0"|intcomma }}
          </h3>
          <small class="text-muted ms-1">OMR</small>
        </div>
        <div class="mt-2 small text-secondary">
          <span>{{ purchase_invoice_count|default:0 }}</span> {% trans "فاتورة مسجلة" %}
        </div>
      </div>
    </div>
  </div>

  {# كرت المقبوضات #}
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase small fw-bold mb-2">{% trans "المقبوضات" %}</h6>
        <div class="d-flex align-items-baseline">
          <h3 class="fw-bold text-success mb-0">
            {{ payments_receipt_total|default:"0"|intcomma }}
          </h3>
          <small class="text-muted ms-1">OMR</small>
        </div>
        <div class="mt-2 small text-secondary">
          {% trans "سندات قبض" %}
        </div>
      </div>
    </div>
  </div>

  {# كرت المصروفات #}
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase small fw-bold mb-2">{% trans "المصروفات" %}</h6>
        <div class="d-flex align-items-baseline">
          <h3 class="fw-bold text-danger mb-0">
            {{ payments_payment_total|default:"0"|intcomma }}
          </h3>
          <small class="text-muted ms-1">OMR</small>
        </div>
        <div class="mt-2 small text-secondary">
          {% trans "سندات صرف" %}
        </div>
      </div>
    </div>
  </div>

</div>

{# ====== الجداول ====== #}
<div class="row g-4">
  
  {# العمود الأيمن: الجداول #}
  <div class="col-12 col-lg-8">
    
    {# 1. آخر فواتير المبيعات #}
    <div class="card border-0 shadow-sm rounded-3 mb-4">
      <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold text-dark">{% trans "آخر المبيعات" %}</h6>
        <a href="{% url 'accounting:sales_invoice_list' %}" class="btn btn-sm btn-outline-dark">
          {% trans "الكل" %}
        </a>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light small text-muted">
            <tr>
              <th>{% trans "رقم الفاتورة" %}</th>
              <th>{% trans "العميل" %}</th>
              <th>{% trans "التاريخ" %}</th>
              <th class="text-end">{% trans "القيمة" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for inv in recent_sales_invoices %}
              <tr>
                <td>
                  <a href="{% url 'accounting:sales_invoice_detail' inv.pk %}"
                     class="fw-bold text-decoration-none text-dark">
                    {{ inv.display_number }}
                  </a>
                </td>
                <td class="text-truncate" style="max-width: 150px;">
                  {% if inv.customer %}
                    {{ inv.customer.name }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="text-muted small">
                  {{ inv.issued_at|date:"d/m/Y" }}
                </td>
                <td class="text-end fw-bold">
                  {{ inv.total_amount|default:"0"|intcomma }}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4 small">
                  {% trans "لا توجد فواتير" %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {# 2. آخر السندات #}
    <div class="card border-0 shadow-sm rounded-3">
      <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold text-dark">{% trans "آخر السندات المالية" %}</h6>
        <a href="{% url 'accounting:payment_list' %}" class="btn btn-sm btn-outline-dark">
          {% trans "الكل" %}
        </a>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light small text-muted">
            <tr>
              <th>{% trans "رقم السند" %}</th>
              <th>{% trans "النوع" %}</th>
              <th>{% trans "الطرف" %}</th>
              <th class="text-end">{% trans "المبلغ" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for p in recent_payments %}
              <tr>
                <td>
                  <a href="{% url 'accounting:payment_detail' p.pk %}"
                     class="text-decoration-none text-dark fw-bold">
                    {{ p.display_number }}
                  </a>
                </td>
                <td>
                  {% if p.type == 'receipt' %}
                    <span class="badge bg-light text-success border border-success">
                      {% trans "قبض" %}
                    </span>
                  {% else %}
                    <span class="badge bg-light text-danger border border-danger">
                      {% trans "صرف" %}
                    </span>
                  {% endif %}
                </td>
                <td class="text-truncate" style="max-width: 150px;">
                  {% if p.contact %}
                    {{ p.contact.name }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="text-end fw-bold">
                  {{ p.amount|default:"0"|intcomma }}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4 small">
                  {% trans "لا توجد سندات" %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  {# العمود الأيسر: ملخص الحسابات #}
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-header bg-white border-bottom py-3">
        <h6 class="mb-0 fw-bold text-dark">{% trans "الحسابات الرئيسية" %}</h6>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light small text-muted">
              <tr>
                <th>{% trans "الكود" %}</th>
                <th>{% trans "الحساب" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for acc in key_accounts %}
                <tr>
                  <td class="text-muted small font-monospace">
                    {{ acc.code }}
                  </td>
                  <td class="fw-bold text-dark">
                    {{ acc.name }}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="2" class="text-center p-4 text-muted small">
                    {% trans "لا توجد حسابات" %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-white text-center py-3 border-top">
        <a href="{% url 'accounting:trial_balance' %}" class="btn btn-dark btn-sm w-100">
          {% trans "عرض ميزان المراجعة" %}
        </a>
      </div>
    </div>
  </div>

</div>

{% endblock %}

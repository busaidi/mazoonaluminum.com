{# templates/accounting/dashboard.html #}
{% extends "accounting/base_accounting.html" %}
{% load i18n %}

{% block title %}{% trans "لوحة المحاسبة" %}{% endblock %}

{% block accounting_content %}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div>
    <h1 class="h4 mb-1">{% trans "لوحة المحاسبة" %}</h1>
    <p class="text-muted small mb-0">
      {% trans "نظرة سريعة على وضع الحسابات، الفواتير، والحركة المالية." %}
    </p>
  </div>
</div>

{# ====== KPIs أساسية ====== #}
<div class="row g-3 mb-3">
  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body py-3">
        <div class="text-muted small mb-1">{% trans "عدد الفواتير" %}</div>
        <div class="fs-4 fw-bold">
          {{ invoice_count|default:0 }}
        </div>
        <div class="small text-muted">
          {% trans "إجمالي الفواتير المسجَّلة" %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body py-3">
        <div class="text-muted small mb-1">{% trans "إجمالي المبيعات" %}</div>
        <div class="fs-4 fw-bold">
          {{ total_amount|default:"0.000" }}
        </div>
        <div class="small text-muted">
          {% trans "قيمة الفواتير (كل الحالات أو حسب ما تضبطه في الـ view)" %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body py-3">
        <div class="text-muted small mb-1">{% trans "الرصيد المستحق" %}</div>
        <div class="fs-4 fw-bold text-danger">
          {{ total_balance|default:"0.000" }}
        </div>
        <div class="small text-muted">
          {% trans "إجمالي الذمم المدينة (المتبقي على العملاء)" %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body py-3">
        <div class="text-muted small mb-1">{% trans "عدد الحسابات" %}</div>
        <div class="fs-4 fw-bold">
          {{ accounts_count|default:0 }}
        </div>
        <div class="small text-muted">
          {% trans "الحسابات في دليل الحسابات" %}
        </div>
      </div>
    </div>
  </div>
</div>

{# ====== آخر الفواتير ====== #}
<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">{% trans "آخر الفواتير" %}</h2>
          <a href="{% url 'accounting:invoice_list' %}" class="small">
            {% trans "عرض الكل" %}
          </a>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>{% trans "الرقم" %}</th>
                <th>{% trans "العميل" %}</th>
                <th>{% trans "التاريخ" %}</th>
                <th class="text-end">{% trans "الإجمالي" %}</th>
              </tr>
            </thead>
            <tbody>
           {% for inv in recent_invoices %}
  <tr>
    <td class="text-nowrap">
      <a href="{% url 'accounting:invoice_detail' inv.pk %}">
        {{ inv.serial|default:inv.pk }}
      </a>
    </td>
    <td class="text-truncate" style="max-width: 180px;">
      {{ inv.customer|default:"-" }}
    </td>
    <td class="small text-muted">
      {{ inv.issued_at|date:"Y-m-d" }}
    </td>
    <td class="text-end small">
      {{ inv.total_amount }}
    </td>
  </tr>
{% empty %}
  <tr>
    <td colspan="4" class="text-center text-muted small py-3">
      {% trans "لا توجد فواتير حتى الآن." %}
    </td>
  </tr>
{% endfor %}

            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  {# ====== ملخص سريع للحسابات أو ميزان مبسط ====== #}
  <div class="col-12 col-lg-5">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6 mb-2">{% trans "ملخص الحسابات الرئيسية" %}</h2>
        <p class="text-muted small mb-2">
          {% trans "أهم الأرصدة من دليل الحسابات." %}
        </p>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>{% trans "الحساب" %}</th>
                <th class="text-end">{% trans "الرصيد" %}</th>
              </tr>
            </thead>
            <tbody>
            {% for acc in key_accounts %}
              <tr>
                <td class="text-truncate" style="max-width: 180px;">
                  {{ acc.name }}
                </td>
                <td class="text-end small">
                  {{ acc.balance|default:"0.000" }}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2" class="text-center text-muted small py-3">
                  {% trans "لا توجد بيانات كافية لعرض الملخص." %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="mt-3 text-end">
          <a href="{% url 'accounting:trial_balance' %}" class="btn btn-sm btn-outline-primary">
            {% trans "فتح ميزان المراجعة" %}
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

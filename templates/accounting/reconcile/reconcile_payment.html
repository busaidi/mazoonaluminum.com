{% extends "accounting/base_accounting.html" %}
{% load i18n %}

{% block title %}
  {% trans "تسوية الدفعة مع الفواتير" %}
{% endblock %}

{% block accounting_content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h5 fw-bold mb-1">
      {% trans "تسوية الدفعة" %} {{ payment.display_number }}
    </h1>
    <p class="text-muted small mb-0">
      {% if payment.contact %}
        {{ payment.contact.name }}
      {% else %}
        {% trans "طرف غير محدد" %}
      {% endif %}
      • {{ payment.date|date:"Y-m-d" }}
    </p>
  </div>

  <div class="d-flex flex-wrap gap-2">
    <a href="{% url 'accounting:payment_detail' payment.pk %}"
       class="btn btn-outline-secondary btn-sm">
      {% trans "رجوع للسند" %}
    </a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body small">
        <h2 class="h6 fw-semibold mb-3">{% trans "ملخص الدفعة" %}</h2>

        <dl class="row mb-0">
          <dt class="col-5 text-muted">{% trans "رقم السند" %}</dt>
          <dd class="col-7 fw-semibold">{{ payment.display_number }}</dd>

          <dt class="col-5 text-muted">{% trans "الطرف" %}</dt>
          <dd class="col-7">
            {% if payment.contact %}
              <a href="{% url 'contacts:contact_detail' payment.contact.pk %}"
                 class="fw-semibold text-mazoon text-decoration-none">
                {{ payment.contact.name }}
              </a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </dd>

          <dt class="col-5 text-muted">{% trans "التاريخ" %}</dt>
          <dd class="col-7 fw-semibold">{{ payment.date|date:"Y-m-d" }}</dd>

          <dt class="col-5 text-muted">{% trans "المبلغ الكلي" %}</dt>
          <dd class="col-7 fw-semibold">
            {{ payment.amount }} {{ payment.currency }}
          </dd>

          <dt class="col-5 text-muted">{% trans "المبلغ المخصص" %}</dt>
          <dd class="col-7 fw-semibold">
            {{ payment.allocated_amount }} {{ payment.currency }}
          </dd>

          <dt class="col-5 text-muted">{% trans "المبلغ المتبقي" %}</dt>
          <dd class="col-7 fw-semibold">
            {{ payment.unallocated_amount }} {{ payment.currency }}
          </dd>
        </dl>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body small">
        <h2 class="h6 fw-semibold mb-3">{% trans "تسوية مع الفواتير المفتوحة" %}</h2>

        <form method="post" class="vstack gap-3">
          {% csrf_token %}

          {# أخطاء عامة للفورم #}
          {% if form.non_field_errors %}
            <div class="alert alert-danger small mb-0">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          {% if invoice_rows %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>{% trans "الفاتورة" %}</th>
                    <th>{% trans "تاريخ الفاتورة" %}</th>
                    <th class="text-end">{% trans "الإجمالي" %}</th>
                    <th class="text-end">{% trans "المخصص سابقًا" %}</th>
                    <th class="text-end">{% trans "الرصيد" %}</th>
                    <th style="width: 160px;" class="text-end">
                      {% trans "المبلغ للتسوية" %}
                    </th>
                  </tr>
                </thead>
                <tbody>
                {% for row in invoice_rows %}
                  {% with invoice=row.invoice field=row.field %}
                    <tr>
                      <td>
                        {{ invoice.display_number }}<br>
                        <span class="badge bg-light text-muted border small">
                          {{ invoice.get_status_display }}
                        </span>
                      </td>
                      <td>{{ invoice.issued_at|date:"Y-m-d" }}</td>
                      <td class="text-end">{{ invoice.total_amount }}</td>
                      <td class="text-end">
                        {{ invoice.allocated_amount|default:"0.000" }}
                      </td>
                      <td class="text-end">{{ invoice.balance }}</td>
                      <td class="text-end">
                        <div class="text-end">
                          {{ field }}
                          {% if field.errors %}
                            <div class="text-danger small">{{ field.errors }}</div>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endwith %}
                {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="text-end mt-3">
              <button type="submit" class="btn btn-primary btn-sm">
                {% trans "حفظ التسوية" %}
              </button>
            </div>
          {% else %}
            <p class="text-muted mb-0">
              {% trans "لا توجد فواتير مفتوحة لهذا الطرف يمكن تسوية هذه الدفعة معها." %}
            </p>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% extends "accounting/base_accounting.html" %}
{% load i18n %}

{% block title %}{% trans "إعدادات المبيعات والفواتير" %}{% endblock %}

{% block accounting_content %}
<div class="py-4">

  {# عنوان الصفحة ووصفها #}
  <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <h1 class="h5 mb-1">{% trans "إعدادات المبيعات والفواتير" %}</h1>
      <p class="text-muted small mb-0">
        {% trans "قم بضبط سلوك الفواتير، الطلبات، أرقام الدفعات، ضريبة القيمة المضافة، والنصوص الافتراضية." %}
      </p>
    </div>
  </div>

  <form method="post" class="card card-body shadow-sm">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger small mb-3">
        {% for error in form.non_field_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}


    <div class="mb-4">
      <h5 class="h6 mb-2">{% trans "ترقيم الطلبات" %}</h5>
      <p class="text-muted small mb-3">
        {% trans "تحكم في شكل أرقام الطلبات، مثل ORD-2025-0001 أو نمط مخصص." %}
      </p>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.order_prefix.id_for_label }}">
            {{ form.order_prefix.label }}
          </label>
          {{ form.order_prefix }}
          {% if form.order_prefix.help_text %}
            <div class="form-text small">{{ form.order_prefix.help_text }}</div>
          {% endif %}
          {% for error in form.order_prefix.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.order_padding.id_for_label }}">
            {{ form.order_padding.label }}
          </label>
          {{ form.order_padding }}
          {% if form.order_padding.help_text %}
            <div class="form-text small">{{ form.order_padding.help_text }}</div>
          {% endif %}
          {% for error in form.order_padding.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.order_start_value.id_for_label }}">
            {{ form.order_start_value.label }}
          </label>
          {{ form.order_start_value }}
          {% if form.order_start_value.help_text %}
            <div class="form-text small">{{ form.order_start_value.help_text }}</div>
          {% endif %}
          {% for error in form.order_start_value.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.order_reset_policy.id_for_label }}">
            {{ form.order_reset_policy.label }}
          </label>
          {{ form.order_reset_policy }}
          {% if form.order_reset_policy.help_text %}
            <div class="form-text small">{{ form.order_reset_policy.help_text }}</div>
          {% endif %}
          {% for error in form.order_reset_policy.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12">
          <label class="form-label form-label-sm" for="{{ form.order_custom_pattern.id_for_label }}">
            {{ form.order_custom_pattern.label }}
          </label>
          {{ form.order_custom_pattern }}
          {% if form.order_custom_pattern.help_text %}
            <div class="form-text small">
              {{ form.order_custom_pattern.help_text }}<br>
              <span class="text-muted">
                {% trans "أمثلة:" %} <code>ORD-{year}-{seq:04d}</code>،
                <code>SO-{year}-{month:02d}-{seq:03d}</code>
              </span>
            </div>
          {% endif %}
          {% for error in form.order_custom_pattern.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <hr class="my-3">


    <div class="mb-4">
      <h5 class="h6 mb-2">{% trans "ترقيم الفواتير" %}</h5>
      <p class="text-muted small mb-3">
        {% trans "تحكم في شكل أرقام الفواتير، البادئة، عدد الخانات، وسياسة إعادة الترقيم." %}
      </p>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.invoice_prefix.id_for_label }}">
            {{ form.invoice_prefix.label }}
          </label>
          {{ form.invoice_prefix }}
          {% if form.invoice_prefix.help_text %}
            <div class="form-text small">{{ form.invoice_prefix.help_text }}</div>
          {% endif %}
          {% for error in form.invoice_prefix.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.invoice_padding.id_for_label }}">
            {{ form.invoice_padding.label }}
          </label>
          {{ form.invoice_padding }}
          {% if form.invoice_padding.help_text %}
            <div class="form-text small">{{ form.invoice_padding.help_text }}</div>
          {% endif %}
          {% for error in form.invoice_padding.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.invoice_start_value.id_for_label }}">
            {{ form.invoice_start_value.label }}
          </label>
          {{ form.invoice_start_value }}
          {% if form.invoice_start_value.help_text %}
            <div class="form-text small">{{ form.invoice_start_value.help_text }}</div>
          {% endif %}
          {% for error in form.invoice_start_value.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.invoice_reset_policy.id_for_label }}">
            {{ form.invoice_reset_policy.label }}
          </label>
          {{ form.invoice_reset_policy }}
          {% if form.invoice_reset_policy.help_text %}
            <div class="form-text small">{{ form.invoice_reset_policy.help_text }}</div>
          {% endif %}
          {% for error in form.invoice_reset_policy.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12">
          <label class="form-label form-label-sm" for="{{ form.invoice_custom_pattern.id_for_label }}">
            {{ form.invoice_custom_pattern.label }}
          </label>
          {{ form.invoice_custom_pattern }}
          {% if form.invoice_custom_pattern.help_text %}
            <div class="form-text small">
              {{ form.invoice_custom_pattern.help_text }}<br>
              <span class="text-muted">
                {% trans "أمثلة:" %} <code>INV-{year}-{seq:04d}</code>،
                <code>SO-{year}-{month:02d}-{seq:03d}</code>
              </span>
            </div>
          {% endif %}
          {% for error in form.invoice_custom_pattern.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <hr class="my-3">


    <div class="mb-4">
      <h5 class="h6 mb-2">{% trans "ترقيم الدفعات" %}</h5>
      <p class="text-muted small mb-3">
        {% trans "تحكم في شكل أرقام الدفعات، البادئة، عدد الخانات، وسياسة إعادة الترقيم." %}
      </p>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.payment_prefix.id_for_label }}">
            {{ form.payment_prefix.label }}
          </label>
          {{ form.payment_prefix }}
          {% if form.payment_prefix.help_text %}
            <div class="form-text small">{{ form.payment_prefix.help_text }}</div>
          {% endif %}
          {% for error in form.payment_prefix.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.payment_padding.id_for_label }}">
            {{ form.payment_padding.label }}
          </label>
          {{ form.payment_padding }}
          {% if form.payment_padding.help_text %}
            <div class="form-text small">{{ form.payment_padding.help_text }}</div>
          {% endif %}
          {% for error in form.payment_padding.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.payment_start_value.id_for_label }}">
            {{ form.payment_start_value.label }}
          </label>
          {{ form.payment_start_value }}
          {% if form.payment_start_value.help_text %}
            <div class="form-text small">{{ form.payment_start_value.help_text }}</div>
          {% endif %}
          {% for error in form.payment_start_value.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label form-label-sm" for="{{ form.payment_reset_policy.id_for_label }}">
            {{ form.payment_reset_policy.label }}
          </label>
          {{ form.payment_reset_policy }}
          {% if form.payment_reset_policy.help_text %}
            <div class="form-text small">{{ form.payment_reset_policy.help_text }}</div>
          {% endif %}
          {% for error in form.payment_reset_policy.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12">
          <label class="form-label form-label-sm" for="{{ form.payment_custom_pattern.id_for_label }}">
            {{ form.payment_custom_pattern.label }}
          </label>
          {{ form.payment_custom_pattern }}
          {% if form.payment_custom_pattern.help_text %}
            <div class="form-text small">
              {{ form.payment_custom_pattern.help_text }}<br>
              <span class="text-muted">
                {% trans "أمثلة:" %} <code>PAY-{year}-{seq:04d}</code>،
                <code>RCPT-{year}-{month:02d}-{seq:03d}</code>
              </span>
            </div>
          {% endif %}
          {% for error in form.payment_custom_pattern.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <hr class="my-3">


    <div class="mb-4">
      <h5 class="h6 mb-2">{% trans "سلوك الفاتورة" %}</h5>
      <p class="text-muted small mb-3">
        {% trans "الاستحقاق الافتراضي، واعتماد الفاتورة تلقائيًا، والترحيل التلقائي إلى دفتر الأستاذ." %}
      </p>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label form-label-sm" for="{{ form.default_due_days.id_for_label }}">
            {{ form.default_due_days.label }}
          </label>
          {{ form.default_due_days }}
          {% if form.default_due_days.help_text %}
            <div class="form-text small">{{ form.default_due_days.help_text }}</div>
          {% endif %}
          {% for error in form.default_due_days.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <div class="form-check mt-4 pt-1">
            {{ form.auto_confirm_invoice }}
            <label class="form-check-label" for="{{ form.auto_confirm_invoice.id_for_label }}">
              {{ form.auto_confirm_invoice.label }}
            </label>
          </div>
          {% if form.auto_confirm_invoice.help_text %}
            <div class="form-text small">{{ form.auto_confirm_invoice.help_text }}</div>
          {% endif %}
          {% for error in form.auto_confirm_invoice.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <div class="form-check mt-4 pt-1">
            {{ form.auto_post_to_ledger }}
            <label class="form-check-label" for="{{ form.auto_post_to_ledger.id_for_label }}">
              {{ form.auto_post_to_ledger.label }}
            </label>
          </div>
          {% if form.auto_post_to_ledger.help_text %}
            <div class="form-text small">{{ form.auto_post_to_ledger.help_text }}</div>
          {% endif %}
          {% for error in form.auto_post_to_ledger.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <hr class="my-3">


    <div class="mb-4">
      <h5 class="h6 mb-2">{% trans "ضريبة القيمة المضافة (VAT)" %}</h5>
      <p class="text-muted small mb-3">
        {% trans "يمكنك ضبط النسبة الافتراضية، وهل الأسعار شاملة للضريبة أم لا." %}
      </p>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label form-label-sm" for="{{ form.default_vat_rate.id_for_label }}">
            {{ form.default_vat_rate.label }}
          </label>
          {{ form.default_vat_rate }}
          {% if form.default_vat_rate.help_text %}
            <div class="form-text small">{{ form.default_vat_rate.help_text }}</div>
          {% endif %}
          {% for error in form.default_vat_rate.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <div class="form-check mt-4 pt-1">
            {{ form.prices_include_vat }}
            <label class="form-check-label" for="{{ form.prices_include_vat.id_for_label }}">
              {{ form.prices_include_vat.label }}
            </label>
          </div>
          {% if form.prices_include_vat.help_text %}
            <div class="form-text small">{{ form.prices_include_vat.help_text }}</div>
          {% endif %}
          {% for error in form.prices_include_vat.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <hr class="my-3">


    <div class="mb-3">
      <h5 class="h6 mb-2">{% trans "النصوص الافتراضية" %}</h5>
      <p class="text-muted small mb-3">
        {% trans "تُنسخ هذه النصوص تلقائيًا إلى الفاتورة الجديدة، ويمكنك تعديلها يدويًا في كل فاتورة." %}
      </p>

      <div class="mb-3">
        <label class="form-label form-label-sm" for="{{ form.default_terms.id_for_label }}">
          {{ form.default_terms.label }}
        </label>
        {{ form.default_terms }}
        {% if form.default_terms.help_text %}
          <div class="form-text small">{{ form.default_terms.help_text }}</div>
        {% endif %}
        {% for error in form.default_terms.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="mb-0">
        <label class="form-label form-label-sm" for="{{ form.footer_notes.id_for_label }}">
          {{ form.footer_notes.label }}
        </label>
        {{ form.footer_notes }}
        {% if form.footer_notes.help_text %}
          <div class="form-text small">{{ form.footer_notes.help_text }}</div>
        {% endif %}
        {% for error in form.footer_notes.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        {% trans "حفظ الإعدادات" %}
      </button>
      <a href="{% url 'accounting:dashboard' %}" class="btn btn-outline-secondary">
        {% trans "رجوع إلى لوحة المحاسبة" %}
      </a>
    </div>
  </form>

</div>
{% endblock %}

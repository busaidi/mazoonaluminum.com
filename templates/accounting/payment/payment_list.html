{% extends "base.html" %}
{% load i18n %}

{% block meta_title %}{% trans "الدفعات" %} | Mazoon Aluminum{% endblock %}
{% block meta_description %}
{% trans "قائمة الدفعات مع إمكانية البحث والتصفية والتسوية على الفواتير في نظام المحاسبة." %}
{% endblock %}

{% block content %}
<div class="py-4">

  <!-- العنوان + زر إضافة -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
      <h1 class="h4 mb-1">{% trans "الدفعات" %}</h1>
      <p class="text-muted small mb-0">
        {% trans "إدارة دفعات العملاء وتسويتها على الفواتير أو كدفعات عامة." %}
      </p>
    </div>

    <a href="{% url 'accounting:payment_create' %}" class="btn btn-primary btn-sm">
      + {% trans "إضافة دفعة جديدة" %}
    </a>
  </div>

  <!-- فلاتر البحث -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="text"
             name="customer"
             value="{{ customer_filter }}"
             class="form-control form-control-sm"
             placeholder="{% trans 'بحث باسم العميل' %}">
    </div>

    <div class="col-md-3">
      <select name="method" class="form-select form-select-sm">
        <option value="">{% trans "كل طرق الدفع" %}</option>
        {% for code, label in payments.model.Method.choices %}
          <option value="{{ code }}" {% if code == method_filter %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary btn-sm w-100">
        {% trans "بحث" %}
      </button>
    </div>
  </form>

  <!-- جدول الدفعات -->
  <div class="card p-3">
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th class="small text-muted">{% trans "التاريخ" %}</th>
            <th class="small text-muted">{% trans "العميل" %}</th>
            <th class="small text-muted">{% trans "المبلغ" %}</th>
            <th class="small text-muted">{% trans "الطريقة" %}</th>
            <th class="small text-muted">{% trans "الفاتورة" %}</th>
            <th class="small text-muted">{% trans "ملاحظات" %}</th>
            <th class="small text-muted text-end">{% trans "إجراءات" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr>
            <td class="text-nowrap">
              {{ p.date|date:"Y-m-d" }}
            </td>

            <td>
              <a href="{% url 'accounting:customer_detail' p.customer.pk %}">
                {{ p.customer.name }}
              </a>
            </td>

            <td class="text-nowrap">
              <strong>{{ p.amount }}</strong>
            </td>

            <td>
              <span class="badge bg-light text-muted border">
                {{ p.get_method_display }}
              </span>
            </td>

            <td>
              {% if p.invoice %}
                <a href="{% url 'accounting:invoice_detail' p.invoice.number %}">
                  {{ p.invoice.number }}
                </a>
              {% else %}
                <span class="text-muted small">
                  {% trans "دفعة عامة (بدون فاتورة)" %}
                </span>
              {% endif %}
            </td>

            <td class="small">
              {{ p.notes|default:"-" }}
            </td>

            <td class="text-end">
              <div class="d-inline-flex gap-1">
                <!-- زر تعديل الدفعة -->
                <a href="{% url 'accounting:payment_update' p.pk %}"
                   class="btn btn-outline-secondary btn-sm">
                  {% trans "تعديل" %}
                </a>

                <!-- زر تسوية يظهر فقط للدفعات العامة -->
                {% if not p.invoice %}
                  <a href="{% url 'accounting:payment_apply' p.pk %}"
                     class="btn btn-outline-primary btn-sm">
                    {% trans "تسوية" %}
                  </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              {% trans "لا توجد دفعات" %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
      <div class="mt-3 d-flex justify-content-center">
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&customer={{ customer_filter }}&method={{ method_filter }}">
                  &laquo;
                </a>
              </li>
            {% endif %}

            {% for num in paginator.page_range %}
              <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link"
                   href="?page={{ num }}&customer={{ customer_filter }}&method={{ method_filter }}">
                  {{ num }}
                </a>
              </li>
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&customer={{ customer_filter }}&method={{ method_filter }}">
                  &raquo;
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}

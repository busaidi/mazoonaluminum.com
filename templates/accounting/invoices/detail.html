{% extends "accounting/base_accounting.html" %}
{% load i18n %}

{# ================= META TAGS ================= #}
{% block meta_title %}
  {% with serial=invoice.display_number %}
    {% if invoice_type == 'purchase' %}
      {% blocktrans with serial=serial %}ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª {{ serial }} | Mazoon Aluminum{% endblocktrans %}
    {% elif invoice_type == 'sales' %}
      {% blocktrans with serial=serial %}ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª {{ serial }} | Mazoon Aluminum{% endblocktrans %}
    {% else %}
      {% blocktrans with serial=serial %}ÙØ§ØªÙˆØ±Ø© {{ serial }} | Mazoon Aluminum{% endblocktrans %}
    {% endif %}
  {% endwith %}
{% endblock %}

{% block meta_description %}
  {% with serial=invoice.display_number customer=invoice.customer.name %}
    {% if invoice_type == 'purchase' %}
      {% blocktrans with serial=serial customer=customer %}
        ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… {{ serial }} Ù„Ù„Ù…ÙˆØ±Ø¯ {{ customer }}ØŒ Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº.
      {% endblocktrans %}
    {% elif invoice_type == 'sales' %}
      {% blocktrans with serial=serial customer=customer %}
        ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø±Ù‚Ù… {{ serial }} Ù„Ù„Ø¹Ù…ÙŠÙ„ {{ customer }}ØŒ Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº.
      {% endblocktrans %}
    {% else %}
      {% blocktrans with serial=serial customer=customer %}
        ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… {{ serial }} Ù„Ù„Ø·Ø±Ù {{ customer }}ØŒ Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº.
      {% endblocktrans %}
    {% endif %}
  {% endwith %}
{% endblock %}

{% block accounting_content %}
<div class="py-4">

  {# Ù†Ø­Ø¯Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© #}
  {% if invoice_type == 'purchase' %}
    {% url 'accounting:purchase_invoice_list' as back_url %}
  {% elif invoice_type == 'sales' %}
    {% url 'accounting:sales_invoice_list' as back_url %}
  {% else %}
    {% url 'accounting:dashboard' as back_url %}
  {% endif %}

  {# ================= HEADER ================= #}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
      {% with serial=invoice.display_number %}
        <h1 class="h3 mb-1">
          {% if invoice_type == 'purchase' %}
            {% blocktrans with serial=serial %}ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª {{ serial }}{% endblocktrans %}
          {% elif invoice_type == 'sales' %}
            {% blocktrans with serial=serial %}ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª {{ serial }}{% endblocktrans %}
          {% else %}
            {% blocktrans with serial=serial %}ÙØ§ØªÙˆØ±Ø© {{ serial }}{% endblocktrans %}
          {% endif %}
        </h1>
      {% endwith %}

      <p class="text-muted small mb-0">
        {% if invoice_type == 'purchase' %}
          {% blocktrans with name=invoice.customer.name %}Ù…ÙˆØ±Ø¯: {{ name }}{% endblocktrans %}
        {% else %}
          {% blocktrans with name=invoice.customer.name %}Ø¹Ù…ÙŠÙ„: {{ name }}{% endblocktrans %}
        {% endif %}
      </p>
    </div>

    <div class="d-flex flex-wrap gap-2">
      {# Ù†Ø­Ø¯Ø¯ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ / Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ø­ÙŠÙ„ / Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© #}
      {% if invoice_type == 'purchase' %}
        {% url 'accounting:purchase_invoice_edit' invoice.pk as edit_url %}
        {% url 'accounting:purchase_invoice_confirm' invoice.pk as confirm_url %}
        {% url 'accounting:purchase_invoice_unpost' invoice.pk as unpost_url %}
        {% url 'accounting:purchase_invoice_print' invoice.pk as print_url %}
      {% else %}
        {# Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø¨Ø§Ù‚ÙŠ = Ù…Ø¨ÙŠØ¹Ø§Øª #}
        {% url 'accounting:sales_invoice_edit' invoice.pk as edit_url %}
        {% url 'accounting:sales_invoice_confirm' invoice.pk as confirm_url %}
        {% url 'accounting:sales_invoice_unpost' invoice.pk as unpost_url %}
        {% url 'accounting:sales_invoice_print' invoice.pk as print_url %}
      {% endif %}

      {# ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© #}
      <a href="{{ edit_url }}"
         class="btn btn-primary btn-sm">
        {% trans "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" %}
      </a>

      {# Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ±Ø­ÙŠÙ„ - ÙÙ‚Ø· Ù„Ùˆ Ù…Ø³ÙˆØ¯Ø© #}
      {% if invoice.status == 'draft' %}
        <a href="{{ confirm_url }}"
           class="btn btn-outline-primary btn-sm">
          {% trans "Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ±Ø­ÙŠÙ„ Ø¥Ù„Ù‰ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°" %}
        </a>
      {% endif %}

      {# Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ø­ÙŠÙ„ - Ù„Ùˆ Ù„ÙŠØ³Øª Ù…Ø³ÙˆØ¯Ø© ÙˆÙŠÙˆØ¬Ø¯ Ù‚ÙŠØ¯ Ù…Ø±ØªØ¨Ø· #}
      {% if invoice.status != 'draft' and invoice.ledger_entry %}
        <a href="{{ unpost_url }}"
           class="btn btn-outline-warning btn-sm">
          {% trans "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ø­ÙŠÙ„" %}
        </a>
      {% endif %}

      {# Ø¹Ø±Ø¶ Ù‚ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø© #}
      {% if invoice.ledger_entry %}
        <a href="{% url 'accounting:journal_entry_detail' invoice.ledger_entry.pk %}"
           class="btn btn-outline-secondary btn-sm">
          {% trans "Ø¹Ø±Ø¶ Ù‚ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©" %}
        </a>
      {% endif %}

      {# Ø·Ø¨Ø§Ø¹Ø© / PDF #}
      <a href="{{ print_url }}"
         class="btn btn-outline-secondary btn-sm"
         target="_blank">
        {% trans "Ø·Ø¨Ø§Ø¹Ø© / PDF" %}
      </a>

      {# Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© #}
      <a href="{{ back_url }}" class="btn btn-secondary btn-sm">
        {% if invoice_type == 'purchase' %}
          {% trans "Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª" %}
        {% elif invoice_type == 'sales' %}
          {% trans "Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" %}
        {% else %}
          {% trans "Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©" %}
        {% endif %}
      </a>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯ -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">
            {% if invoice_type == 'purchase' %}
              {% trans "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯" %}
            {% else %}
              {% trans "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„" %}
            {% endif %}
          </h5>
          <p class="mb-1 fw-semibold">{{ invoice.customer.name }}</p>

          {% if invoice.customer.company_name %}
            <p class="mb-1 text-muted small">{{ invoice.customer.company_name }}</p>
          {% endif %}

          {% if invoice.customer.phone %}
            <p class="mb-1">
              <span class="text-muted small">ğŸ“</span>
              <span class="small">{{ invoice.customer.phone }}</span>
            </p>
          {% endif %}

          {% if invoice.customer.email %}
            <p class="mb-0">
              <span class="text-muted small">âœ‰</span>
              <span class="small">{{ invoice.customer.email }}</span>
            </p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">{% trans "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" %}</h5>
          <p class="mb-1 small">
            <span class="text-muted">{% trans "Ø§Ù„ØªØ§Ø±ÙŠØ®:" %}</span>
            <span class="fw-semibold">{{ invoice.issued_at|date:"d M Y" }}</span>
          </p>
          <p class="mb-1 small">
            <span class="text-muted">{% trans "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:" %}</span>
            <span class="fw-semibold">
              {% if invoice.due_date %}
                {{ invoice.due_date|date:"d M Y" }}
              {% else %}
                -
              {% endif %}
            </span>
          </p>
          <p class="mb-0 small">
            <span class="text-muted">{% trans "Ø§Ù„Ø­Ø§Ù„Ø©:" %}</span>
            <span class="{{ invoice.status_badge }} ms-1">
              {{ invoice.get_status_display }}
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø¨Ø§Ù„Øº -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">{% trans "Ø§Ù„Ù…Ø¨Ø§Ù„Øº" %}</h5>
      <div class="row">
        <div class="col-md-4 col-sm-6 mb-2">
          <div class="small text-muted mb-1">{% trans "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" %}</div>
          <div class="fw-semibold">{{ invoice.total_amount }}</div>
        </div>
        <div class="col-md-4 col-sm-6 mb-2">
          <div class="small text-muted mb-1">{% trans "Ø§Ù„Ù…Ø¯ÙÙˆØ¹" %}</div>
          <div class="fw-semibold">{{ invoice.paid_amount }}</div>
        </div>
        <div class="col-md-4 col-sm-6 mb-2">
          <div class="small text-muted mb-1">{% trans "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ" %}</div>
          <div class="fw-semibold">{{ invoice.balance }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">{% trans "Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" %}</h5>

      <div class="table-responsive">
        <table class="table table-sm align-middle invoice-items-table mb-0">
          <thead class="table-light">
            <tr>
              <th class="product-col">{% trans "Ø§Ù„Ù…Ù†ØªØ¬" %}</th>
              <th class="desc-col">{% trans "Ø§Ù„ÙˆØµÙ" %}</th>
              <th class="qty-col text-center">{% trans "Ø§Ù„ÙƒÙ…ÙŠØ©" %}</th>
              <th class="price-col text-center">{% trans "Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©" %}</th>
              <th class="total-col text-end">{% trans "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for item in invoice.items.all %}
              <tr>
                <td class="product-col">
                  {% if item.product %}
                    {{ item.product.name }}
                  {% else %}
                    <span class="text-muted small">â€”</span>
                  {% endif %}
                </td>
                <td class="desc-col small">
                  {% if item.description %}
                    {{ item.description }}
                  {% elif item.product %}
                    {{ item.product.description }}
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
                <td class="qty-col text-center">
                  {{ item.quantity }}
                </td>
                <td class="price-col text-center">
                  {{ item.unit_price }}
                </td>
                <td class="total-col text-end">
                  <span class="invoice-line-total">{{ item.subtotal }}</span>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted small py-3">
                  {% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©." %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Ø§Ù„ÙˆØµÙ -->
  {% if invoice.description %}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title mb-3">{% trans "Ø§Ù„ÙˆØµÙ" %}</h5>
        <p class="mb-0 small">{{ invoice.description|linebreaks }}</p>
      </div>
    </div>
  {% endif %}

  <!-- Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… -->
  {% if invoice.terms %}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title mb-3">{% trans "Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…" %}</h5>
        <p class="mb-0 small">{{ invoice.terms|linebreaks }}</p>
      </div>
    </div>
  {% endif %}

  {# Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ù€ AttachmentPanelMixin #}
  {% include "core/attachments/_panel.html" %}

</div>
{% endblock %}

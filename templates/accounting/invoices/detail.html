{% extends "accounting/base_accounting.html" %}
{% load i18n humanize %}

{# ================= META TAGS ================= #}
{% block meta_title %}
  {% with serial=invoice.display_number %}
    {% if invoice_type == 'purchase' %}
      {% blocktrans with serial=serial %}فاتورة مشتريات {{ serial }} | Mazoon Aluminum{% endblocktrans %}
    {% elif invoice_type == 'sales' %}
      {% blocktrans with serial=serial %}فاتورة مبيعات {{ serial }} | Mazoon Aluminum{% endblocktrans %}
    {% else %}
      {% blocktrans with serial=serial %}فاتورة {{ serial }} | Mazoon Aluminum{% endblocktrans %}
    {% endif %}
  {% endwith %}
{% endblock %}

{% block accounting_content %}
<div class="py-4">

  {# نحدد رابط الرجوع حسب نوع الفاتورة #}
  {% if invoice_type == 'purchase' %}
    {% url 'accounting:purchase_invoice_list' as back_url %}
  {% elif invoice_type == 'sales' %}
    {% url 'accounting:sales_invoice_list' as back_url %}
  {% else %}
    {% url 'accounting:dashboard' as back_url %}
  {% endif %}

  {# ================= HEADER ================= #}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
      {% with serial=invoice.display_number %}
        <h1 class="h3 mb-1 text-dark fw-bold">
          {% if invoice_type == 'purchase' %}
            {% blocktrans with serial=serial %}فاتورة مشتريات {{ serial }}{% endblocktrans %}
          {% elif invoice_type == 'sales' %}
            {% blocktrans with serial=serial %}فاتورة مبيعات {{ serial }}{% endblocktrans %}
          {% else %}
            {% blocktrans with serial=serial %}فاتورة {{ serial }}{% endblocktrans %}
          {% endif %}
        </h1>
      {% endwith %}

      {# سطر العميل / المورد مع حماية لو ما فيه عميل #}
      {% if invoice.customer %}
        <p class="text-muted small mb-0">
          {% if invoice_type == 'purchase' %}
            {% blocktrans with name=invoice.customer.name %}مورد: {{ name }}{% endblocktrans %}
          {% else %}
            {% blocktrans with name=invoice.customer.name %}عميل: {{ name }}{% endblocktrans %}
          {% endif %}
        </p>
      {% else %}
        <p class="text-muted small mb-0">
          {% if invoice_type == 'purchase' %}
            {% trans "مورد غير محدد" %}
          {% else %}
            {% trans "عميل غير محدد" %}
          {% endif %}
        </p>
      {% endif %}
    </div>

    <div class="d-flex flex-wrap gap-2">
      {# نحدد روابط التعديل والطباعة حسب نوع الفاتورة في الموديل نفسه #}
      {% if invoice.type == 'purchase' %}
        {% url 'accounting:purchase_invoice_edit' invoice.pk as edit_url %}
        {% url 'accounting:purchase_invoice_print' invoice.pk as print_url %}
      {% else %}
        {% url 'accounting:sales_invoice_edit' invoice.pk as edit_url %}
        {% url 'accounting:sales_invoice_print' invoice.pk as print_url %}
      {% endif %}

      <a href="{{ edit_url }}" class="btn btn-primary btn-sm">
        {% trans "تعديل الفاتورة" %}
      </a>


      <a href="{{ print_url }}" class="btn btn-outline-secondary btn-sm" target="_blank">
        {% trans "طباعة / PDF" %}
      </a>

      <a href="{{ back_url }}" class="btn btn-secondary btn-sm">
        {% trans "رجوع" %}
      </a>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3 text-muted small fw-bold text-uppercase">
            {% if invoice_type == 'purchase' %}
              {% trans "بيانات المورد" %}
            {% else %}
              {% trans "بيانات العميل" %}
            {% endif %}
          </h5>

          <p class="mb-1 fw-bold text-dark fs-5">
            {% if invoice.customer %}
              {{ invoice.customer.name }}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </p>

          {% if invoice.customer and invoice.customer.phone %}
            <p class="mb-1">
              <span class="text-muted small">{% trans "هاتف:" %}</span>
              <span class="small">{{ invoice.customer.phone }}</span>
            </p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3 text-muted small fw-bold text-uppercase">{% trans "تفاصيل الفاتورة" %}</h5>
          <p class="mb-1 small">
            <span class="text-muted">{% trans "التاريخ:" %}</span>
            <span class="fw-semibold">{{ invoice.issued_at|date:"d/m/Y" }}</span>
          </p>
          <p class="mb-1 small">
            <span class="text-muted">{% trans "الاستحقاق:" %}</span>
            <span class="fw-semibold">
              {% if invoice.due_date %}
                {{ invoice.due_date|date:"d/m/Y" }}
              {% else %}
                -
              {% endif %}
            </span>
          </p>
          <p class="mb-0 small">
            <span class="text-muted">{% trans "الحالة:" %}</span>
            {% if invoice.status == 'paid' %}
                <span class="badge bg-dark">{% trans "مدفوعة" %}</span>
            {% elif invoice.status == 'partially_paid' %}
                <span class="badge bg-warning text-dark">{% trans "جزئي" %}</span>
            {% elif invoice.status == 'sent' %}
                <span class="badge bg-primary">{% trans "مرسلة" %}</span>
            {% elif invoice.status == 'cancelled' %}
                <span class="badge bg-danger">{% trans "ملغاة" %}</span>
            {% else %}
                <span class="badge bg-secondary">{% trans "مسودة" %}</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="row text-center">
        <div class="col-4 border-end">
          <div class="small text-muted mb-1 text-uppercase fw-bold">{% trans "الإجمالي" %}</div>
          <div class="fw-bold fs-5">{{ invoice.total_amount|intcomma }}</div>
        </div>
       <div class="col-4 border-end">
  <div class="small text-muted mb-1 text-uppercase fw-bold">{% trans "المدفوع" %}</div>
  <div class="fw-bold fs-5 text-success">
    {{ invoice.allocated_amount|intcomma }}
  </div>
</div>

        <div class="col-4">
          <div class="small text-muted mb-1 text-uppercase fw-bold">{% trans "المتبقي" %}</div>
          <div class="fw-bold fs-5 text-danger">{{ invoice.balance|intcomma }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle invoice-items-table mb-0">
          <thead class="bg-light small text-muted">
            <tr>
              <th style="padding-left: 1.5rem;">{% trans "المنتج / الوصف" %}</th>
              <th class="text-center">{% trans "الكمية" %}</th>
              <th class="text-center">{% trans "السعر" %}</th>
              <th class="text-end" style="padding-right: 1.5rem;">{% trans "الإجمالي" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for item in invoice.items.all %}
              <tr>
                <td style="padding-left: 1.5rem;">
                  <div class="fw-bold text-dark">
                    {{ item.product.name|default:item.description }}
                  </div>
                  {% if item.product and item.description %}
                    <small class="text-muted">{{ item.description }}</small>
                  {% endif %}
                </td>
                <td class="text-center">{{ item.quantity|stringformat:".2f" }}</td>
                <td class="text-center">{{ item.unit_price|stringformat:".3f" }}</td>
                <td class="text-end fw-bold text-dark" style="padding-right: 1.5rem;">
                    {{ item.subtotal|stringformat:".3f" }}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4">
                  {% trans "لا توجد بنود في هذه الفاتورة." %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot class="bg-light">
            <tr>
              <td colspan="3" class="text-end text-muted small fw-bold text-uppercase py-3">
                {% trans "الإجمالي الكلي" %}
              </td>
              <td class="text-end fw-bold fs-5 text-dark py-3" style="padding-right: 1.5rem;">
                {{ invoice.total_amount|intcomma }} <small class="fs-6 text-muted">OMR</small>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  {% if invoice.description or invoice.terms %}
    <div class="row g-3">
      {% if invoice.description %}
      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-muted small fw-bold mb-2">{% trans "ملاحظات" %}</h6>
            <p class="mb-0 small text-dark">{{ invoice.description|linebreaksbr }}</p>
          </div>
        </div>
      </div>
      {% endif %}
      
      {% if invoice.terms %}
      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-muted small fw-bold mb-2">{% trans "الشروط والأحكام" %}</h6>
            <p class="mb-0 small text-dark">{{ invoice.terms|linebreaksbr }}</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  {% endif %}

  {# المرفقات #}
  <div class="mt-4">
      {% include "core/attachments/_panel.html" %}
  </div>

</div>
{% endblock %}

{% load i18n %}
<!doctype html>
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_CODE == 'ar' %}rtl{% else %}ltr{% endif %}">
<head>
  <meta charset="utf-8">
  <title>
    {% blocktrans with number=invoice.display_number %}فاتورة {{ number }}{% endblocktrans %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {# Bootstrap RTL #}
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.rtl.min.css">
</head>
<body class="bg-light">

<div class="container my-4">
  <div class="card shadow-sm">
    <div class="card-body">

      {# الهيدر #}
      <div class="row mb-4">
        <div class="col-md-7">
          <h1 class="h4 fw-bold mb-1 text-dark">Mazoon Aluminum</h1>
          <p class="mb-0 small text-muted">
            {% trans "سلطنة عمان – ورشة/شركة الألمنيوم" %}<br>
            {% trans "هاتف:" %} +968-00000000<br>
            {% trans "بريد إلكتروني:" %} info@example.com
          </p>
        </div>

        <div class="col-md-5 text-md-start text-end">
          <h2 class="h5 fw-bold mb-2 text-dark">{% trans "فاتورة" %}</h2>
          <div class="small text-muted">
            <div class="mb-1">
              <span class="fw-semibold text-dark">{% trans "رقم الفاتورة:" %}</span>
              <span>{{ invoice.display_number }}</span>
            </div>
            <div class="mb-1">
              <span class="fw-semibold text-dark">{% trans "تاريخ الإصدار:" %}</span>
              <span>{{ invoice.issued_at }}</span>
            </div>
            <div class="mb-1">
              <span class="fw-semibold text-dark">{% trans "تاريخ الاستحقاق:" %}</span>
              <span>{{ invoice.due_date|default:"-" }}</span>
            </div>
            <div class="mb-1">
              <span class="fw-semibold text-dark">{% trans "الحالة:" %}</span>
              <span>{{ invoice.get_status_display }}</span>
              {% if invoice.status == invoice.Status.PAID %}
                <span class="badge bg-success ms-1">{% trans "مدفوعة" %}</span>
              {% elif invoice.status == invoice.Status.PARTIALLY_PAID %}
                <span class="badge bg-warning text-dark ms-1">{% trans "مدفوعة جزئياً" %}</span>
              {% elif invoice.status == invoice.Status.CANCELLED %}
                <span class="badge bg-secondary ms-1">{% trans "ملغاة" %}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {# بيانات العميل / المورد #}
      <div class="mb-4">
        <h6 class="fw-bold small text-dark mb-2">
          {% if invoice.type == "purchase" %}
            {% trans "بيانات المورد" %}
          {% else %}
            {% trans "بيانات العميل" %}
          {% endif %}
        </h6>

        <div class="border rounded-3 p-3 bg-light small">
          {% if invoice.customer %}
            <div class="mb-1">
              <span class="fw-semibold">{% trans "الاسم:" %}</span>
              <span>{{ invoice.customer.name }}</span>
            </div>
            {% if invoice.customer.company_name %}
              <div class="mb-1">
                <span class="fw-semibold">{% trans "الشركة:" %}</span>
                <span>{{ invoice.customer.company_name }}</span>
              </div>
            {% endif %}
            {% if invoice.customer.tax_number %}
              <div class="mb-1">
                <span class="fw-semibold">{% trans "الرقم الضريبي:" %}</span>
                <span>{{ invoice.customer.tax_number }}</span>
              </div>
            {% endif %}
            {% if invoice.customer.phone %}
              <div class="mb-0">
                <span class="fw-semibold">{% trans "الهاتف:" %}</span>
                <span>{{ invoice.customer.phone }}</span>
              </div>
            {% endif %}
          {% else %}
            <p class="mb-0 text-muted">
              {% trans "لم يتم ربط الفاتورة بأي عميل/مورد." %}
            </p>
          {% endif %}
        </div>
      </div>

      {# ملخص الفاتورة #}
      <div class="mb-4">
        <h6 class="fw-bold small text-dark mb-2">
          {% trans "ملخص الفاتورة" %}
        </h6>

        <div class="row justify-content-end">
          <div class="col-md-6 col-lg-5">
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <th class="small text-muted">{% trans "إجمالي الفاتورة" %}</th>
                  <td class="text-end fw-semibold">{{ invoice.total_amount }}</td>
                </tr>
                <tr>
                  <th class="small text-muted">{% trans "إجمالي المدفوع" %}</th>
                  <td class="text-end fw-semibold">{{ invoice.paid_amount }}</td>
                </tr>
                <tr>
                  <th class="small text-muted">{% trans "المتبقي" %}</th>
                  <td class="text-end fw-semibold">{{ invoice.balance }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {# بنود الفاتورة #}
      <div class="mb-4">
        <h6 class="fw-bold small text-dark mb-2">
          {% trans "بنود الفاتورة" %}
        </h6>

        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle mb-0">
            <thead class="table-light small text-muted">
              <tr>
                <th>{% trans "المنتج" %}</th>
                <th>{% trans "الوصف" %}</th>
                <th class="text-center">{% trans "الكمية" %}</th>
                <th class="text-center">{% trans "سعر الوحدة" %}</th>
                <th class="text-end">{% trans "الإجمالي" %}</th>
              </tr>
            </thead>
            <tbody class="small">
              {% for item in invoice.items.all %}
                <tr>
                  <td>
                    {% if item.product %}
                      {{ item.product.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if item.description %}
                      {{ item.description }}
                    {% elif item.product %}
                      {{ item.product.description }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {{ item.quantity }}
                  </td>
                  <td class="text-center">
                    {{ item.unit_price }}
                  </td>
                  <td class="text-end fw-semibold">
                    {{ item.subtotal }}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted py-4">
                    {% trans "لا توجد بنود في هذه الفاتورة." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      {# الوصف / الشروط #}
      {% if invoice.description or invoice.terms %}
        <div class="row mb-4 small">
          {% if invoice.description %}
            <div class="col-md-6 mb-3 mb-md-0">
              <h6 class="fw-bold small text-dark mb-2">
                {% trans "الوصف / التفاصيل" %}
              </h6>
              <div class="border rounded-3 p-3 bg-light">
                {{ invoice.description|linebreaksbr }}
              </div>
            </div>
          {% endif %}
          {% if invoice.terms %}
            <div class="col-md-6">
              <h6 class="fw-bold small text-dark mb-2">
                {% trans "الشروط والأحكام" %}
              </h6>
              <div class="border rounded-3 p-3 bg-light">
                {{ invoice.terms|linebreaksbr }}
              </div>
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# جدول الدفعات #}
      <div class="mb-3">
        <h6 class="fw-bold small text-dark mb-2">
          {% trans "الدفعات على هذه الفاتورة" %}
        </h6>
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle mb-0">
            <thead class="table-light small text-muted">
              <tr>
                <th>{% trans "التاريخ" %}</th>
                <th>{% trans "المبلغ" %}</th>
                <th>{% trans "الطريقة" %}</th>
                <th>{% trans "ملاحظات" %}</th>
              </tr>
            </thead>
            <tbody class="small">
              {% for p in invoice.payments.all %}
                <tr>
                  <td>{{ p.date }}</td>
                  <td>{{ p.amount }}</td>
                  <td>
                    {% if p.method %}
                      {{ p.method.name }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if p.description %}
                      {{ p.description }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">
                    {% trans "لا توجد دفعات مسجلة على هذه الفاتورة." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <p class="small text-muted text-center mt-3 d-print-none">
        {% trans "يمكنك استخدام أمر الطباعة في المتصفح (Ctrl + P) ثم اختيار" %}
        <strong>Save as PDF</strong>.
      </p>

    </div>
  </div>
</div>

{# فعّل السطر التالي لو تحب تفتح نافذة الطباعة مباشرة #}
{# <script>window.print();</script> #}

</body>
</html>

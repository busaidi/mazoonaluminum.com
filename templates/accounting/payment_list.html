{% extends "base.html" %}
{% load i18n %}

{% block meta_title %}{% trans "الدفعات" %}{% endblock %}

{% block content %}
<div class="py-4">

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h1 class="h4 mb-0">{% trans "الدفعات" %}</h1>

    <a href="{% url 'accounting:payment_create' %}" class="btn btn-primary btn-sm">
      {% trans "إضافة دفعة جديدة" %}
    </a>
  </div>

  <!-- فلاتر -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="text"
             name="customer"
             value="{{ customer_filter }}"
             class="form-control form-control-sm"
             placeholder="{% trans 'بحث بالعميل' %}">
    </div>

    <div class="col-md-3">
      <select name="method" class="form-select form-select-sm">
        <option value="">{% trans "كل طرق الدفع" %}</option>
        {% for code, label in payments.model.Method.choices %}
          <option value="{{ code }}" {% if code == method_filter %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary btn-sm w-100">{% trans "بحث" %}</button>
    </div>
  </form>

  <!-- جدول الدفعات -->
  <div class="card p-3">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>{% trans "التاريخ" %}</th>
            <th>{% trans "العميل" %}</th>
            <th>{% trans "المبلغ" %}</th>
            <th>{% trans "الطريقة" %}</th>
            <th>{% trans "الفاتورة" %}</th>
            <th>{% trans "ملاحظات" %}</th>
            <th class="text-end">{% trans "إجراءات" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr>
            <td>{{ p.date }}</td>
            <td>
              <a href="{% url 'accounting:customer_detail' p.customer.pk %}">
                {{ p.customer.name }}
              </a>
            </td>
            <td><strong>{{ p.amount }}</strong></td>
            <td>{{ p.get_method_display }}</td>
            <td>
              {% if p.invoice %}
                <a href="{% url 'accounting:invoice_detail' p.invoice.number %}">
                  {{ p.invoice.number }}
                </a>
              {% else %}
                <span class="text-muted">{% trans "دفعة عامة" %}</span>
              {% endif %}
            </td>
            <td>{{ p.notes|default:"-" }}</td>
            <td class="text-end">
              {% if not p.invoice %}
                <a href="{% url 'accounting:payment_apply' p.pk %}"
                   class="btn btn-outline-primary btn-sm">
                  {% trans "تسوية" %}
                </a>
              {% else %}
                <span class="text-muted small">
                  {% trans "مربوطة بفاتورة" %}
                </span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              {% trans "لا توجد دفعات" %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <div class="mt-3 d-flex justify-content-center">
        <nav>
          <ul class="pagination pagination-sm">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&customer={{ customer_filter }}&method={{ method_filter }}">
                  &laquo;
                </a>
              </li>
            {% endif %}

            {% for num in paginator.page_range %}
              <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link"
                   href="?page={{ num }}&customer={{ customer_filter }}&method={{ method_filter }}">
                  {{ num }}
                </a>
              </li>
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&customer={{ customer_filter }}&method={{ method_filter }}">
                  &raquo;
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}

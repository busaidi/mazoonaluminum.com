{% extends "base.html" %}
{% load i18n %}

{% block meta_title %}{% trans "طلب جديد" %} | Mazoon Aluminum{% endblock %}
{% block meta_description %}{% trans "إنشاء أو تعديل طلب زبون مع بنود متعددة." %}{% endblock %}

{% block content %}
<div class="py-4">
  {% include "accounting/_nav.html" %}

  <!-- عنوان الصفحة + رجوع -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h5 mb-1">
        {% if object %}
          {% blocktrans with serial=object.serial %}تعديل طلب #{{ serial }}{% endblocktrans %}
        {% else %}
          {% trans "طلب جديد" %}
        {% endif %}
      </h1>
      <p class="text-muted small mb-0">
        {% trans "إدارة طلبات الزبائن مع إمكانية إضافة بنود من المنتجات أو كبنود حرة." %}
      </p>
    </div>
    <a href="{% url 'accounting:order_list' %}" class="btn btn-outline-secondary btn-sm">
      {% trans "رجوع إلى الطلبات" %}
    </a>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- بطاقة بيانات الطلب الأساسية -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">
              {% trans "الزبون" %}
            </label>
            {{ form.customer }}
            {% for error in form.customer.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              {% trans "الحالة" %}
            </label>
            {{ form.status }}
            {% for error in form.status.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">
              {% trans "ملاحظات داخلية" %}
            </label>
            {{ form.notes }}
            {% for error in form.notes.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
            <div class="form-text">
              {% trans "هذه الملاحظات لا تظهر للزبون، وتستخدم فقط لأغراض داخلية." %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- بنود الطلب -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center bg-light">
        <span class="fw-semibold">
          {% trans "بنود الطلب" %}
        </span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-row-btn">
          + {% trans "بند جديد" %}
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0 invoice-items-table align-middle">
            <thead class="table-light">
              <tr>
                <th class="product-col small text-muted">{% trans "المنتج" %}</th>
                <th class="small text-muted">{% trans "وحدة القياس" %}</th>
                <th class="desc-col small text-muted">{% trans "الوصف الحر" %}</th>
                <th class="qty-col small text-muted">{% trans "الكمية" %}</th>
                <th class="price-col small text-muted">{% trans "سعر الوحدة" %}</th>
                <th class="total-col small text-muted">{% trans "الإجمالي" %}</th>
                <th class="small text-muted text-center">{% trans "حذف" %}</th>
              </tr>
            </thead>
            <tbody id="order-items-body">
              {{ item_formset.management_form }}
              {{ item_formset.non_form_errors }}

              {% for formset_form in item_formset %}
                <tr class="order-item-row">
                  {{ formset_form.id }}

                  <td>
                    {{ formset_form.product }}
                    {% for error in formset_form.product.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  <td style="max-width: 140px;">
                    {{ formset_form.uom }}
                    {% for error in formset_form.uom.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  <td>
                    {{ formset_form.description }}
                    {% for error in formset_form.description.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  <td class="qty-col" style="max-width: 110px;">
                    {{ formset_form.quantity }}
                    {% for error in formset_form.quantity.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  <td class="price-col" style="max-width: 130px;">
                    {{ formset_form.unit_price }}
                    {% for error in formset_form.unit_price.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  <td class="total-col text-nowrap">
                    <span class="invoice-line-total">0.000</span>
                  </td>

                  <td class="text-center">
                    {% if formset_form.instance.pk %}
                      <label class="small text-danger d-inline-flex align-items-center gap-1">
                        {{ formset_form.DELETE }}
                        {% trans "حذف" %}
                      </label>
                    {% else %}
                      <span class="text-muted small">–</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          {% trans "يمكنك ترك حقل المنتج فارغًا وكتابة وصف حر للبند." %}
        </div>
        <div class="fw-semibold">
          {% trans "إجمالي تقريبي" %}:
          <span id="order-total-preview">0.000</span>
        </div>
      </div>
    </div>

    <!-- أزرار الحفظ -->
    <div class="d-flex justify-content-between align-items-center">
      <div></div>
      <button type="submit" class="btn btn-primary">
        {% trans "حفظ الطلب" %}
      </button>
    </div>
  </form>
</div>

<script>
  // PRODUCTS is a mapping from product id → config:
  // {
  //   "1": { price, description, uom_id, allowed_uoms: [base_uom, alt_uom?] },
  //   "2": { ... },
  // }
  const PRODUCTS = {{ products_json|default:"{}"|safe }};

  const itemsBody = document.getElementById("order-items-body");
  const addRowBtn = document.getElementById("add-row-btn");
  const totalPreviewEl = document.getElementById("order-total-preview");

  function updateLineTotals() {
    if (!itemsBody) return;

    let grandTotal = 0.0;

    itemsBody.querySelectorAll("tr.order-item-row").forEach(row => {
      const qtyInput = row.querySelector('input[name$="-quantity"]');
      const priceInput = row.querySelector('input[name$="-unit_price"]');
      const totalSpan = row.querySelector(".invoice-line-total");

      const qty = parseFloat(qtyInput?.value || "0");
      const price = parseFloat(priceInput?.value || "0");
      const total = qty * price;

      if (totalSpan) {
        totalSpan.textContent = isNaN(total) ? "0.000" : total.toFixed(3);
      }
      if (!isNaN(total)) {
        grandTotal += total;
      }
    });

    if (totalPreviewEl) {
      totalPreviewEl.textContent = grandTotal.toFixed(3);
    }
  }

  if (itemsBody) {
    // Live totals
    itemsBody.addEventListener("input", function (e) {
      if (!e.target.name) return;

      if (
        e.target.name.endsWith("quantity") ||
        e.target.name.endsWith("unit_price")
      ) {
        updateLineTotals();
      }
    });

    // Product change → fill price/description/UoM and filter UoMs
    itemsBody.addEventListener("change", function (e) {
      const target = e.target;

      // User cleared product (empty option)
      if (target.tagName === "SELECT" && target.name.endsWith("-product") && !target.value) {
        const row = target.closest("tr");
        if (!row) return;

        const priceInput = row.querySelector('input[name$="-unit_price"]');
        const descInput = row.querySelector('input[name$="-description"]');
        const uomSelect = row.querySelector('select[name$="-uom"]');

        if (priceInput) priceInput.value = "";
        if (descInput) descInput.value = "";
        if (uomSelect) {
          // Show all UoMs again
          Array.from(uomSelect.options).forEach(opt => {
            opt.hidden = false;
          });
          uomSelect.selectedIndex = 0;
        }

        updateLineTotals();
        return;
      }

      // Product selected → auto-fill
      if (target.tagName === "SELECT" && target.name.endsWith("-product")) {
        const productId = target.value;
        const row = target.closest("tr");
        if (!row) return;

        const productData = PRODUCTS[String(productId)];
        if (!productData) {
          updateLineTotals();
          return;
        }

        const priceInput = row.querySelector('input[name$="-unit_price"]');
        const descInput = row.querySelector('input[name$="-description"]');
        const uomSelect = row.querySelector('select[name$="-uom"]');

        // 1) price from default_sale_price
        if (priceInput) {
          const p = parseFloat(productData.price);
          priceInput.value = isNaN(p) ? "" : p.toFixed(3);
        }

        // 2) description (only if empty so user override is respected)
        if (descInput && !descInput.value) {
          descInput.value = productData.description || "";
        }

        // 3) filter UoM options: base_uom + alt_uom only
        if (uomSelect) {
          const allowedRaw = Array.isArray(productData.allowed_uoms)
            ? productData.allowed_uoms
            : [];

          const allowedSet = new Set(allowedRaw.map(v => String(v)));

          Array.from(uomSelect.options).forEach(opt => {
            if (!opt.value) {
              // Keep the empty option always visible
              opt.hidden = false;
              return;
            }
            // Hide everything not in allowed list
            opt.hidden = !allowedSet.has(opt.value);
          });

          // 4) select default UoM (base_uom)
          if (productData.uom_id) {
            const targetValue = String(productData.uom_id);
            if (allowedSet.has(targetValue)) {
              uomSelect.value = targetValue;
            } else {
              // Fallback: first visible option
              const firstVisible = Array.from(uomSelect.options).find(opt => !opt.hidden);
              if (firstVisible) {
                uomSelect.value = firstVisible.value;
              }
            }
          } else {
            // No default: pick first visible
            const firstVisible = Array.from(uomSelect.options).find(opt => !opt.hidden);
            if (firstVisible) {
              uomSelect.value = firstVisible.value;
            }
          }
        }

        updateLineTotals();
      }
    });
  }

  // Add new row from formset template
  if (addRowBtn && itemsBody) {
    addRowBtn.addEventListener("click", function (e) {
      e.preventDefault();
      const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
      if (!totalFormsInput) return;

      const prefix = totalFormsInput.name.replace("-TOTAL_FORMS", "");
      const totalForms = parseInt(totalFormsInput.value, 10);

      const templateRow = itemsBody.querySelector("tr.order-item-row");
      if (!templateRow) return;

      let newRowHtml = templateRow.outerHTML;

      const regex = new RegExp(prefix + "-(\\d+)-", "g");
      newRowHtml = newRowHtml.replace(regex, prefix + "-" + totalForms + "-");

      const tempDiv = document.createElement("tbody");
      tempDiv.innerHTML = newRowHtml;
      const newRow = tempDiv.querySelector("tr.order-item-row");

      if (newRow) {
        newRow.querySelectorAll("input, select, textarea").forEach(input => {
          if (input.type === "checkbox" || input.type === "radio") {
            input.checked = false;
          } else {
            input.value = "";
          }
        });

        const totalSpan = newRow.querySelector(".invoice-line-total");
        if (totalSpan) {
          totalSpan.textContent = "0.000";
        }

        itemsBody.appendChild(newRow);
        totalFormsInput.value = totalForms + 1;
        updateLineTotals();
      }
    });
  }

  // Initial totals on page load
  updateLineTotals();
</script>



{% endblock %}

{% extends "inventory/base_inventory.html" %}
{% load i18n %}

{% block title %}
  {% if object %}
    {% trans "تعديل حركة مخزون" %}
  {% else %}
    {% trans "حركة مخزون جديدة" %}
  {% endif %}
{% endblock %}

{% block inventory_content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 fw-bold mb-1">
      {% if object %}
        {% trans "تعديل حركة مخزون" %}
      {% else %}
        {% trans "حركة مخزون جديدة" %}
      {% endif %}
    </h1>
    <p class="text-muted small mb-0">
      {% trans "قم بتسجيل حركة دخول، خروج، أو تحويل بين المخازن والمواقع." %}
    </p>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body">

    <form method="post" novalidate>
      {% csrf_token %}

      {# أخطاء عامة للفورم #}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="row g-3">

        {# المنتج + نوع الحركة + الحالة #}
        <div class="col-md-6">
          <label class="form-label" for="{{ form.product.id_for_label }}">
            {{ form.product.label }}
          </label>
          {{ form.product }}
          {% for error in form.product.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label" for="{{ form.move_type.id_for_label }}">
            {{ form.move_type.label }}
          </label>
          {{ form.move_type }}
          <div class="form-text">
            {% trans "اختر نوع الحركة: دخول، خروج، أو تحويل." %}
          </div>
          {% for error in form.move_type.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label" for="{{ form.status.id_for_label }}">
            {{ form.status.label }}
          </label>
          {{ form.status }}
          <div class="form-text">
            {% trans "يمكن حفظ الحركة كمسودة أو اعتمادها مباشرة." %}
          </div>
          {% for error in form.status.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        {# بيانات المصدر (from_) #}
        <div class="col-12">
          <hr class="my-2">
        </div>

        <div class="col-md-6" id="stockmove-from-group">
          <h6 class="fw-bold mb-2">{% trans "المصدر (من)" %}</h6>

          <div class="mb-2">
            <label class="form-label" for="{{ form.from_warehouse.id_for_label }}">
              {{ form.from_warehouse.label }}
            </label>
            {{ form.from_warehouse }}
            {% for error in form.from_warehouse.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-2">
            <label class="form-label" for="{{ form.from_location.id_for_label }}">
              {{ form.from_location.label }}
            </label>
            {{ form.from_location }}
            {% for error in form.from_location.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        {# بيانات الوجهة (to_) #}
        <div class="col-md-6" id="stockmove-to-group">
          <h6 class="fw-bold mb-2">{% trans "الوجهة (إلى)" %}</h6>

          <div class="mb-2">
            <label class="form-label" for="{{ form.to_warehouse.id_for_label }}">
              {{ form.to_warehouse.label }}
            </label>
            {{ form.to_warehouse }}
            {% for error in form.to_warehouse.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-2">
            <label class="form-label" for="{{ form.to_location.id_for_label }}">
              {{ form.to_location.label }}
            </label>
            {{ form.to_location }}
            {% for error in form.to_location.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <hr class="my-2">
        </div>

        {# الكمية + وحدة القياس + التاريخ #}
        <div class="col-md-4">
          <label class="form-label" for="{{ form.quantity.id_for_label }}">
            {{ form.quantity.label }}
          </label>
          {{ form.quantity }}
          {% for error in form.quantity.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label" for="{{ form.uom.id_for_label }}">
            {{ form.uom.label }}
          </label>
          {{ form.uom }}
          {% for error in form.uom.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label" for="{{ form.move_date.id_for_label }}">
            {{ form.move_date.label }}
          </label>
          {{ form.move_date }}
          {% for error in form.move_date.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        {# مرجع + ملاحظات #}
        <div class="col-md-6">
          <label class="form-label" for="{{ form.reference.id_for_label }}">
            {{ form.reference.label }}
          </label>
          {{ form.reference }}
          {% for error in form.reference.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label" for="{{ form.note.id_for_label }}">
            {{ form.note.label }}
          </label>
          {{ form.note }}
          {% for error in form.note.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

      </div>

      <div class="mt-4 d-flex justify-content-between">
        <a href="{% url 'inventory:move_list' %}" class="btn btn-link">
          {% trans "رجوع إلى حركات المخزون" %}
        </a>
        <button type="submit" class="btn btn-primary">
          {% trans "حفظ" %}
        </button>
      </div>

    </form>
  </div>
</div>

{# === جافاسكربت للتحكم في حقول from/to حسب نوع الحركة === #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const moveTypeSelect = document.getElementById("id_move_type");
    const fromGroup = document.getElementById("stockmove-from-group");
    const toGroup = document.getElementById("stockmove-to-group");

    const fromWarehouse = document.getElementById("id_from_warehouse");
    const fromLocation = document.getElementById("id_from_location");
    const toWarehouse = document.getElementById("id_to_warehouse");
    const toLocation = document.getElementById("id_to_location");

    function setRequired(field, required) {
      if (!field) return;
      if (required) {
        field.setAttribute("required", "required");
      } else {
        field.removeAttribute("required");
      }
    }

    function clearField(field) {
      if (!field) return;
      if (field.tagName === "SELECT") {
        field.selectedIndex = 0;  // يخليها على الخيار الفارغ الأول
      } else {
        field.value = "";
      }
    }

    function updateMoveFields() {
      if (!moveTypeSelect) return;

      const value = moveTypeSelect.value;

      if (value === "in") {
        // حركة دخول: نركز على الوجهة فقط
        if (fromGroup) fromGroup.style.display = "none";
        if (toGroup) toGroup.style.display = "";

        clearField(fromWarehouse);
        clearField(fromLocation);
        setRequired(fromWarehouse, false);
        setRequired(fromLocation, false);

        setRequired(toWarehouse, true);
        setRequired(toLocation, true);

      } else if (value === "out") {
        // حركة خروج: نركز على المصدر فقط
        if (fromGroup) fromGroup.style.display = "";
        if (toGroup) toGroup.style.display = "none";

        clearField(toWarehouse);
        clearField(toLocation);
        setRequired(toWarehouse, false);
        setRequired(toLocation, false);

        setRequired(fromWarehouse, true);
        setRequired(fromLocation, true);

      } else if (value === "transfer") {
        // تحويل: نحتاج المصدر والوجهة
        if (fromGroup) fromGroup.style.display = "";
        if (toGroup) toGroup.style.display = "";

        setRequired(fromWarehouse, true);
        setRequired(fromLocation, true);
        setRequired(toWarehouse, true);
        setRequired(toLocation, true);
      }
    }

    if (moveTypeSelect) {
      // في أول تحميل للصفحة
      updateMoveFields();
      // عند تغيير نوع الحركة
      moveTypeSelect.addEventListener("change", updateMoveFields);
    }
  });
</script>

{% endblock %}

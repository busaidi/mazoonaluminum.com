{% extends "inventory/base_inventory.html" %}
{% load i18n %}

{% block title %}
  {% if object %}
    {% trans "تعديل حركة مخزون" %}
  {% else %}
    {% trans "حركة مخزون جديدة" %}
  {% endif %}
{% endblock %}

{% block inventory_content %}

{# ───── هيدر Mazoon للفورم ───── #}
<div class="card border-0 shadow-sm mb-3 bg-mazoon-card">
  <div class="card-body d-flex justify-content-between align-items-center gap-3">
    <div>
      <h1 class="h5 fw-bold mb-1 text-mazoon">
        {% if object %}
          {% trans "تعديل حركة مخزون" %}
        {% else %}
          {% trans "حركة مخزون جديدة" %}
        {% endif %}
      </h1>
      <p class="text-muted small mb-0">
        {% trans "سجّل حركة إدخال، إخراج، أو تحويل بين المخازن والمواقع مع إمكانية إضافة عدة منتجات في نفس الحركة." %}
      </p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'inventory:move_list' %}"
         class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-right-short ms-1"></i>
        {% trans "رجوع إلى الحركات" %}
      </a>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body">

    <form method="post" novalidate>
      {% csrf_token %}

      {# أخطاء عامة لفورم الهيدر #}
      {% if form.non_field_errors %}
        <div class="alert alert-danger small">
          {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="row g-3">

        {# نوع الحركة + الحالة + التاريخ #}
        <div class="col-md-4">
          <label class="form-label small fw-semibold" for="{{ form.move_type.id_for_label }}">
            {{ form.move_type.label }}
          </label>
          {{ form.move_type }}
          <div class="form-text small">
            {% trans "اختر نوع الحركة: إدخال، إخراج، أو تحويل." %}
          </div>
          {% for error in form.move_type.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label small fw-semibold" for="{{ form.status.id_for_label }}">
            {{ form.status.label }}
          </label>
          {{ form.status }}
          <div class="form-text small">
            {% trans "يمكن حفظ الحركة كمسودة أو اعتمادها مباشرة." %}
          </div>
          {% for error in form.status.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label small fw-semibold" for="{{ form.move_date.id_for_label }}">
            {{ form.move_date.label }}
          </label>
          {{ form.move_date }}
          {% for error in form.move_date.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-12">
          <hr class="my-2">
        </div>

        {# بيانات المصدر (from_) #}
        <div class="col-md-6" id="stockmove-from-group">
          <h6 class="fw-bold mb-2 small text-uppercase text-muted">
            {% trans "المصدر (من)" %}
          </h6>

          <div class="mb-2">
            <label class="form-label small fw-semibold" for="{{ form.from_warehouse.id_for_label }}">
              {{ form.from_warehouse.label }}
            </label>
            {{ form.from_warehouse }}
            {% for error in form.from_warehouse.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-2">
            <label class="form-label small fw-semibold" for="id_from_location">
              {{ form.from_location.label }}
            </label>
            <select name="from_location" id="id_from_location" class="form-select form-select-sm">
              <option value="">{% trans "اختر موقعاً" %}</option>
              {% with current_from=form.from_location.value %}
                {% for loc in form.from_location.field.queryset %}
                  <option value="{{ loc.pk }}"
                          data-warehouse="{{ loc.warehouse_id }}"
                          {% if current_from|stringformat:"s" == loc.pk|stringformat:"s" %}selected{% endif %}>
                    {{ loc.code }} — {{ loc.name }} ({{ loc.warehouse.name }})
                  </option>
                {% endfor %}
              {% endwith %}
            </select>
            {% for error in form.from_location.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        {# بيانات الوجهة (to_) #}
        <div class="col-md-6" id="stockmove-to-group">
          <h6 class="fw-bold mb-2 small text-uppercase text-muted">
            {% trans "الوجهة (إلى)" %}
          </h6>

          <div class="mb-2">
            <label class="form-label small fw-semibold" for="{{ form.to_warehouse.id_for_label }}">
              {{ form.to_warehouse.label }}
            </label>
            {{ form.to_warehouse }}
            {% for error in form.to_warehouse.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-2">
            <label class="form-label small fw-semibold" for="id_to_location">
              {{ form.to_location.label }}
            </label>
            <select name="to_location" id="id_to_location" class="form-select form-select-sm">
              <option value="">{% trans "اختر موقعاً" %}</option>
              {% with current_to=form.to_location.value %}
                {% for loc in form.to_location.field.queryset %}
                  <option value="{{ loc.pk }}"
                          data-warehouse="{{ loc.warehouse_id }}"
                          {% if current_to|stringformat:"s" == loc.pk|stringformat:"s" %}selected{% endif %}>
                    {{ loc.code }} — {{ loc.name }} ({{ loc.warehouse.name }})
                  </option>
                {% endfor %}
              {% endwith %}
            </select>
            {% for error in form.to_location.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <hr class="my-3">
        </div>

        {# مرجع + ملاحظات #}
        <div class="col-md-6">
          <label class="form-label small fw-semibold" for="{{ form.reference.id_for_label }}">
            {{ form.reference.label }}
          </label>
          {{ form.reference }}
          {% for error in form.reference.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label small fw-semibold" for="{{ form.note.id_for_label }}">
            {{ form.note.label }}
          </label>
          {{ form.note }}
          {% for error in form.note.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

      </div>

      {# ───── بنود الحركة (Formset) ───── #}
      <div class="mt-4">
        <h5 class="h6 fw-bold mb-2">
          {% trans "بنود الحركة (المنتجات)" %}
        </h5>

        {% if line_formset.non_form_errors %}
          <div class="alert alert-danger small">
            {% for error in line_formset.non_form_errors %}
              <div>{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}

        {{ line_formset.management_form }}

        <div class="table-responsive border rounded">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 45%;">{% trans "المنتج" %}</th>
                <th style="width: 15%;">{% trans "الكمية" %}</th>
                <th style="width: 15%;">{% trans "وحدة القياس" %}</th>
                <th style="width: 20%;">{% trans "ملاحظات البند" %}</th>
                <th style="width: 5%;" class="text-center">{% trans "حذف" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for line_form in line_formset %}
                <tr class="stockmove-line-row">
                  {# الحقول المخفية (id, move, ...) #}
                  {% for hidden in line_form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}

                  {# المنتج مع data-base-uom و data-alt-uom #}
                  <td>
                    <select name="{{ line_form.product.html_name }}"
                            id="{{ line_form.product.id_for_label }}"
                            class="form-select form-select-sm">
                      <option value="">{% trans "اختر منتجاً" %}</option>
                      {% with current_prod=line_form.product.value %}
                        {% for p in line_form.product.field.queryset %}
                          <option value="{{ p.pk }}"
                                  data-base-uom="{{ p.base_uom_id }}"
                                  data-alt-uom="{{ p.alt_uom_id|default_if_none:'' }}"
                                  {% if current_prod|stringformat:"s" == p.pk|stringformat:"s" %}selected{% endif %}>
                            {{ p.code }} — {{ p.name }}
                          </option>
                        {% endfor %}
                      {% endwith %}
                    </select>
                    {% for error in line_form.product.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  {# الكمية #}
                  <td>
                    {{ line_form.quantity }}
                    {% for error in line_form.quantity.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  {# وحدة القياس #}
                  <td>
                    {{ line_form.uom }}
                    {% for error in line_form.uom.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </td>

                  {# ملاحظات البند إن وُجد الحقل #}
                  <td>
                    {% if line_form.line_note %}
                      {{ line_form.line_note }}
                      {% for error in line_form.line_note.errors %}
                        <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    {% else %}
                      <span class="text-muted small">—</span>
                    {% endif %}
                  </td>

                  {# حذف السطر #}
                  <td class="text-center">
                    {% if line_form.DELETE %}
                      <div class="form-check d-flex justify-content-center">
                        {{ line_form.DELETE }}
                      </div>
                    {% endif %}
                  </td>
                </tr>

                {% if line_form.non_field_errors %}
                  <tr>
                    <td colspan="5">
                      {% for error in line_form.non_field_errors %}
                        <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        {# لاحقاً ممكن نضيف زر JS لإضافة صفوف ديناميكية #}
      </div>

      <div class="mt-4 d-flex justify-content-between align-items-center">
        <a href="{% url 'inventory:move_list' %}" class="btn btn-link">
          {% trans "رجوع إلى حركات المخزون" %}
        </a>
        <button type="submit" class="btn btn-primary">
          {% if object %}
            <i class="bi bi-save ms-1"></i>
            {% trans "حفظ التعديلات" %}
          {% else %}
            <i class="bi bi-check2-circle ms-1"></i>
            {% trans "حفظ الحركة" %}
          {% endif %}
        </button>
      </div>

    </form>
  </div>
</div>

{# ───── جافاسكربت: منطق نوع الحركة + فلترة المواقع + ربط UoM بالبند ───── #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const moveTypeSelect = document.getElementById("id_move_type");
    const fromGroup = document.getElementById("stockmove-from-group");
    const toGroup = document.getElementById("stockmove-to-group");

    const fromWarehouse = document.getElementById("id_from_warehouse");
    const fromLocation = document.getElementById("id_from_location");
    const toWarehouse = document.getElementById("id_to_warehouse");
    const toLocation = document.getElementById("id_to_location");

    function setRequired(field, required) {
      if (!field) return;
      if (required) {
        field.setAttribute("required", "required");
      } else {
        field.removeAttribute("required");
      }
    }

    function clearField(field) {
      if (!field) return;
      if (field.tagName === "SELECT") {
        field.selectedIndex = 0;
      } else {
        field.value = "";
      }
    }

    // فلترة المواقع حسب المخزن
    function filterLocations(warehouseSelect, locationSelect) {
      if (!warehouseSelect || !locationSelect) return;

      const whId = warehouseSelect.value;

      Array.from(locationSelect.options).forEach(function (opt) {
        if (!opt.value) {
          opt.hidden = false;
          opt.disabled = false;
          return;
        }

        const optWhId = opt.getAttribute("data-warehouse");

        if (!whId) {
          opt.hidden = true;
          opt.disabled = true;
        } else {
          const match = (optWhId === whId);
          opt.hidden = !match;
          opt.disabled = !match;
        }
      });

      const selected = locationSelect.options[locationSelect.selectedIndex];
      if (selected && selected.hidden) {
        locationSelect.value = "";
      }
    }

    function updateMoveFields() {
      if (!moveTypeSelect) return;

      const value = moveTypeSelect.value;

      if (value === "in") {
        if (fromGroup) fromGroup.style.display = "none";
        if (toGroup) toGroup.style.display = "";

        clearField(fromWarehouse);
        clearField(fromLocation);
        setRequired(fromWarehouse, false);
        setRequired(fromLocation, false);

        setRequired(toWarehouse, true);
        setRequired(toLocation, true);

      } else if (value === "out") {
        if (fromGroup) fromGroup.style.display = "";
        if (toGroup) toGroup.style.display = "none";

        clearField(toWarehouse);
        clearField(toLocation);
        setRequired(toWarehouse, false);
        setRequired(toLocation, false);

        setRequired(fromWarehouse, true);
        setRequired(fromLocation, true);

      } else if (value === "transfer") {
        if (fromGroup) fromGroup.style.display = "";
        if (toGroup) toGroup.style.display = "";

        setRequired(fromWarehouse, true);
        setRequired(fromLocation, true);
        setRequired(toWarehouse, true);
        setRequired(toLocation, true);
      }

      filterLocations(fromWarehouse, fromLocation);
      filterLocations(toWarehouse, toLocation);
    }

    // أول تحميل
    filterLocations(fromWarehouse, fromLocation);
    filterLocations(toWarehouse, toLocation);

    if (fromWarehouse) {
      fromWarehouse.addEventListener("change", function () {
        filterLocations(fromWarehouse, fromLocation);
      });
    }

    if (toWarehouse) {
      toWarehouse.addEventListener("change", function () {
        filterLocations(toWarehouse, toLocation);
      });
    }

    if (moveTypeSelect) {
      updateMoveFields();
      moveTypeSelect.addEventListener("change", updateMoveFields);
    }

    // ============================
    // ربط وحدة القياس بوحدة المنتج في البنود
    // ============================

    function updateLineUomForRow(row) {
      const productSelect = row.querySelector('select[name$="-product"]');
      const uomSelect = row.querySelector('select[name$="-uom"]');

      if (!productSelect || !uomSelect) return;

      const selectedOpt = productSelect.options[productSelect.selectedIndex];
      if (!selectedOpt || !selectedOpt.value) {
        Array.from(uomSelect.options).forEach(function (opt) {
          opt.hidden = false;
          opt.disabled = false;
        });
        return;
      }

      const baseId = selectedOpt.getAttribute("data-base-uom");
      const altId = selectedOpt.getAttribute("data-alt-uom");

      Array.from(uomSelect.options).forEach(function (opt) {
        if (!opt.value) {
          opt.hidden = false;
          opt.disabled = false;
          return;
        }

        const val = opt.value;
        const allowed = (val === baseId) || (altId && val === altId);

        opt.hidden = !allowed;
        opt.disabled = !allowed;
      });

      const selectedIndex = uomSelect.selectedIndex;
      const selectedOptUom = uomSelect.options[selectedIndex];

      const currentAllowed =
        selectedOptUom &&
        !selectedOptUom.hidden &&
        !selectedOptUom.disabled;

      if (!currentAllowed) {
        if (baseId) {
          uomSelect.value = baseId;
        } else {
          uomSelect.value = "";
        }
      }
    }

    function initLinesUom() {
      const rows = document.querySelectorAll("tr.stockmove-line-row");

      rows.forEach(function (row) {
        updateLineUomForRow(row);

        const productSelect = row.querySelector('select[name$="-product"]');
        if (productSelect) {
          productSelect.addEventListener("change", function () {
            updateLineUomForRow(row);
          });
        }
      });
    }

    initLinesUom();
  });
</script>

{% endblock %}

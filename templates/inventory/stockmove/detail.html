{% extends "inventory/base_inventory.html" %}
{% load i18n %}

{% block title %}{% trans "تفاصيل حركة مخزون" %}{% endblock %}

{% block inventory_content %}

{# ───── هيدر Mazoon لحركة المخزون ───── #}
<div class="card border-0 shadow-sm mb-3 bg-mazoon-card">
  <div class="card-body d-flex justify-content-between align-items-start gap-3">

    <div class="flex-grow-1">
      <div class="d-flex align-items-center gap-2 mb-1">
        <h1 class="h5 fw-bold mb-0 text-mazoon">
          {% trans "حركة مخزون" %}
        </h1>
        <span class="badge bg-light text-muted border small" dir="ltr">
          {{ object.serial|default:object.pk }}
        </span>
      </div>

      <p class="text-muted small mb-0">
        {% trans "عرض تفاصيل الحركة المسجلة على المخازن والمواقع مع جميع البنود المرتبطة بها." %}
      </p>
    </div>

    <div class="d-flex flex-column align-items-end gap-2">

      <div class="d-flex flex-wrap gap-1 justify-content-end">

        {# نوع الحركة #}
        {% if object.move_type == "in" %}
          <span class="badge bg-success-subtle text-success border small">
            {% trans "إدخال" %}
          </span>
        {% elif object.move_type == "out" %}
          <span class="badge bg-danger-subtle text-danger border small">
            {% trans "إخراج" %}
          </span>
        {% elif object.move_type == "transfer" %}
          <span class="badge bg-info-subtle text-info border small">
            {% trans "تحويل" %}
          </span>
        {% else %}
          <span class="badge bg-secondary-subtle text-secondary border small">
            {{ object.get_move_type_display|default:object.move_type }}
          </span>
        {% endif %}

        {# حالة الحركة #}
        {% if object.status == "draft" %}
          <span class="badge badge-mazoon badge-draft small">
            {% trans "مسودة" %}
          </span>
        {% elif object.status == "done" %}
          <span class="badge badge-mazoon badge-confirmed small">
            {% trans "منفذة" %}
          </span>
        {% elif object.status == "cancelled" %}
          <span class="badge badge-mazoon badge-cancelled small">
            {% trans "ملغاة" %}
          </span>
        {% else %}
          <span class="badge bg-light text-muted border small">
            {{ object.get_status_display }}
          </span>
        {% endif %}
      </div>

      <div class="btn-group btn-group-sm" role="group">
        <a href="{% url 'inventory:move_update' object.pk %}"
           class="btn btn-outline-primary">
          <i class="bi bi-pencil-square ms-1"></i>
          {% trans "تعديل" %}
        </a>
        <a href="{% url 'inventory:move_list' %}"
           class="btn btn-outline-secondary">
          <i class="bi bi-arrow-right-short ms-1"></i>
          {% trans "رجوع" %}
        </a>
      </div>

    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">

    {# بطاقة معلومات الحركة #}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 fw-bold mb-3">
          <i class="bi bi-info-circle ms-1"></i>
          {% trans "بيانات الحركة" %}
        </h2>

        <dl class="row mb-0 small">

          <dt class="col-sm-3">{% trans "رقم الحركة" %}</dt>
          <dd class="col-sm-9" dir="ltr">
            {{ object.serial|default:object.pk }}
          </dd>

          <dt class="col-sm-3">{% trans "نوع الحركة" %}</dt>
          <dd class="col-sm-9">
            {% if object.move_type == "in" %}
              {% trans "إدخال" %}
            {% elif object.move_type == "out" %}
              {% trans "إخراج" %}
            {% elif object.move_type == "transfer" %}
              {% trans "تحويل" %}
            {% else %}
              {{ object.get_move_type_display|default:object.move_type }}
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "الحالة" %}</dt>
          <dd class="col-sm-9">
            {% if object.status == "draft" %}
              <span class="badge badge-mazoon badge-draft">
                {% trans "مسودة" %}
              </span>
            {% elif object.status == "done" %}
              <span class="badge badge-mazoon badge-confirmed">
                {% trans "منفذة" %}
              </span>
            {% elif object.status == "cancelled" %}
              <span class="badge badge-mazoon badge-cancelled">
                {% trans "ملغاة" %}
              </span>
            {% else %}
              <span class="badge bg-light text-muted border">
                {{ object.get_status_display }}
              </span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "من مخزن" %}</dt>
          <dd class="col-sm-9">
            {% if object.from_warehouse %}
              <span class="fw-semibold">{{ object.from_warehouse.code }}</span>
              <span class="text-muted small d-block">{{ object.from_warehouse.name }}</span>
              {% if object.from_location %}
                <div class="text-muted small">
                  {{ object.from_location.code }} – {{ object.from_location.name }}
                </div>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "إلى مخزن" %}</dt>
          <dd class="col-sm-9">
            {% if object.to_warehouse %}
              <span class="fw-semibold">{{ object.to_warehouse.code }}</span>
              <span class="text-muted small d-block">{{ object.to_warehouse.name }}</span>
              {% if object.to_location %}
                <div class="text-muted small">
                  {{ object.to_location.code }} – {{ object.to_location.name }}
                </div>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">{% trans "تاريخ الحركة" %}</dt>
          <dd class="col-sm-9">
            {{ object.move_date|date:"Y-m-d H:i" }}
          </dd>

          <dt class="col-sm-3">{% trans "المرجع" %}</dt>
          <dd class="col-sm-9">
            {{ object.reference|default:"-" }}
          </dd>

          <dt class="col-sm-3">{% trans "ملاحظات" %}</dt>
          <dd class="col-sm-9">
            {{ object.note|default:"-"|linebreaksbr }}
          </dd>

          <dt class="col-sm-3">{% trans "إجمالي الكمية" %}</dt>
          <dd class="col-sm-9 fw-semibold">
            {{ object.total_lines_quantity }}
          </dd>

        </dl>
      </div>
    </div>

    {# بطاقة بنود الحركة #}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-light border-0 py-2">
        <h2 class="h6 fw-bold mb-0">
          {% trans "بنود الحركة" %}
        </h2>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>{% trans "المنتج" %}</th>
                <th class="text-end">{% trans "الكمية" %}</th>
                <th>{% trans "وحدة القياس" %}</th>
                <th>{% trans "ملاحظات البند" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for line in object.lines.all %}
                <tr>
                  <td>
                    {{ line.product.code }} – {{ line.product.name }}
                  </td>
                  <td class="text-end fw-semibold">
                    {{ line.quantity }}
                  </td>
                  <td>
                    {% if line.uom %}
                      {{ line.uom.code }} – {{ line.uom.name }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="small">
                    {{ line.note|default:"-"|linebreaksbr }}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-3 small">
                    {% trans "لا توجد بنود مسجلة لهذه الحركة." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  {# العمود الجانبي: معلومات زمنية + ملاحظة #}
  <div class="col-lg-4">
    <aside class="position-sticky" style="top: 80px;">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body small text-muted">
          <h2 class="h6 fw-bold mb-2">
            <i class="bi bi-clock-history ms-1"></i>
            {% trans "معلومات سجلّية" %}
          </h2>
          <p class="mb-1">
            <strong>{% trans "تاريخ الإنشاء" %}:</strong>
            {{ object.created_at|date:"Y-m-d H:i" }}
          </p>
          <p class="mb-0">
            <strong>{% trans "آخر تحديث" %}:</strong>
            {{ object.updated_at|date:"Y-m-d H:i" }}
          </p>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-body small text-muted">
          <h2 class="h6 fw-bold mb-2">
            <i class="bi bi-info-circle ms-1"></i>
            {% trans "ملاحظة" %}
          </h2>
          <p class="mb-0">
            {% trans "يمكن لاحقاً ربط هذه الحركات مع أوامر الشراء، أوامر البيع، والإرجاعات لتحديث المخزون والقيود المحاسبية تلقائياً." %}
          </p>
        </div>
      </div>
    </aside>
  </div>
</div>

{% endblock %}

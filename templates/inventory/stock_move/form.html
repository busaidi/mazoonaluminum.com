{% extends "inventory/base_inventory.html" %}
{% load i18n static %}

{% block inventory_title %}{{ page_title }}{% endblock %}

{% block inventory_content %}
<div class="py-3">

    {# ===================== Header ===================== #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 mb-1 text-gray-800">
                <i class="bi bi-file-earmark-plus me-2 text-{{ move_type_color }}"></i>
                {{ page_title }}
            </h1>
            <p class="text-muted small mb-0">
                {% trans "إنشاء مستند جديد وتحديد البنود." %}
            </p>
        </div>
        <div>
            <a href="{{ list_url }}" class="btn btn-outline-secondary">
                <i class="bi bi-x-lg"></i> {% trans "إلغاء" %}
            </a>
        </div>
    </div>

    {# ===================== Form ===================== #}
    <form method="post" id="stock-move-form" novalidate>
        {% csrf_token %}

        <div class="card shadow-sm mb-4 border-top border-4 border-{{ move_type_color }}-subtle">
            <div class="card-body">

                {# أخطاء عامة للفورم #}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-circle-fill me-2"></i>
                        {{ form.non_field_errors|join:" " }}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-secondary">
                            {{ form.reference.label }}
                        </label>
                        {{ form.reference }}
                        {% if form.reference.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.reference.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-secondary">
                            {{ form.move_date.label }}
                        </label>
                        {{ form.move_date }}
                        {% if form.move_date.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.move_date.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>

                    {# من (المصدر) - لحركات OUT / TRANSFER #}
                    {% if form.from_warehouse %}
                        <div class="col-12">
                            <hr class="my-1 text-muted opacity-25">
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-3 border">
                                <h6 class="text-primary mb-3 small fw-bold text-uppercase">
                                    <i class="bi bi-box-arrow-right me-1"></i>
                                    {% trans "من (المصدر)" %}
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted">
                                            {{ form.from_warehouse.label }}
                                        </label>
                                        {{ form.from_warehouse }}
                                        {% if form.from_warehouse.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form.from_warehouse.errors|join:", " }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted">
                                            {{ form.from_location.label }}
                                        </label>
                                        {{ form.from_location }}
                                        {% if form.from_location.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form.from_location.errors|join:", " }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {# إلى (الوجهة) - لحركات IN / TRANSFER #}
                    {% if form.to_warehouse %}
                        {% if not form.from_warehouse %}
                            <div class="col-12">
                                <hr class="my-1 text-muted opacity-25">
                            </div>
                        {% endif %}
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-3 border">
                                <h6 class="text-success mb-3 small fw-bold text-uppercase">
                                    <i class="bi bi-box-arrow-in-left me-1"></i>
                                    {% trans "إلى (الوجهة)" %}
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted">
                                            {{ form.to_warehouse.label }}
                                        </label>
                                        {{ form.to_warehouse }}
                                        {% if form.to_warehouse.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form.to_warehouse.errors|join:", " }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted">
                                            {{ form.to_location.label }}
                                        </label>
                                        {{ form.to_location }}
                                        {% if form.to_location.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form.to_location.errors|join:", " }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div class="col-12">
                        <label class="form-label fw-bold small text-secondary">
                            {{ form.note.label }}
                        </label>
                        {{ form.note }}
                        {% if form.note.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.note.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {# ===================== Lines Card ===================== #}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-body d-flex justify-content-between align-items-center py-3">
                <h5 class="h6 mb-0 fw-bold text-primary">
                    <i class="bi bi-list-check me-2"></i>
                    {% trans "بنود الحركة" %}
                </h5>
                <button type="button" class="btn btn-sm btn-primary" id="add-line-btn">
                    <i class="bi bi-plus-lg me-1"></i>
                    {% trans "إضافة منتج" %}
                </button>
            </div>

            <div class="table-responsive">
                {{ lines_formset.management_form }}

                {% if lines_formset.non_form_errors %}
                    <div class="alert alert-danger m-3 mb-0">
                        {{ lines_formset.non_form_errors }}
                    </div>
                {% endif %}

                <table class="table table-hover align-middle mb-0" id="lines-table">
                    <thead class="table-light text-secondary small text-uppercase">
                        <tr>
                            <th style="width: 45%">{% trans "المنتج" %}</th>
                            <th style="width: 20%">{% trans "الكمية" %}</th>
                            <th style="width: 20%">{% trans "الوحدة" %}</th>
                            <th style="width: 15%" class="text-center">{% trans "حذف" %}</th>
                        </tr>
                    </thead>
                    <tbody id="lines-body">
                        {% for line_form in lines_formset %}
                            {# أخطاء عامة للسطر الواحد (لو أضفت clean على الفورم) #}
                            {% if line_form.non_field_errors %}
                                <tr>
                                    <td colspan="4">
                                        <div class="text-danger small mb-2">
                                            {{ line_form.non_field_errors|join:", " }}
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}

                            <tr class="line-row">
                                {# الحقول المخفية (ID, DELETE hidden, ..) #}
                                {% for hidden in line_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}

                                <td class="p-2">
                                    {{ line_form.product }}
                                    {% if line_form.product.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ line_form.product.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="p-2">
                                    {{ line_form.quantity }}
                                    {% if line_form.quantity.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ line_form.quantity.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="p-2">
                                    {{ line_form.uom }}
                                    {% if line_form.uom.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ line_form.uom.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="text-center p-2">
                                    {% if line_form.instance.pk %}
                                        <div class="form-check d-flex justify-content-center">
                                            {{ line_form.DELETE }}
                                            <label class="form-check-label ms-1 text-muted small"
                                                   for="{{ line_form.DELETE.id_for_label }}">
                                                {% trans "حذف" %}
                                            </label>
                                        </div>
                                    {% else %}
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger border-0 remove-row-btn"
                                                title="{% trans 'حذف السطر' %}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# ===================== Footer Actions ===================== #}
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
            <button type="submit" class="btn btn-{{ move_type_color }} px-5 py-2 fw-bold">
                <i class="bi bi-check-lg me-2"></i>
                {% trans "حفظ المسودة" %}
            </button>
        </div>

    </form>

    {# ===================== Empty Row Template ===================== #}
    <table style="display: none;">
        <tbody id="empty-form-row">
            <tr class="line-row">
                {# مهم: الحقول المخفية للـ empty_form (مثلاً id أو ORDER إن وجد) #}
                {% for hidden in lines_formset.empty_form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}
                <td class="p-2">
                    {{ lines_formset.empty_form.product }}
                </td>
                <td class="p-2">
                    {{ lines_formset.empty_form.quantity }}
                </td>
                <td class="p-2">
                    {{ lines_formset.empty_form.uom }}
                </td>
                <td class="text-center p-2">
                    <button type="button" class="btn btn-sm btn-outline-danger border-0 remove-row-btn">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

</div>

{# ===================== JavaScript لإدارة الصفوف ===================== #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.getElementById('add-line-btn');
        const tableBody = document.getElementById('lines-body');
        const emptyRow = document.getElementById('empty-form-row')?.firstElementChild;
        const totalFormsInput = document.querySelector(
            'input[name="{{ lines_formset.prefix }}-TOTAL_FORMS"]'
        );

        // حماية بسيطة لو في عنصر ناقص
        if (!addBtn || !tableBody || !emptyRow || !totalFormsInput) {
            return;
        }

        // إضافة سطر جديد
        addBtn.addEventListener('click', function() {
            const formCount = parseInt(totalFormsInput.value, 10) || 0;
            const newRow = emptyRow.cloneNode(true);

            // استبدال __prefix__ بالرقم الحالي للفورم
            newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formCount);

            tableBody.appendChild(newRow);
            totalFormsInput.value = formCount + 1;
        });

        // حذف سطر (للصفوف الجديدة غير المحفوظة)
        tableBody.addEventListener('click', function(e) {
            const btn = e.target.closest('.remove-row-btn');
            if (btn) {
                const row = btn.closest('tr');
                if (row) {
                    row.remove();
                }
                // لا نقلل TOTAL_FORMS، جانغو يتعامل مع الفجوات
            }
        });
    });
</script>

{% endblock %}

{% extends "inventory/base_inventory.html" %}
{% load i18n %}

{% block inventory_title %}{{ move.reference|default:move.pk }} | {{ move.get_move_type_display }}{% endblock %}

{% block inventory_content %}
<div class="py-3 py-lg-4">

  {# ================== بطاقة الهيدر: المرجع + الحالة + التاريخ + الأزرار ================== #}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-start gap-3">

      {# الجزء الأيسر: معلومات الحركة الأساسية #}
      <div>
        <div class="d-flex align-items-center gap-3 mb-2">
          {# أيقونة نوع الحركة #}
          <div class="rounded-circle d-flex align-items-center justify-content-center p-2
            {% if move.move_type == 'in' %}
              bg-success-subtle
            {% elif move.move_type == 'out' %}
              bg-primary-subtle
            {% else %}
              bg-warning-subtle
            {% endif %}
          ">
            {% if move.move_type == 'in' %}
              <i class="bi bi-arrow-down-circle text-success"></i>
            {% elif move.move_type == 'out' %}
              <i class="bi bi-arrow-up-circle text-primary"></i>
            {% else %}
              <i class="bi bi-arrow-left-right text-warning"></i>
            {% endif %}
          </div>

          <div>
            <h1 class="h4 mb-1 fw-bold text-body">
              {{ move.reference|default:move.pk }}
            </h1>
            <div class="d-flex flex-wrap align-items-center gap-2 small">

              <span class="badge rounded-pill bg-light text-body-secondary border">
                {{ move.get_move_type_display }}
              </span>

              {% if move.status == 'draft' %}
                <span class="badge rounded-pill bg-secondary-subtle text-secondary">
                  {% trans "مسودة" %}
                </span>
              {% elif move.status == 'done' %}
                <span class="badge rounded-pill bg-success-subtle text-success d-inline-flex align-items-center gap-1">
                  <i class="bi bi-check-circle-fill small"></i>
                  <span>{% trans "منفذة" %}</span>
                </span>
              {% elif move.status == 'cancelled' %}
                <span class="badge rounded-pill bg-danger-subtle text-danger d-inline-flex align-items-center gap-1">
                  <i class="bi bi-x-circle-fill small"></i>
                  <span>{% trans "ملغاة" %}</span>
                </span>
              {% endif %}
            </div>
          </div>
        </div>

        <p class="text-body-secondary small mb-0">
          <i class="bi bi-calendar3 me-1"></i>
          {{ move.move_date|date:"l, d F Y - H:i" }}
        </p>
      </div>

      {# الجزء الأيمن: أزرار الإجراءات #}
      <div class="d-flex flex-wrap gap-2 print-hide">

        {% if move.status == 'draft' %}
          <form action="{% url 'inventory:move_confirm' move.pk %}" method="post">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-success d-inline-flex align-items-center"
                    onclick="return confirm('{% trans "هل أنت متأكد من ترحيل هذه الحركة؟ سيتم تحديث المخزون." %}')">
              <i class="bi bi-check-lg me-1"></i>
              <span class="small fw-semibold">{% trans "تأكيد وترحيل" %}</span>
            </button>
          </form>
        {% elif move.status == 'done' %}
          <form action="{% url 'inventory:move_cancel' move.pk %}" method="post">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-outline-danger d-inline-flex align-items-center"
                    onclick="return confirm('{% trans "هل أنت متأكد من إلغاء هذه الحركة؟ سيتم عكس المخزون." %}')">
              <i class="bi bi-arrow-counterclockwise me-1"></i>
              <span class="small fw-semibold">{% trans "إلغاء الحركة" %}</span>
            </button>
          </form>
        {% endif %}

        <a href="{% url 'inventory:move_print' move.pk %}"
           target="_blank"
           class="btn btn-outline-dark d-inline-flex align-items-center"
           title="{% trans 'طباعة PDF' %}">
          <i class="bi bi-file-earmark-pdf me-1"></i>
          <span class="small fw-semibold">{% trans "طباعة" %}</span>
        </a>
      </div>
    </div>
  </div>

  {# ================== تخطيط من عمودين: ملخص الحركة + تفاصيل البنود ================== #}
  <div class="row g-4">

    {# ========== العمود الأيسر: ملخص الحركة (مصدر، وجهة، ملاحظة، ميتاداتا) ========== #}
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-body py-3">
          <h2 class="h6 mb-0 fw-bold text-body">
            <i class="bi bi-info-circle me-2 text-primary"></i>
            {% trans "ملخص الحركة" %}
          </h2>
        </div>
        <div class="card-body small">

          <dl class="row mb-2">
            <dt class="col-5 text-body-secondary">{% trans "نوع الحركة" %}</dt>
            <dd class="col-7">
              {{ move.get_move_type_display }}
            </dd>
          </dl>

          {% if move.move_type != 'in' %}
          <hr class="my-2">
          <h6 class="text-uppercase small fw-bold text-body-secondary mb-2">
            {% trans "من (المصدر)" %}
          </h6>
          {% if move.from_warehouse %}
            <div class="mb-1 fw-semibold text-body">
              {{ move.from_warehouse.name }}
            </div>
            {% if move.from_location %}
              <div class="mb-1 text-body-secondary">
                {{ move.from_location.name }}
              </div>
            {% endif %}
            <div class="font-monospace text-body-secondary">
              {{ move.from_warehouse.code }}
            </div>
          {% else %}
            <div class="text-body-secondary">
              <em>{% trans "جهة خارجية / مورد" %}</em>
            </div>
          {% endif %}
          {% endif %}

          {% if move.move_type != 'out' %}
          <hr class="my-2">
          <h6 class="text-uppercase small fw-bold text-body-secondary mb-2">
            {% trans "إلى (الوجهة)" %}
          </h6>
          {% if move.to_warehouse %}
            <div class="mb-1 fw-semibold text-body">
              {{ move.to_warehouse.name }}
            </div>
            {% if move.to_location %}
              <div class="mb-1 text-body-secondary">
                {{ move.to_location.name }}
              </div>
            {% endif %}
            <div class="font-monospace text-body-secondary">
              {{ move.to_warehouse.code }}
            </div>
          {% else %}
            <div class="text-body-secondary">
              <em>{% trans "جهة خارجية / عميل" %}</em>
            </div>
          {% endif %}
          {% endif %}

          <hr class="my-2">

          {% if move.note %}
          <div class="mb-2">
            <div class="small fw-bold text-body-secondary mb-1">
              {% trans "ملاحظات" %}:
            </div>
            <div class="alert alert-light border small mb-0">
              {{ move.note }}
            </div>
          </div>
          {% endif %}

          <div class="mt-3 text-body-secondary">
            {% if move.created_at %}
              <div class="mb-1">
                <i class="bi bi-clock"></i>
                {% trans "تم الإنشاء:" %} {{ move.created_at|date:"Y-m-d H:i" }}
              </div>
            {% endif %}
            {% if move.status == 'done' %}
              <div class="text-success">
                <i class="bi bi-check-all"></i>
                {% trans "تاريخ الترحيل:" %} {{ move.updated_at|date:"Y-m-d H:i" }}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {# ========== العمود الأيمن: جدول تفاصيل المنتجات ========== #}
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-body py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="d-flex align-items-center gap-2">
            <div class="rounded-circle d-flex align-items-center justify-content-center p-2 bg-primary-subtle">
              <i class="bi bi-box-seam text-primary"></i>
            </div>
            <div>
              <h2 class="h6 mb-0 fw-bold text-primary">
                {% trans "تفاصيل المنتجات" %}
              </h2>
              <p class="small mb-0 text-body-secondary">
                {% blocktrans with count=move.lines.count %}عدد البنود: {{ count }}{% endblocktrans %}
              </p>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4" style="width: 5%">#</th>
                <th style="width: 45%">{% trans "المنتج" %}</th>
                <th style="width: 25%">{% trans "الكمية" %}</th>
                <th style="width: 25%">{% trans "الوحدة" %}</th>
              </tr>
            </thead>
            <tbody>
            {% for line in move.lines.all %}
              <tr>
                <td class="ps-4 text-body-secondary small">
                  {{ forloop.counter }}
                </td>
                <td>
                  <div class="fw-semibold text-body">
                    <a href="{% url 'inventory:product_detail' line.product.code %}"
                       class="text-decoration-none text-body">
                      [{{ line.product.code }}] {{ line.product.name }}
                    </a>
                  </div>
                </td>
                <td class="fw-bold">
                  {{ line.quantity }}
                </td>
                <td>
                  <span class="badge bg-light text-body border small">
                    {{ line.uom.name }}
                  </span>
                </td>
              </tr>
            {% endfor %}
            </tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="2" class="text-end fw-bold">
                  {% trans "الإجمالي:" %}
                </td>
                <td class="fw-bold">
                  {{ move.total_lines_quantity }}
                </td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

  </div> {# /row #}

</div>

{# ================== تنسيقات الطباعة ================== #}
<style media="print">
  .print-hide {
    display: none !important;
  }
  body {
    background-color: #ffffff !important;
  }
  .card {
    border: 1px solid #ddd !important;
    box-shadow: none !important;
  }
  .badge {
    border: 1px solid #000 !important;
    color: #000 !important;
    background: none !important;
  }
</style>
{% endblock %}

{% extends "inventory/base_inventory.html" %}
{% load i18n %}

{% block inventory_title %}{{ page_title }}{% endblock %}

{% block inventory_content %}
<div class="py-3 py-lg-4">

  {# ================== العنوان + زر جديد ================== #}
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div class="d-flex align-items-center gap-3">
      <div class="rounded-circle d-flex align-items-center justify-content-center p-2 bg-{{ move_type_color }}-subtle">
        <i class="bi bi-arrow-left-right text-{{ move_type_color }}"></i>
      </div>
      <div>
        <h1 class="h4 mb-1 fw-bold">
          {{ page_title }}
        </h1>
        <p class="text-body-secondary small mb-0">
          {% trans "سجل الحركات وإدارتها." %}
        </p>
      </div>
    </div>

    <div>
      <a href="{{ create_url }}" class="btn btn-{{ move_type_color }} d-inline-flex align-items-center shadow-sm">
        <i class="bi bi-plus-lg me-1"></i>
        <span class="fw-semibold small">
          {% trans "جديد" %} {{ move_type_label }}
        </span>
      </a>
    </div>
  </div>

  {# ================== كرت البحث / الفلترة ================== #}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-3 p-lg-4">
      <form method="get" class="row g-2 align-items-center">
        <div class="col-md-6">
          <label for="searchInput" class="form-label small text-body-secondary mb-1">
            {% trans "بحث في الحركات" %}
          </label>
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0 text-muted">
              <i class="bi bi-search"></i>
            </span>
            <input
              id="searchInput"
              type="text"
              name="q"
              class="form-control border-start-0"
              placeholder="{% trans 'بحث برقم المرجع، المنتج، أو المستودع...' %}"
              value="{{ request.GET.q|default:'' }}">
          </div>
        </div>

        <div class="col-md-3 col-lg-2 mt-3 mt-md-4">
          <button type="submit" class="btn btn-outline-secondary w-100">
            <i class="bi bi-search me-1"></i>
            <span class="small fw-semibold">{% trans "بحث" %}</span>
          </button>
        </div>

        {% if request.GET.q %}
        <div class="col-md-3 col-lg-2 mt-3 mt-md-4">
          <a href="." class="btn btn-light w-100">
            <i class="bi bi-x-circle me-1"></i>
            <span class="small">{% trans "مسح البحث" %}</span>
          </a>
        </div>
        {% endif %}
      </form>
    </div>
  </div>

  {# ================== جدول الحركات ================== #}
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light text-uppercase small text-body-secondary">
          <tr>
            <th class="ps-4">{% trans "المرجع" %}</th>
            <th>{% trans "التاريخ" %}</th>

            {% if current_move_type != 'in' %}
              <th>{% trans "من (المصدر)" %}</th>
            {% endif %}

            {% if current_move_type != 'out' %}
              <th>{% trans "إلى (الوجهة)" %}</th>
            {% endif %}

            <th>{% trans "الحالة" %}</th>
            <th class="text-end pe-4">{% trans "إجراء" %}</th>
          </tr>
        </thead>
        <tbody>
        {% for move in moves %}
          <tr>
            {# المرجع + ملاحظة #}
            <td class="ps-4">
              <a href="{% url 'inventory:move_detail' move.pk %}"
                 class="text-decoration-none font-monospace small fw-semibold text-primary">
                {{ move.reference|default:move.pk }}
              </a>
              {% if move.note %}
                <i class="bi bi-info-circle text-muted ms-1 small"
                   data-bs-toggle="tooltip"
                   title="{{ move.note }}"></i>
              {% endif %}
            </td>

            {# التاريخ #}
            <td class="text-body-secondary small">
              {{ move.move_date|date:"Y-m-d" }}
            </td>

            {# من (المصدر) #}
            {% if current_move_type != 'in' %}
            <td>
              {% if move.from_warehouse %}
                <div class="d-flex flex-column">
                  <span class="fw-semibold text-body">{{ move.from_warehouse.name }}</span>
                  {% if move.from_location %}
                    <span class="small text-body-secondary">{{ move.from_location.name }}</span>
                  {% endif %}
                </div>
              {% else %}
                <span class="text-body-secondary small">-</span>
              {% endif %}
            </td>
            {% endif %}

            {# إلى (الوجهة) #}
            {% if current_move_type != 'out' %}
            <td>
              {% if move.to_warehouse %}
                <div class="d-flex flex-column">
                  <span class="fw-semibold text-body">{{ move.to_warehouse.name }}</span>
                  {% if move.to_location %}
                    <span class="small text-body-secondary">{{ move.to_location.name }}</span>
                  {% endif %}
                </div>
              {% else %}
                <span class="text-body-secondary small">-</span>
              {% endif %}
            </td>
            {% endif %}

            {# الحالة #}
            <td>
              {% if move.status == 'draft' %}
                <span class="badge bg-secondary-subtle text-secondary rounded-pill small d-inline-flex align-items-center px-3">
                  {% trans "مسودة" %}
                </span>
              {% elif move.status == 'done' %}
                <span class="badge bg-success-subtle text-success rounded-pill small d-inline-flex align-items-center px-3">
                  <i class="bi bi-check2 me-1"></i>
                  {% trans "منفذة" %}
                </span>
              {% elif move.status == 'cancelled' %}
                <span class="badge bg-danger-subtle text-danger rounded-pill small d-inline-flex align-items-center px-3">
                  {% trans "ملغاة" %}
                </span>
              {% endif %}
            </td>

            {# زر التفاصيل #}
            <td class="text-end pe-4">
              <a href="{% url 'inventory:move_detail' move.pk %}"
                 class="btn btn-sm btn-light border d-inline-flex align-items-center"
                 title="{% trans 'عرض التفاصيل' %}">
                <i class="bi bi-eye me-1 small"></i>
                <span class="small">{% trans "عرض" %}</span>
              </a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="100" class="text-center py-5 text-body-secondary">
              <div class="mb-2">
                <i class="bi bi-inbox fs-1 opacity-25"></i>
              </div>
              <div class="fw-semibold mb-1">
                {% trans "لا توجد حركات مخزون." %}
              </div>
              <div class="small">
                {% trans "يمكنك بدء إضافة حركات جديدة من زر (جديد) في الأعلى." %}
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {# ================== الباجينيشن ================== #}
    {% if is_paginated %}
    <div class="card-footer bg-body py-3">
      <nav>
        <ul class="pagination justify-content-center mb-0">

          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link border-0 text-secondary"
               href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
          {% endif %}

          <li class="page-item active">
            <span class="page-link bg-{{ move_type_color }} border-{{ move_type_color }}">
              {{ page_obj.number }}
              <span class="small text-body-secondary ms-1">
                / {{ page_obj.paginator.num_pages }}
              </span>
            </span>
          </li>

          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link border-0 text-secondary"
               href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
          {% endif %}

        </ul>
      </nav>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{# templates/sales/dashboard.html #}
{% extends "sales/base_sales.html" %}
{% load i18n %}

{% block meta_title %}{% trans "لوحة مبيعات Mazoon" %}{% endblock %}

{% block sales_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 fw-bold mb-1">
      {% trans "لوحة مبيعات Mazoon" %}
    </h1>
    <p class="text-muted small mb-0">
      {% trans "نظرة سريعة على عروض الأسعار، أوامر البيع ومذكرات التسليم." %}
    </p>
  </div>
</div>

<div class="row g-3 mb-3">
  <!-- إجمالي المبيعات -->
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "إجمالي قيمة مستندات المبيعات" %}</div>
        <div class="h4 fw-bold mb-1">
          {{ total_sales_amount }} OMR
        </div>
        <div class="small text-muted">
          {% trans "من" %} {{ total_sales_docs }} {% trans "مستند مبيعات" %}
        </div>
      </div>
    </div>
  </div>

  <!-- عروض الأسعار -->
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "عروض الأسعار" %}</div>
        <div class="h4 fw-bold mb-1">
          {{ quotation_count }}
        </div>
        <div class="small text-muted">
          {% trans "إجمالي القيمة" %}: {{ total_quotation_amount }} OMR
        </div>
      </div>
    </div>
  </div>

  <!-- أوامر البيع -->
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "أوامر البيع" %}</div>
        <div class="h4 fw-bold mb-1">
          {{ order_count }}
        </div>
        <div class="small text-muted">
          {% trans "إجمالي القيمة" %}: {{ total_order_amount }} OMR
        </div>
      </div>
    </div>
  </div>

  <!-- مذكرات التسليم -->
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "مذكرات التسليم" %}</div>
        <div class="h4 fw-bold mb-1">
          {{ delivery_count }}
        </div>
        <div class="small text-muted">
          {% trans "إجمالي القيمة" %}: {{ total_delivery_amount }} OMR
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Workflow stats -->
<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "مسودات" %}</div>
        <div class="h5 fw-bold mb-0">{{ draft_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "مؤكد" %}</div>
        <div class="h5 fw-bold mb-0">{{ confirmed_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "تم التسليم" %}</div>
        <div class="h5 fw-bold mb-0">{{ delivered_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">{% trans "مفوتر" %}</div>
        <div class="h5 fw-bold mb-0">{{ invoiced_count }}</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- آخر عروض الأسعار -->
  <div class="col-lg-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 fw-semibold mb-0">
            {% trans "آخر عروض الأسعار" %}
          </h2>
          <a href="{% url 'sales:quotation_list' %}"
             class="small text-decoration-none">
            {% trans "عرض الكل" %}
          </a>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle.mb-0">
            <thead class="table-light">
              <tr>
                <th class="small text-muted">{% trans "التاريخ" %}</th>
                <th class="small text-muted">{% trans "العميل" %}</th>
                <th class="small text-muted text-end">{% trans "الإجمالي" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for q in recent_quotations %}
                <tr>
                  <td class="small text-nowrap">
                    <a href="{% url 'sales:quotation_detail' q.pk %}"
                       class="text-mazoon text-decoration-none">
                      {{ q.date|date:"Y-m-d" }}
                    </a>
                  </td>
                  <td class="small">
                    {% if q.contact %}
                      {{ q.contact.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="small text-end text-nowrap">
                    {{ q.total_amount }} OMR
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted small py-3">
                    {% trans "لا توجد عروض أسعار حديثة." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- آخر أوامر البيع -->
  <div class="col-lg-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between.align-items-center mb-2">
          <h2 class="h6 fw-semibold mb-0">
            {% trans "آخر أوامر البيع" %}
          </h2>
          <a href="{% url 'sales:order_list' %}"
             class="small text-decoration-none">
            {% trans "عرض الكل" %}
          </a>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="small text-muted">{% trans "التاريخ" %}</th>
                <th class="small text-muted">{% trans "العميل" %}</th>
                <th class="small text-muted text-end">{% trans "الإجمالي" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for o in recent_orders %}
                <tr>
                  <td class="small text-nowrap">
                    <a href="{% url 'sales:order_detail' o.pk %}"
                       class="text-mazoon text-decoration-none">
                      {{ o.date|date:"Y-m-d" }}
                    </a>
                  </td>
                  <td class="small">
                    {% if o.contact %}
                      {{ o.contact.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="small text-end text-nowrap">
                    {{ o.total_amount }} OMR
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted small py-3">
                    {% trans "لا توجد أوامر بيع حديثة." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- آخر مذكرات التسليم + أفضل العملاء -->
  <div class="col-lg-4">
    <div class="card border-0 shadow-sm.mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 fw-semibold mb-0">
            {% trans "آخر مذكرات التسليم" %}
          </h2>
          <a href="{% url 'sales:delivery_list' %}"
             class="small text-decoration-none">
            {% trans "عرض الكل" %}
          </a>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="small text-muted">{% trans "التاريخ" %}</th>
                <th class="small text-muted">{% trans "العميل" %}</th>
                <th class="small text-muted text-end">{% trans "الإجمالي" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for d in recent_deliveries %}
                <tr>
                  <td class="small text-nowrap">
                    <a href="{% url 'sales:delivery_detail' d.pk %}"
                       class="text-mazoon text-decoration-none">
                      {{ d.date|date:"Y-m-d" }}
                    </a>
                  </td>
                  <td class="small">
                    {% if d.contact %}
                      {{ d.contact.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="small text-end text-nowrap">
                    {{ d.total_amount }} OMR
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted small py-3">
                    {% trans "لا توجد مذكرات تسليم حديثة." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-2">
          {% trans "أفضل العملاء حسب إجمالي المبيعات" %}
        </h2>

        <div class="table-responsive">
          <table class="table table-sm.align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="small text-muted">{% trans "العميل" %}</th>
                <th class="small text-muted text-end">{% trans "إجمالي المبيعات" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for c in top_customers %}
                <tr>
                  <td class="small">
                    {% if c.contact_id %}
                      <a href="{% url 'contacts:contact_detail' c.contact_id %}"
                         class="text-mazoon text-decoration-none">
                        {{ c.contact__name }}
                      </a>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="small text-end text-nowrap">
                    {{ c.total }} OMR
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="2" class="text-center text-muted small py-3">
                    {% trans "لا توجد بيانات كافية لعرض أفضل العملاء." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}

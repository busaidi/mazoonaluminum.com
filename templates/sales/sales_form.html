{% extends "sales/base_sales.html" %}
{% load i18n %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        {{ form.instance.display_number }}
    {% else %}
        {% trans "مستند جديد" %}
    {% endif %}
{% endblock %}

{% block sales_content %}
<div class="container-fluid px-0">
    <form method="post" id="salesForm" novalidate>
        {% csrf_token %}

        {# ================= HEADER ================= #}
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
            <div>
                <h1 class="h3 fw-bold text-body mb-1">
                    {% if form.instance.pk %}
                        <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis align-middle ms-1">
                            <i class="bi bi-pencil-square"></i>
                        </span>
                        <span class="align-middle ms-1">{% trans "تعديل مستند" %}</span>
                        <span class="text-primary align-middle">#{{ form.instance.display_number }}</span>
                    {% else %}
                        <span class="badge rounded-pill bg-success-subtle text-success-emphasis align-middle ms-1">
                            <i class="bi bi-plus-lg"></i>
                        </span>
                        <span class="align-middle ms-1">{% trans "إنشاء مستند جديد" %}</span>
                    {% endif %}
                </h1>
                <p class="text-muted small mb-0">
                    {% trans "أضف العميل ثم البنود مع الكميات والوحدات والأسعار." %}
                </p>
            </div>

            <div class="d-flex flex-wrap gap-2">
                <a href="{% url 'sales:quotation_list' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-right-circle ms-1"></i> {% trans "رجوع" %}
                </a>
                <button type="submit" class="btn btn-sm btn-primary px-3">
                    <i class="bi bi-check-lg ms-1"></i> {% trans "حفظ" %}
                </button>
            </div>
        </div>

        {# ================= ERRORS ================= #}
        {% if form.errors or lines.non_form_errors %}
            <div class="alert alert-danger shadow-sm rounded-3 border-0 d-flex align-items-start mb-4" role="alert">
                <i class="bi bi-exclamation-triangle-fill fs-4 ms-3 mt-1"></i>
                <div>
                    <strong class="d-block mb-1">{% trans "يرجى مراجعة الأخطاء التالية:" %}</strong>
                    {{ form.errors }}
                    {{ lines.non_form_errors }}
                </div>
            </div>
        {% endif %}

        {# ================= HEADER CARD ================= #}
        <div class="card border-0 shadow-sm rounded-3 mb-4">
            <div class="card-header bg-body-tertiary border-0 py-2">
                <span class="badge text-bg-primary-subtle text-primary-emphasis rounded-pill me-2">
                    <i class="bi bi-person-vcard"></i>
                </span>
                <span class="fw-semibold small text-secondary text-uppercase">{% trans "بيانات المستند" %}</span>
            </div>

            <div class="card-body pb-3">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small fw-semibold text-secondary">{{ form.contact.label }} <span class="text-danger">*</span></label>
                        {{ form.contact }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-semibold text-secondary">{{ form.date.label }}</label>
                        {{ form.date }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-semibold text-secondary">{{ form.due_date.label }}</label>
                        {{ form.due_date }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-semibold text-secondary">{{ form.client_reference.label }}</label>
                        {{ form.client_reference }}
                    </div>

                    <div class="col-md-8">
                        <label class="form-label small fw-semibold text-secondary">{{ form.notes.label }}</label>
                        {{ form.notes }}
                    </div>
                </div>
            </div>
        </div>

        <style>
            .line-description-wrapper input {
                border: 0;
                border-radius: 0;
                border-bottom: 1px dashed #d0d4d8;
                background: transparent;
                padding: 2px 0 !important;
                font-size: 0.78rem;
                color: #6c757d;
            }
            .line-description-wrapper input:focus {
                border-bottom-color: #0d6efd !important;
                background: #fff !important;
                outline: none;
                box-shadow: none;
            }
            .line-description-wrapper input::placeholder {
                color: #b7bec5;
            }
        </style>

        {# ================= LINES TABLE ================= #}
        <div class="card border-0 shadow-sm rounded-3 mb-4">
            <div class="card-header bg-body-tertiary border-0 py-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <span class="badge text-bg-primary-subtle text-primary-emphasis rounded-pill me-2">
                        <i class="bi bi-box-seam"></i>
                    </span>
                    <span class="fw-semibold small text-secondary text-uppercase">{% trans "بنود المنتجات" %}</span>
                </div>

                <button type="button" class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1" id="add-line-btn">
                    <i class="bi bi-plus-lg"></i> {% trans "إضافة سطر" %}
                </button>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    {{ lines.management_form }}

                    <table class="table table-sm align-middle mb-0" id="lines-table">
                        <thead class="bg-body text-uppercase text-muted small">
                            <tr>
                                <th class="ps-4 border-bottom-0" style="width: 34%">{% trans "المنتج" %} / <span class="text-muted">{% trans "الوصف" %}</span></th>
                                <th class="text-center border-bottom-0" style="width: 9%">{% trans "الكمية" %}</th>
                                <th class="text-center border-bottom-0" style="width: 12%">{% trans "الوحدة" %}</th>
                                <th class="text-center border-bottom-0" style="width: 13%">{% trans "السعر" %}</th>
                                <th class="text-center border-bottom-0" style="width: 9%">{% trans "خصم %" %}</th>
                                <th class="text-end border-bottom-0" style="width: 13%">{% trans "الإجمالي" %}</th>
                                <th class="text-center border-bottom-0" style="width: 4%"></th>
                            </tr>
                        </thead>

                        <tbody id="lines-body">
                            {% for line_form in lines.forms %}
                                <tr class="line-row {% if line_form.instance.pk %}existing-line{% else %}new-line{% endif %}">
                                    {% for hidden in line_form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}

                                    <td class="ps-4 py-2 align-middle">

                                        <div class="mb-1">{{ line_form.product }}</div>

                                        <div class="line-description-wrapper">
                                            {{ line_form.description }}
                                        </div>
                                    </td>

                                    <td class="text-center py-2">{{ line_form.quantity }}</td>
                                    <td class="text-center py-2">{{ line_form.uom }}</td>
                                    <td class="text-center py-2">{{ line_form.unit_price }}</td>
                                    <td class="text-center py-2">{{ line_form.discount_percent }}</td>

                                    <td class="text-end py-2">
                                        <input type="text" class="form-control form-control-sm row-total text-end bg-transparent border-0 fw-semibold" readonly value="0.000">
                                    </td>

                                    <td class="text-center py-2 pe-3">
                                        {% if lines.can_delete %}
                                            <div class="d-none">{{ line_form.DELETE }}</div>
                                            <button type="button" class="btn btn-sm btn-outline-danger border-0 rounded-circle delete-line-btn">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {# ================= NOTES + TOTAL ================= #}
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-header bg-body-tertiary border-0 py-2">
                        <span class="badge text-bg-primary-subtle text-primary-emphasis rounded-pill me-2">
                            <i class="bi bi-chat-quote"></i>
                        </span>
                        <span class="fw-semibold small text-secondary text-uppercase">{% trans "شروط وأحكام للعميل" %}</span>
                    </div>

                    <div class="card-body">
                        {{ form.customer_notes }}
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body d-flex flex-column justify-content-between p-3">
                        <div>
                            <span class="small text-muted text-uppercase">{% trans "إجمالي المستند" %}</span>
                            <h2 class="fw-bold text-success mt-2 mb-1 fs-1">
                                <span id="grand-total-display">0.000</span>
                                <span class="fs-6 text-muted ms-1">{{ form.instance.currency }}</span>
                            </h2>
                        </div>

                        <div class="mt-3 d-flex justify-content-end">
                            <button type="submit" class="btn btn-sm btn-success px-3">
                                <i class="bi bi-floppy ms-1"></i> {% trans "حفظ المستند" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>


{# ========= PRODUCTS DATA JSON ========= #}
{{ products_dict|json_script:"products-data" }}

{# ========= EMPTY FORM TEMPLATE ========= #}
<script type="text/template" id="empty-form-template">
<tr class="line-row new-line">
    {% for hidden in lines.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
    <td class="ps-4 py-2 align-middle">
        <div class="mb-1">{{ lines.empty_form.product }}</div>
        <div class="line-description-wrapper">{{ lines.empty_form.description }}</div>
    </td>
    <td class="text-center py-2">{{ lines.empty_form.quantity }}</td>
    <td class="text-center py-2">{{ lines.empty_form.uom }}</td>
    <td class="text-center py-2">{{ lines.empty_form.unit_price }}</td>
    <td class="text-center py-2">{{ lines.empty_form.discount_percent }}</td>
    <td class="text-end py-2">
        <input type="text" class="form-control form-control-sm row-total text-end bg-transparent border-0 fw-semibold" readonly value="0.000">
    </td>
    <td class="text-center py-2 pe-3">
        <div class="d-none">{{ lines.empty_form.DELETE }}</div>
        <button type="button" class="btn btn-sm btn-outline-danger border-0 rounded-circle delete-line-btn">
            <i class="bi bi-x-lg"></i>
        </button>
    </td>
</tr>
</script>

{# ========= JS: UNCHANGED LOGIC ========= #}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const productsData = JSON.parse(document.getElementById('products-data').textContent);
    const totalFormsInput = document.getElementById('id_lines-TOTAL_FORMS');
    const linesBody = document.getElementById('lines-body');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;

    function updateRowUOMs(row, keepSelectedValue = false) {
        const p = row.querySelector('.product-select');
        const u = row.querySelector('.uom-select');
        if (!p || !u) return;
        const productId = p.value;
        const old = u.value;
        u.innerHTML = '';

        if (productId && productsData[productId]) {
            const pd = productsData[productId];
            if (pd.base_uom_id) u.add(new Option(pd.base_uom_name, pd.base_uom_id));
            if (pd.alt_uom_id) u.add(new Option(pd.alt_uom_name, pd.alt_uom_id));

            if (keepSelectedValue && old) {
                let found = false;
                for (let o of u.options) if (o.value == old) found = true;
                u.value = found ? old : pd.base_uom_id;
            } else {
                u.value = pd.base_uom_id;
                updatePrice(row);
            }
        }
    }

    function updatePrice(row) {
        const p = row.querySelector('.product-select');
        const u = row.querySelector('.uom-select');
        const price = row.querySelector('.price-input');
        if (!p || !u || !price) return;

        const productId = p.value;
        const uomId = u.value;

        if (productsData[productId]) {
            const pd = productsData[productId];
            let base = parseFloat(pd.price) || 0;
            if (String(uomId) === String(pd.alt_uom_id) && pd.alt_uom_id) {
                price.value = (base * parseFloat(pd.alt_factor || 1)).toFixed(3);
            } else {
                price.value = base.toFixed(3);
            }
            updateTotal(row);
        }
    }

    function updateTotal(row) {
        const q = parseFloat(row.querySelector('.qty-input')?.value || 0);
        const pr = parseFloat(row.querySelector('.price-input')?.value || 0);
        const d = parseFloat(row.querySelector('.discount-input')?.value || 0);
        const totalEl = row.querySelector('.row-total');
        let total = q * pr;
        if (d > 0) total *= (1 - d / 100);
        totalEl.value = total.toFixed(3);
        updateGrand();
    }

    function updateGrand() {
        let g = 0;
        linesBody.querySelectorAll('.row-total').forEach(t => g += parseFloat(t.value || 0));
        document.getElementById('grand-total-display').textContent = g.toFixed(3);
    }

    function attach(row) {
        row.querySelectorAll('input').forEach(i => i.addEventListener('input', () => updateTotal(row)));
        row.querySelector('.product-select')?.addEventListener('change', () => updateRowUOMs(row, false));
        row.querySelector('.uom-select')?.addEventListener('change', () => updatePrice(row));
    }

    document.getElementById('add-line-btn').addEventListener('click', () => {
        const c = parseInt(totalFormsInput.value);
        const html = emptyFormTemplate.replace(/__prefix__/g, c);
        linesBody.insertAdjacentHTML('beforeend', html);
        totalFormsInput.value = c + 1;
        const row = linesBody.lastElementChild;
        attach(row);
        updateRowUOMs(row);
    });

    linesBody.addEventListener('click', e => {
        const btn = e.target.closest('.delete-line-btn');
        if (!btn) return;
        const row = btn.closest('tr');
        const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        if (row.classList.contains('existing-line')) {
            row.style.display = 'none';
            if (del) del.checked = true;
        } else row.remove();
        updateGrand();
    });

    linesBody.querySelectorAll('tr').forEach(row => {
        attach(row);
        updateRowUOMs(row, true);
        updateTotal(row);
    });

});
</script>

{% endblock %}

{% extends "sales/base_sales.html" %}
{% load i18n %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        {{ form.instance.display_number }}
    {% else %}
        {% trans "مستند جديد" %}
    {% endif %}
{% endblock %}

{% block sales_content %}
<div class="container-fluid px-0">
    <form method="post" id="salesForm" novalidate>
        {% csrf_token %}

        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
            <div>
                <h1 class="h3 fw-bold text-dark mb-1">
                    {% if form.instance.pk %}
                        <i class="bi bi-pencil-square text-primary me-2"></i>{% trans "تعديل:" %} <span class="text-primary">{{ form.instance.display_number }}</span>
                    {% else %}
                        <i class="bi bi-plus-circle text-primary me-2"></i>{% trans "إنشاء مستند جديد" %}
                    {% endif %}
                </h1>
                <p class="text-body-secondary mb-0">
                    {% trans "الرجاء تعبئة تفاصيل المستند بدقة." %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'sales:quotation_list' %}" class="btn btn-light border shadow-sm">
                    {% trans "إلغاء" %}
                </a>
                <button type="submit" class="btn btn-primary px-4 shadow-sm fw-semibold">
                    <i class="bi bi-check-lg me-1"></i> {% trans "حفظ المستند" %}
                </button>
            </div>
        </div>

        {% if form.errors %}
            <div class="alert alert-danger shadow-sm rounded-3 border-0 d-flex align-items-center mb-4" role="alert">
                <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                <div>
                    <strong>{% trans "يرجى تصحيح الأخطاء التالية:" %}</strong>
                    {{ form.errors }}
                </div>
            </div>
        {% endif %}

        <div class="card border-0 shadow-sm rounded-3 mb-4">
            <div class="card-header bg-transparent border-0 pt-3 pb-0">
                <h6 class="fw-bold text-primary mb-0">
                    <i class="bi bi-info-circle me-1"></i> {% trans "البيانات الأساسية" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase fw-bold text-secondary">{{ form.contact.label }} <span class="text-danger">*</span></label>
                        {{ form.contact }}
                        {% if form.contact.errors %}<div class="text-danger small mt-1">{{ form.contact.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase fw-bold text-secondary">{{ form.date.label }}</label>
                        {{ form.date }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase fw-bold text-secondary">{{ form.due_date.label }}</label>
                        {{ form.due_date }}
                        {% if form.due_date.errors %}<div class="text-danger small mt-1">{{ form.due_date.errors.0 }}</div>{% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small text-uppercase fw-bold text-secondary">{{ form.client_reference.label }}</label>
                        {{ form.client_reference }}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label small text-uppercase fw-bold text-secondary">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        <div class="form-text text-muted small">{% trans "ملاحظات داخلية لا تظهر للعميل." %}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-3 mb-4">
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold text-primary mb-0">
                    <i class="bi bi-box-seam me-1"></i> {% trans "بنود المنتجات" %}
                </h6>
                <button type="button" class="btn btn-sm btn-primary bg-primary-subtle text-primary border-0 fw-bold" id="add-line-btn">
                    <i class="bi bi-plus-lg"></i> {% trans "إضافة سطر" %}
                </button>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    {{ lines.management_form }}
                    <table class="table table-hover align-middle mb-0" id="lines-table">
                        <thead class="bg-body-tertiary text-uppercase small fw-bold">
                            <tr>
                                <th style="width: 25%" class="ps-4 text-secondary border-0">{% trans "المنتج" %}</th>
                                <th style="width: 20%" class="text-secondary border-0">{% trans "الوصف" %}</th>
                                <th style="width: 10%" class="text-secondary border-0">{% trans "الكمية" %}</th>
                                <th style="width: 12%" class="text-secondary border-0">{% trans "الوحدة" %}</th>
                                <th style="width: 12%" class="text-secondary border-0">{% trans "السعر" %}</th>
                                <th style="width: 8%" class="text-secondary border-0">{% trans "خصم %" %}</th>
                                <th style="width: 10%" class="text-end text-secondary border-0">{% trans "الإجمالي" %}</th>
                                <th style="width: 3%" class="border-0"></th>
                            </tr>
                        </thead>
                        <tbody id="lines-body" class="border-top-0">
                            {% for line_form in lines.forms %}
                                <tr class="line-row {% if line_form.instance.pk %}existing-line{% else %}new-line{% endif %}">
                                    {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}

                                    <td class="ps-4 py-2">
                                        {{ line_form.product }}
                                        {% if line_form.product.errors %}
                                            <div class="text-danger small">{{ line_form.product.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="py-2">{{ line_form.description }}</td>
                                    <td class="py-2">{{ line_form.quantity }}</td>
                                    <td class="py-2">
                                        {{ line_form.uom }}
                                        {% if line_form.uom.errors %}
                                            <div class="text-danger small">{{ line_form.uom.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="py-2">{{ line_form.unit_price }}</td>
                                    <td class="py-2">{{ line_form.discount_percent }}</td>
                                    <td class="py-2 text-end">
                                        <input type="text" class="form-control row-total text-end bg-transparent border-0 fw-bold" readonly value="0.000">
                                    </td>
                                    <td class="text-center py-2 pe-3">
                                        {% if lines.can_delete %}
                                            <div class="d-none">{{ line_form.DELETE }}</div>
                                            <button type="button" class="btn btn-outline-danger btn-sm border-0 rounded-circle delete-line-btn" title="{% trans 'حذف السطر' %}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-header bg-transparent border-0 pt-3 pb-0">
                        <h6 class="fw-bold text-primary mb-0">
                            <i class="bi bi-chat-quote me-1"></i> {% trans "شروط وأحكام" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        {{ form.customer_notes }}
                        <div class="form-text text-muted small mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            {% trans "هذه الملاحظات ستظهر مطبوعة في أسفل الفاتورة للعميل (مثل تفاصيل الضمان والدفع)." %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-3 h-100 bg-body-tertiary">
                    <div class="card-body d-flex flex-column justify-content-center align-items-end p-4">
                        <h6 class="text-uppercase text-secondary fw-bold mb-2 small">{% trans "الإجمالي النهائي" %}</h6>
                        <h2 class="fw-bold text-success mb-0 display-6">
                            <span id="grand-total-display">0.000</span>
                            <span class="fs-5 text-muted ms-1">{{ form.instance.currency }}</span>
                        </h2>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>

{{ products_dict|json_script:"products-data" }}

<script type="text/template" id="empty-form-template">
    <tr class="line-row new-line">
        <td class="ps-4 py-2">{{ lines.empty_form.product }}</td>
        <td class="py-2">{{ lines.empty_form.description }}</td>
        <td class="py-2">{{ lines.empty_form.quantity }}</td>
        <td class="py-2">{{ lines.empty_form.uom }}</td>
        <td class="py-2">{{ lines.empty_form.unit_price }}</td>
        <td class="py-2">{{ lines.empty_form.discount_percent }}</td>
        <td class="py-2 text-end">
            <input type="text" class="form-control row-total text-end bg-transparent border-0 fw-bold" readonly value="0.000">
        </td>
        <td class="text-center py-2 pe-3">
            <div class="d-none">{{ lines.empty_form.DELETE }}</div>
            <button type="button" class="btn btn-outline-danger btn-sm border-0 rounded-circle delete-line-btn">
                <span aria-hidden="true">&times;</span>
            </button>
        </td>
        {% for hidden in lines.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
    </tr>
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Sales Form JS initialized (Full Width UI).");

        const dataScript = document.getElementById('products-data');
        if (!dataScript) return;
        const productsData = JSON.parse(dataScript.textContent);

        const totalFormsInput = document.getElementById('id_lines-TOTAL_FORMS');
        const linesBody = document.getElementById('lines-body');
        const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
        const addBtn = document.getElementById('add-line-btn');

        function updateRowUOMs(row, keepSelectedValue = false) {
            const productSelect = row.querySelector('.product-select');
            const uomSelect = row.querySelector('.uom-select');
            if (!productSelect || !uomSelect) return;

            const productId = productSelect.value;
            const currentUomValue = uomSelect.value;
            uomSelect.innerHTML = '';

            if (productId && productsData[productId]) {
                const pData = productsData[productId];
                uomSelect.add(new Option(pData.base_uom_name, pData.base_uom_id));
                if (pData.alt_uom_id) {
                    uomSelect.add(new Option(pData.alt_uom_name, pData.alt_uom_id));
                }
                if (keepSelectedValue && currentUomValue) {
                    let exists = false;
                    for (let i = 0; i < uomSelect.options.length; i++) {
                        if (uomSelect.options[i].value == currentUomValue) exists = true;
                    }
                    if (exists) uomSelect.value = currentUomValue;
                    else uomSelect.value = pData.base_uom_id;
                } else {
                    uomSelect.value = pData.base_uom_id;
                    updateRowPrice(row);
                }
            } else {
                uomSelect.add(new Option('---------', ''));
            }
        }

        function updateRowPrice(row) {
            const productSelect = row.querySelector('.product-select');
            const uomSelect = row.querySelector('.uom-select');
            const priceInput = row.querySelector('.price-input');
            if (!productSelect || !uomSelect || !priceInput) return;

            const productId = productSelect.value;
            const uomId = uomSelect.value;

            if (productId && productsData[productId]) {
                const pData = productsData[productId];
                let basePrice = parseFloat(pData.price) || 0;
                if (String(uomId) === String(pData.alt_uom_id) && pData.alt_uom_id) {
                    const factor = parseFloat(pData.alt_factor) || 1;
                    priceInput.value = (basePrice * factor).toFixed(3);
                } else {
                    priceInput.value = basePrice.toFixed(3);
                }
                calculateRowTotal(row);
            }
        }

        function calculateRowTotal(row) {
            const qtyInput = row.querySelector('.qty-input');
            const priceInput = row.querySelector('.price-input');
            const discInput = row.querySelector('.discount-input');
            const totalDisplay = row.querySelector('.row-total');
            if (!qtyInput || !priceInput) return;

            let qty = parseFloat(qtyInput.value) || 0;
            let price = parseFloat(priceInput.value) || 0;
            let discount = parseFloat(discInput ? discInput.value : 0) || 0;
            let total = qty * price;
            if (discount > 0) total = total * (1 - (discount / 100));
            totalDisplay.value = total.toFixed(3);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let grandTotal = 0;
            const rows = linesBody.querySelectorAll('tr.line-row');
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const rowTotalInput = row.querySelector('.row-total');
                    grandTotal += parseFloat(rowTotalInput.value) || 0;
                }
            });
            document.getElementById('grand-total-display').textContent = grandTotal.toFixed(3);
        }

        function attachEventsToRow(row) {
            const productSelect = row.querySelector('.product-select');
            const uomSelect = row.querySelector('.uom-select');
            const inputs = row.querySelectorAll('input');
            if (productSelect) productSelect.addEventListener('change', function() { updateRowUOMs(row, false); });
            if (uomSelect) uomSelect.addEventListener('change', function() { updateRowPrice(row); });
            inputs.forEach(input => input.addEventListener('input', function() { calculateRowTotal(row); }));
        }

        if (addBtn) {
            addBtn.addEventListener('click', function() {
                const currentFormCount = parseInt(totalFormsInput.value);
                const newRowHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);
                linesBody.insertAdjacentHTML('beforeend', newRowHtml);
                totalFormsInput.value = currentFormCount + 1;
                const newRow = linesBody.lastElementChild;
                attachEventsToRow(newRow);
                updateRowUOMs(newRow, false);
            });
        }

        linesBody.addEventListener('click', function(e) {
            if (e.target.closest('.delete-line-btn')) {
                const row = e.target.closest('tr');
                const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (row.classList.contains('existing-line')) {
                    row.style.display = 'none';
                    if (deleteCheckbox) deleteCheckbox.checked = true;
                } else {
                    row.remove();
                }
                calculateGrandTotal();
            }
        });

        const existingRows = linesBody.querySelectorAll('tr.line-row');
        existingRows.forEach(row => {
            attachEventsToRow(row);
            updateRowUOMs(row, true);
            calculateRowTotal(row);
        });
        calculateGrandTotal();
    });
</script>
{% endblock %}
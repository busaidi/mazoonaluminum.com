{% extends "sales/base_sales.html" %}
{% load i18n %}
{% load static %}

{% block title %}
  {{ document.display_number }} – {% trans "مستند مبيعات" %}
{% endblock %}

{% block sales_content %}

<div class="container-fluid px-0 py-3 py-md-4">

  {# ================== Header: عنوان + حالة + أزرار ================== #}
  <div class="d-flex justify-content-between align-items-start mb-3 mb-md-4 flex-wrap gap-3 d-print-none">

    <div class="d-flex flex-column gap-2">
      <div class="d-flex align-items-center flex-wrap gap-2">
        <h1 class="h4 fw-bold mb-0 text-body">
          {{ document.display_number }}
        </h1>

        {# حالة المستند #}
        <span class="badge rounded-pill
              {% if document.status == 'draft' %}
                  text-bg-secondary
              {% elif document.status == 'confirmed' %}
                  text-bg-success
              {% else %}
                  text-bg-danger
              {% endif %}">
          {{ document.get_status_display }}
        </span>

        {# نوع المستند: عرض / أمر #}
        <span class="badge rounded-pill text-bg-info text-dark">
          {{ document.get_kind_display }}
        </span>
      </div>

      <p class="text-muted small mb-0">
        {% trans "عرض تفاصيل المستند كما ستظهر في الطباعة، مع إمكانية التعديل والطباعة." %}
      </p>
    </div>

    {# أزرار الإجراءات #}
    <div class="btn-group btn-group-sm flex-wrap" role="group" aria-label="{% trans 'إجراءات المستند' %}">
      <a href="{% if document.is_quotation %}{% url 'sales:quotation_list' %}{% else %}{% url 'sales:order_list' %}{% endif %}"
         class="btn btn-outline-secondary">
        <i class="bi bi-arrow-right ms-1"></i> {% trans "عودة" %}
      </a>

      {% if document.status == 'draft' %}
        <a href="{% url 'sales:document_edit' document.pk %}" class="btn btn-outline-primary">
          <i class="bi bi-pencil ms-1"></i> {% trans "تعديل" %}
        </a>
        <a href="{% url 'sales:document_delete' document.pk %}"
           class="btn btn-outline-danger"
           onclick="return confirm('{% trans "هل أنت متأكد من الحذف؟" %}')">
          <i class="bi bi-trash ms-1"></i> {% trans "حذف" %}
        </a>
      {% endif %}

      {% if document.status == 'draft' %}
        <a href="{% url 'sales:document_confirm' document.pk %}" class="btn btn-success">
          <i class="bi bi-check-circle ms-1"></i> {% trans "تأكيد" %}
        </a>
      {% endif %}

      {% if document.can_be_converted_to_order %}
        <a href="{% url 'sales:document_convert' document.pk %}" class="btn btn-warning text-dark">
          <i class="bi bi-arrow-repeat ms-1"></i> {% trans "تحويل لأمر بيع" %}
        </a>
      {% endif %}

      <button type="button" class="btn btn-secondary" onclick="window.print()">
        <i class="bi bi-printer ms-1"></i> {% trans "طباعة" %}
      </button>
    </div>

  </div>

  {# ================== تحسينات للطباعة ================== #}
  <style>
    @media print {
      .d-print-none { display: none !important; }
      body { background: #fff !important; }
      .card { box-shadow: none !important; border: 1px solid #dee2e6 !important; }
    }
  </style>

  {# ================== بطاقة المستند ================== #}
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-3 p-md-4 p-lg-5">

      {# --------- الشركة + العميل --------- #}
      <div class="row mb-4 mb-md-5">
        <div class="col-md-6 mb-3 mb-md-0">
          <h4 class="fw-bold text-primary mb-1">
            {% trans "شركة مزون للألمنيوم" %}
          </h4>
          <p class="text-muted small mb-0">
            {% trans "سلطنة عمان" %}<br>
            {% trans "مسقط" %}<br>
            {% trans "هاتف" %}: 99999999
          </p>
        </div>
        <div class="col-md-6 text-md-end">
          <h6 class="fw-bold text-secondary mb-1">
            {% trans "العميل / جهة الاتصال" %}:
          </h6>
          <h5 class="fw-bold mb-1 text-body">
            {{ document.contact.name }}
          </h5>
          <p class="text-muted small mb-0">
            {{ document.contact.address|default:"-" }}
          </p>
          <p class="text-muted small mb-0">
            {{ document.contact.phone|default:"-" }}
          </p>
        </div>
      </div>

      {# --------- معلومات المستند الأساسية --------- #}
      <div class="row gy-3 gx-4 mb-4 bg-body-tertiary rounded-3 px-3 py-3">
        <div class="col-6 col-md-3">
          <div class="small text-muted">{% trans "رقم المستند" %}</div>
          <div class="fw-semibold text-body">{{ document.display_number }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="small text-muted">{% trans "التاريخ" %}</div>
          <div class="fw-semibold text-body">{{ document.date }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="small text-muted">{% trans "تاريخ الانتهاء" %}</div>
          <div class="fw-semibold text-body">
            {{ document.due_date|default:"-" }}
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="small text-muted">{% trans "مرجع العميل" %}</div>
          <div class="fw-semibold text-body">
            {{ document.client_reference|default:"-" }}
          </div>
        </div>
      </div>

      {# ================== جدول البنود ================== #}
      <div class="table-responsive mb-4">
        <table class="table table-sm align-middle mb-0">
          <thead class="bg-body text-muted text-uppercase small">
            <tr>
              <th style="width: 5%" class="text-center border-bottom-0">#</th>
              <th style="width: 35%" class="border-bottom-0">
                {% trans "المنتج" %} / <span class="text-muted">{% trans "الوصف" %}</span>
              </th>
              <th style="width: 10%" class="text-center border-bottom-0">
                {% trans "الكمية" %}
              </th>
              <th style="width: 10%" class="text-center border-bottom-0">
                {% trans "الوحدة" %}
              </th>
              <th style="width: 15%" class="text-center border-bottom-0">
                {% trans "سعر الوحدة" %}
              </th>
              <th style="width: 10%" class="text-center border-bottom-0">
                {% trans "الخصم" %}
              </th>
              <th style="width: 15%" class="text-end border-bottom-0">
                {% trans "الإجمالي" %}
              </th>
            </tr>
          </thead>
          <tbody class="border-top">
            {% for line in document.lines.all %}
              <tr>
                <td class="text-center small text-muted">
                  {{ forloop.counter }}
                </td>
                <td>
                  <div class="fw-semibold text-body">
                    {{ line.product.name }}
                  </div>
                  {% if line.description %}
                    <div class="small text-muted">
                      {{ line.description }}
                    </div>
                  {% endif %}
                </td>
                <td class="text-center">
                  {{ line.quantity }}
                </td>
                <td class="text-center">
                  {{ line.uom.name }}
                </td>
                <td class="text-center">
                  {{ line.unit_price }}
                </td>
                <td class="text-center">
                  {% if line.discount_percent %}
                    {{ line.discount_percent }}%
                  {% else %}
                    –
                  {% endif %}
                </td>
                <td class="text-end fw-semibold">
                  {{ line.line_total }}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted small py-3">
                  {% trans "لا توجد بنود مسجلة في هذا المستند." %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# ================== ملاحظات + الإجماليات ================== #}
      <div class="row g-4">
        <div class="col-md-7">

          {% if document.notes %}
            <div class="mb-3">
              <h6 class="fw-bold text-secondary mb-1">
                {% trans "ملاحظات داخلية" %}
              </h6>
              <div class="text-muted small">
                {{ document.notes|linebreaks }}
              </div>
            </div>
          {% endif %}

          {% if document.customer_notes %}
            <div class="mb-3">
              <h6 class="fw-bold text-secondary mb-1">
                {% trans "شروط وأحكام للعميل" %}
              </h6>
              <div class="text-muted small">
                {{ document.customer_notes|linebreaks }}
              </div>
            </div>
          {% endif %}

        </div>

        <div class="col-md-5 col-lg-4 ms-md-auto">
          <div class="card border-0 bg-body-tertiary">
            <div class="card-body p-3">
              <table class="table table-sm mb-0">
                <tbody>
                  <tr>
                    <td class="border-0 small text-muted">
                      {% trans "الإجمالي قبل الضريبة" %}
                    </td>
                    <td class="border-0 text-end fw-semibold">
                      {{ document.total_before_tax }}
                    </td>
                  </tr>
                  <tr>
                    <td class="border-0 small text-muted">
                      {% trans "الضريبة" %}
                    </td>
                    <td class="border-0 text-end fw-semibold">
                      {{ document.total_tax }}
                    </td>
                  </tr>
                  <tr class="align-middle">
                    <td class="border-0 pt-3 small fw-bold text-secondary">
                      {% trans "الإجمالي النهائي" %}
                    </td>
                    <td class="border-0 pt-3 text-end">
                      <span class="fw-bold text-primary fs-5">
                        {{ document.total_amount }}
                      </span>
                      <span class="small text-muted ms-1">
                        {{ document.currency }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

</div>

{% endblock %}

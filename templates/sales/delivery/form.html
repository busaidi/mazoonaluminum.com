{% extends "sales/base_sales.html" %}
{% load i18n %}

{% block title %}
  {% if delivery %}
    {% trans "ØªØ¹Ø¯ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© ØªØ³Ù„ÙŠÙ…" %}
  {% else %}
    {% trans "Ù…Ø°ÙƒØ±Ø© ØªØ³Ù„ÙŠÙ… Ø¬Ø¯ÙŠØ¯Ø©" %}
  {% endif %}
{% endblock %}

{% block sales_content %}

{# ========== Header ========== #}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div>
    <h1 class="h5 fw-bold mb-1">
      {% if delivery %}
        {% trans "ØªØ¹Ø¯ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© ØªØ³Ù„ÙŠÙ…" %}
      {% else %}
        {% if order %}
          {% trans "Ù…Ø°ÙƒØ±Ø© ØªØ³Ù„ÙŠÙ… Ù„Ø£Ù…Ø± Ø¨ÙŠØ¹" %}
        {% else %}
          {% trans "Ù…Ø°ÙƒØ±Ø© ØªØ³Ù„ÙŠÙ… Ø¬Ø¯ÙŠØ¯Ø©" %}
        {% endif %}
      {% endif %}
    </h1>

    {% if order %}
      <p class="text-muted small mb-0">
        {% trans "Ø±Ø¨Ø· Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ø£Ù…Ø± Ø¨ÙŠØ¹ Ù…Ø­Ø¯Ø¯." %}
      </p>
      <p class="text-muted small mb-0">
        {% trans "Ø£Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹:" %} {{ order.display_number }} â€“ {{ order.contact.name }}
      </p>
    {% else %}
      <p class="text-muted small mb-0">
        {% trans "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø°ÙƒØ±Ø© ØªØ³Ù„ÙŠÙ… Ù…Ø³ØªÙ‚Ù„Ø© Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¨Ù†ÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…." %}
      </p>
    {% endif %}
  </div>

  <div class="d-flex flex-wrap gap-2">
    {% if order %}
      <a href="{% url 'sales:sales_detail' order.pk %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-right-circle ms-1"></i>
        {% trans "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø£Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹" %}
      </a>
    {% endif %}
    <a href="{% url 'sales:delivery_note_list' %}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-list-ul ms-1"></i>
      {% trans "Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…" %}
    </a>
  </div>
</div>

{# ========== Card ========== #}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body">

    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger small mb-3">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      {% if lines_formset.non_form_errors %}
        <div class="alert alert-danger small mb-3">
          {% for err in lines_formset.non_form_errors %}
            <div>{{ err }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {# ========== Header fields ========== #}
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <label class="form-label small">
            {% trans "Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„" %}
          </label>

          {% if order %}
            {{ form.contact.as_hidden }}
            <div class="form-control form-control-sm bg-body-secondary">
              {{ order.contact.name }}
            </div>
          {% else %}
            {{ form.contact }}
            {% if form.contact.errors %}
              <div class="text-danger small mt-1">
                {{ form.contact.errors|join:", " }}
              </div>
            {% endif %}
          {% endif %}
        </div>

        <div class="col-md-3">
          <label class="form-label small" for="{{ form.date.id_for_label }}">
            {{ form.date.label }}
          </label>
          {{ form.date }}
          {% if form.date.errors %}
            <div class="text-danger small mt-1">
              {{ form.date.errors|join:", " }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-5">
          <label class="form-label small" for="{{ form.notes.id_for_label }}">
            {{ form.notes.label }}
          </label>
          {{ form.notes }}
          {% if form.notes.errors %}
            <div class="text-danger small mt-1">
              {{ form.notes.errors|join:", " }}
            </div>
          {% endif %}
        </div>
      </div>

      <hr class="my-3" />

      {# ========== Lines header ========== #}
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
        <div>
          <h2 class="h6 fw-semibold mb-1">
            {% trans "Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…" %}
          </h2>
          <p class="text-muted small mb-0">
            {% trans "Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ØŒ ÙˆØ³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„ÙƒÙ…ÙŠØ©." %}
          </p>
        </div>
      </div>

      {{ lines_formset.management_form }}

      {# ========== Lines table ========== #}
      <div class="table-responsive mb-3">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width: 18%;">{% trans "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬" %}</th>
              <th style="width: 38%;">{% trans "Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„ÙˆØµÙ" %}</th>
              <th style="width: 14%;" class="text-center">{% trans "Ø§Ù„ÙˆØ­Ø¯Ø©" %}</th>
              <th style="width: 14%;" class="text-end">{% trans "Ø§Ù„ÙƒÙ…ÙŠØ©" %}</th>
              {% if lines_formset.can_delete %}
                <th style="width: 6%;" class="text-center">{% trans "Ø­Ø°Ù" %}</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for line_form in lines_formset.forms %}
              <tr class="align-top">
                {# hidden fields (id, Ø¥Ù„Ø®) #}
                {% for hidden in line_form.hidden_fields %}
                  {{ hidden }}
                {% endfor %}

                {# === ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ === #}
                <td class="small">
                  <div class="position-relative">
                    {{ line_form.product_code }}
                    {% if line_form.product_code.help_text %}
                      <div class="form-text small">
                        {{ line_form.product_code.help_text }}
                      </div>
                    {% endif %}
                    {% if line_form.product_code.errors %}
                      <div class="text-danger small mt-1">
                        {{ line_form.product_code.errors|join:", " }}
                      </div>
                    {% endif %}

                    <div class="list-group position-absolute w-100 shadow-sm small d-none product-code-suggestions"
                         style="z-index: 1050; max-height: 220px; overflow-y: auto;"></div>
                  </div>
                </td>

                {# === Ø§Ù„Ø§Ø³Ù… + Ø§Ù„ÙˆØµÙ (Ø²Ø± Ù…ÙŠÙˆØªØŒ ÙˆØµÙ ØªØ­Øª Ø§Ù„Ø§Ø³Ù…) === #}
                <td class="small" style="min-width: 260px;">
                  <div class="d-flex align-items-center gap-1 mb-1">
                    <button type="button"
                            class="btn btn-link btn-sm text-muted description-toggle-btn p-0"
                            title="{% trans 'Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØµÙ' %}"
                            onclick="toggleDeliveryDescription(this); return false;">
                      <i class="bi bi-card-text"></i>
                    </button>
                    <input type="text"
                           class="form-control form-control-sm product-name-input"
                           data-role="product-name"
                           value=""
                           placeholder="{% trans 'Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙˆØ¯' %}"
                           readonly>
                  </div>

                  <div class="line-description-container{% if not line_form.description.value and not line_form.description.errors %} d-none{% endif %}">
                    {{ line_form.description }}
                    {% if line_form.description.errors %}
                      <div class="text-danger small mt-1">
                        {{ line_form.description.errors|join:", " }}
                      </div>
                    {% endif %}
                  </div>

                  {# ğŸ‘‡ Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (FK) â€“ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ø´Ø§Ù† ÙŠØ­ÙØ¸ #}
                  <div class="d-none">
                    {{ line_form.product }}
                  </div>

                  {% if line_form.product.errors %}
                    <div class="text-danger small mt-1">
                      {{ line_form.product.errors|join:", " }}
                    </div>
                  {% endif %}
                </td>

                {# === Ø§Ù„ÙˆØ­Ø¯Ø©: Ø³Ù„ÙƒØª Ø¸Ø§Ù‡Ø± (base/alt) + Ø³Ù„ÙƒØª Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø®ÙÙŠ === #}
                <td class="small text-center align-top">
                  <select class="form-select form-select-sm uom-select"
                          aria-label="{% trans 'Ø§Ù„ÙˆØ­Ø¯Ø©' %}">
                    <option value="">{% trans "â€”" %}</option>
                  </select>

                  <div class="d-none">
                    {{ line_form.uom }}
                  </div>

                  {% if line_form.uom.errors %}
                    <div class="text-danger small mt-1">
                      {{ line_form.uom.errors|join:", " }}
                    </div>
                  {% endif %}
                </td>

                {# === Ø§Ù„ÙƒÙ…ÙŠØ© === #}
                <td class="text-end small align-top">
                  {{ line_form.quantity }}
                  {% if line_form.quantity.errors %}
                    <div class="text-danger small mt-1 text-start">
                      {{ line_form.quantity.errors|join:", " }}
                    </div>
                  {% endif %}
                </td>

                {% if lines_formset.can_delete %}
                  <td class="text-center small align-top">
                    <div class="form-check d-flex justify-content-center">
                      {{ line_form.DELETE }}
                    </div>
                  </td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <p class="text-muted small mb-3">
        {% trans "ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ø§Ù„Ø³Ø·ÙˆØ± Ø§Ù„ÙØ§Ø±ØºØ© ÙƒÙ…Ø§ Ù‡ÙŠØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø­Ø°Ù Ù„Ø¥Ø²Ø§Ù„ØªÙ‡Ø§." %}
      </p>

      <hr class="my-3" />

      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'sales:delivery_note_list' %}" class="btn btn-sm btn-outline-secondary">
          {% trans "Ø¥Ù„ØºØ§Ø¡" %}
        </a>
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="bi bi-check2 ms-1"></i>
          {% if delivery %}
            {% trans "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" %}
          {% else %}
            {% trans "Ø­ÙØ¸ Ù…Ø°ÙƒØ±Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…" %}
          {% endif %}
        </button>
      </div>

    </form>
  </div>
</div>

{% block extra_body %}
<script>
  (function () {
    const productApiSearchUrl   = "{% url 'sales:product_api_search' %}";
    const productApiUomTemplate = "{% url 'sales:product_api_uom' 0 %}";
    const productApiUomBaseUrl  = productApiUomTemplate.replace(/0\/?$/, "");

    document.addEventListener("DOMContentLoaded", function () {
      const rows = document.querySelectorAll("table tbody tr");

      rows.forEach(function (row) {
        const els = getRowElements(row);
        if (!els.codeInput) return;

        // Ù„Ùˆ ÙÙŠÙ‡ ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø² (Ù…Ù† Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù…Ø«Ù„Ø§Ù‹) â†’ Ø­Ø§ÙˆÙ„ ØªØ­Ù„Ù‘Ù‡ ÙˆØªØ¬ÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬ + UoM
        if ((els.codeInput.value || "").trim() !== "") {
          resolveExactCode(els);
        } else if (els.productField && els.productField.value) {
          // fallback: Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªØ¹Ø¨Ù‘ÙŠ ÙˆØ§Ù„Ù€ code ÙØ§Ø¶ÙŠ
          loadUom(els.productField.value, els, { keepExisting: true });
        }

        // Ø£ÙˆØªÙˆÙƒÙˆÙ…Ø¨Ù„ÙŠØª Ø§Ù„ÙƒÙˆØ¯
        els.codeInput.addEventListener("input", function () {
          handleSuggestions(els);
        });

        els.codeInput.addEventListener("blur", function () {
          setTimeout(function () {
            if (els.suggestions) {
              els.suggestions.classList.add("d-none");
            }
          }, 200);
        });

        els.codeInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            resolveExactCode(els);
          }
          if (e.key === "Escape" && els.suggestions) {
            els.suggestions.classList.add("d-none");
          }
        });

        // Ø²Ø± Ø§Ù„ÙˆØµÙ: Ù†Ù„ÙˆÙ‘Ù† Ø§Ù„Ø²Ø± Ù„Ùˆ ÙÙŠÙ‡ ÙˆØµÙ Ø³Ø§Ø¨Ù‚
        const container = row.querySelector(".line-description-container");
        const btn = row.querySelector(".description-toggle-btn");
        const field = container ? container.querySelector("textarea, input") : null;

        if (btn && container && field) {
          if ((field.value || "").trim() !== "") {
            container.classList.remove("d-none");
            btn.classList.remove("text-muted");
            btn.classList.add("text-body");
          }
        }

        // ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© â†’ Ø­Ø¯Ù‘Ø« Ø§Ù„Ø³Ù„ÙƒØª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        if (els.uomSelect) {
          els.uomSelect.addEventListener("change", function () {
            updateRealUomFromKind(els);
          });
        }
      });
    });

    function getRowElements(row) {
      return {
        row:             row,
        codeInput:       row.querySelector('input[name$="-product_code"]'),
        nameInput:       row.querySelector(".product-name-input"),
        productField:    row.querySelector('[name$="-product"]'),
        suggestions:     row.querySelector(".product-code-suggestions"),
        uomSelect:       row.querySelector(".uom-select"),
        realUomSelect:   row.querySelector('select[name$="-uom"]'),
      };
    }

    function setProductForRow(els, productObj) {
      if (!els.productField || !els.nameInput || !els.codeInput) return;

      if (productObj) {
        els.productField.value = productObj.id;
        if (productObj.code) {
          els.codeInput.value = productObj.code;
        }
        els.nameInput.value = productObj.name
          ? (productObj.name + " (" + productObj.code + ")")
          : (productObj.code || "");
        els.codeInput.classList.remove("is-invalid");
      } else {
        els.productField.value = "";
        els.nameInput.value = "";
        if ((els.codeInput.value || "").trim() !== "") {
          els.codeInput.classList.add("is-invalid");
        } else {
          els.codeInput.classList.remove("is-invalid");
        }
      }
    }

    function applySelection(els, productObj) {
      if (!els) return;
      setProductForRow(els, productObj);

      if (productObj && productObj.id) {
        loadUom(productObj.id, els, { keepExisting: false });
      } else {
        resetUom(els);
      }

      if (els.suggestions) {
        els.suggestions.classList.add("d-none");
        els.suggestions.innerHTML = "";
      }
    }

    function resolveExactCode(els) {
      const code = (els.codeInput.value || "").trim();
      if (!code) {
        setProductForRow(els, null);
        resetUom(els);
        return;
      }

      fetch(productApiSearchUrl + "?q=" + encodeURIComponent(code))
        .then((r) => r.json())
        .then((data) => {
          const results = data.results || [];
          if (!results.length) {
            setProductForRow(els, null);
            resetUom(els);
            return;
          }
          const lower = code.toLowerCase();
          const exact = results.find((p) => (p.code || "").toLowerCase() === lower);
          applySelection(els, exact || results[0]);
        })
        .catch(() => {
          setProductForRow(els, null);
          resetUom(els);
        });
    }

    function handleSuggestions(els) {
      if (!els.suggestions) return;

      const query = (els.codeInput.value || "").trim();
      els.suggestions.innerHTML = "";

      if (!query) {
        els.suggestions.classList.add("d-none");
        return;
      }

      fetch(productApiSearchUrl + "?q=" + encodeURIComponent(query))
        .then((r) => r.json())
        .then((data) => {
          const results = data.results || [];
          if (!results.length) {
            els.suggestions.classList.add("d-none");
            return;
          }

          results.slice(0, 15).forEach((item) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "list-group-item list-group-item-action";
            btn.textContent = item.name
              ? (item.code + " â€“ " + item.name)
              : (item.code || "");

            btn.addEventListener("click", function () {
              applySelection(els, item);
            });

            els.suggestions.appendChild(btn);
          });

          els.suggestions.classList.remove("d-none");
        })
        .catch(() => {
          els.suggestions.classList.add("d-none");
        });
    }

    // ========== UoM logic (base / alt ÙÙ‚Ø·) ==========
    function resetUom(els) {
      if (!els.uomSelect) return;

      els.uomSelect.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "â€”";
      els.uomSelect.appendChild(opt);
      els.uomSelect.dataset.baseUomLabel = "";
      els.uomSelect.dataset.altUomLabel = "";

      if (els.realUomSelect) {
        els.realUomSelect.value = "";
      }
    }

    function loadUom(productId, els, opts) {
      opts = opts || {};
      if (!els.uomSelect || !productId) {
        resetUom(els);
        return;
      }

      const url = productApiUomBaseUrl + productId + "/";

      fetch(url)
        .then((res) => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then((data) => {
          fillUomFromData(els, data, opts);
        })
        .catch(() => {
          resetUom(els);
        });
    }

    function fillUomFromData(els, data, opts) {
      opts = opts || {};
      const select = els.uomSelect;
      if (!select) return;

      const baseLabel = data.base_uom || "";
      const altLabel  = data.alt_uom || "";

      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "â€”";
      select.appendChild(placeholder);

      select.dataset.baseUomLabel = baseLabel;
      select.dataset.altUomLabel  = altLabel;

      let hasBase = !!baseLabel;
      let hasAlt  = !!altLabel;

      if (hasBase) {
        const optBase = document.createElement("option");
        optBase.value = "base";
        optBase.textContent = baseLabel + " â€“ {% trans 'Ø£Ø³Ø§Ø³ÙŠØ©' %}";
        select.appendChild(optBase);
      }

      if (hasAlt) {
        const optAlt = document.createElement("option");
        optAlt.value = "alt";
        optAlt.textContent = altLabel + " â€“ {% trans 'Ø¨Ø¯ÙŠÙ„Ø©' %}";
        select.appendChild(optAlt);
      }

      let kindToSelect = "";

      // Ù„Ùˆ ÙÙŠÙ‡ Ù‚ÙŠÙ…Ø© Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù€ select Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø­Ø§ÙˆÙ„ ØªØ±Ø¨Ø·Ù‡Ø§
      if (els.realUomSelect && els.realUomSelect.value) {
        const realOpt = els.realUomSelect.options[els.realUomSelect.selectedIndex];
        const txt = realOpt ? realOpt.textContent.trim() : "";
        if (baseLabel && txt && (txt === baseLabel || txt.indexOf(baseLabel) !== -1)) {
          kindToSelect = "base";
        } else if (altLabel && txt && (txt === altLabel || txt.indexOf(altLabel) !== -1)) {
          kindToSelect = "alt";
        }
      }

      if (!kindToSelect) {
        if (hasBase) kindToSelect = "base";
        else if (hasAlt) kindToSelect = "alt";
      }

      if (kindToSelect) {
        select.value = kindToSelect;
      } else {
        select.value = "";
      }

      updateRealUomFromKind(els);
    }

    function updateRealUomFromKind(els) {
      if (!els.uomSelect || !els.realUomSelect) return;

      const kind = els.uomSelect.value; // base | alt | ""
      const baseLabel = els.uomSelect.dataset.baseUomLabel || "";
      const altLabel  = els.uomSelect.dataset.altUomLabel  || "";

      let targetLabel = "";
      if (kind === "base") {
        targetLabel = baseLabel;
      } else if (kind === "alt") {
        targetLabel = altLabel;
      } else {
        els.realUomSelect.value = "";
        return;
      }

      if (!targetLabel) {
        els.realUomSelect.value = "";
        return;
      }

      const opts = els.realUomSelect.options;
      let found = false;
      for (let i = 0; i < opts.length; i++) {
        const txt = opts[i].textContent.trim();
        if (txt === targetLabel || txt.indexOf(targetLabel) !== -1) {
          els.realUomSelect.value = opts[i].value;
          found = true;
          break;
        }
      }

      if (!found) {
        els.realUomSelect.value = "";
      }
    }

    // ========== ÙˆØµÙ Ø§Ù„Ø³Ø·Ø± ==========
    window.toggleDeliveryDescription = function (btn) {
      const row = btn.closest("tr");
      if (!row) return;

      const container = row.querySelector(".line-description-container");
      if (!container) return;

      const field = container.querySelector("textarea, input");
      const willShow = container.classList.contains("d-none");

      container.classList.toggle("d-none");

      if (willShow) {
        btn.classList.remove("text-muted");
        btn.classList.add("text-body");
        if (field) field.focus();
      } else {
        btn.classList.remove("text-body");
        btn.classList.add("text-muted");
      }
    };
  })();
</script>
{% endblock %}

{% endblock %}

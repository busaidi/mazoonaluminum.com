{% extends "sales/base_sales.html" %}
{% load i18n static %}

{% block title %}{% trans "تسليم مباشر" %}{% endblock %}

{% block sales_content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-truck-flatbed"></i> {% trans "إنشاء تسليم مباشر (بدون أمر)" %}
        </h6>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <div class="row mb-3">
                <div class="col-md-6">
                    <label>{% trans "العميل" %}</label>
                    {{ form.contact }}
                </div>
                <div class="col-md-3">
                    <label>{% trans "التاريخ" %}</label>
                    {{ form.date }}
                </div>
                <div class="col-md-12 mt-2">
                    <label>{% trans "ملاحظات" %}</label>
                    {{ form.notes }}
                </div>
            </div>

            <hr>
            <h5>{% trans "المواد المسلمة" %}</h5>
            {{ lines.management_form }}
            {{ lines.non_form_errors }}

            <div class="table-responsive">
                <table class="table table-bordered" id="lines-table">
                    <thead class="table-light">
                        <tr>
                            <th width="30%">{% trans "المنتج" %}</th>
                            <th width="25%">{% trans "الوصف" %}</th>
                            <th width="15%">{% trans "الكمية" %}</th>
                            <th width="15%">{% trans "الوحدة" %}</th>
                            <th width="5%">❌</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line_form in lines %}
                            <tr class="line-form-row">
                                {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
                                <td>{{ line_form.product }}</td>
                                <td>{{ line_form.description }}</td>
                                <td>{{ line_form.quantity }}</td>
                                <td>{{ line_form.uom }}</td>
                                <td class="text-center">
                                    {% if lines.can_delete %}{{ line_form.DELETE }}{% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn btn-sm btn-success mb-4" id="add-line-btn">
                <i class="bi bi-plus-lg"></i> {% trans "إضافة سطر" %}
            </button>

            <div class="text-center">
                <button type="submit" class="btn btn-primary px-5">{% trans "حفظ التسليم" %}</button>
                <a href="{% url 'sales:delivery_list' %}" class="btn btn-secondary">{% trans "إلغاء" %}</a>
            </div>
        </form>
    </div>
</div>

<table style="display:none;">
    <tr id="empty-form-row" class="line-form-row">
        <td>{{ lines.empty_form.product }}</td>
        <td>{{ lines.empty_form.description }}</td>
        <td>{{ lines.empty_form.quantity }}</td>
        <td>{{ lines.empty_form.uom }}</td>
        <td class="text-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-row-btn">x</button>
        </td>
    </tr>
</table>
{% endblock %}

{% block extra_body %}
{{ products_dict|json_script:"products-data" }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const productsData = JSON.parse(document.getElementById('products-data').textContent);
    const tableBody = document.querySelector('#lines-table tbody');
    const totalFormsInput = document.getElementById('id_lines-TOTAL_FORMS');
    const emptyRowTemplate = document.getElementById('empty-form-row');

    function handleProductChange(row) {
        const productSelect = row.querySelector('.product-select');
        const uomSelect = row.querySelector('.uom-select');
        const productId = productSelect.value;

        if (productId && productsData[productId]) {
            const data = productsData[productId];
            uomSelect.innerHTML = '';
            if (data.base_uom_id) uomSelect.add(new Option(data.base_uom_name, data.base_uom_id));
            if (data.alt_uom_id) uomSelect.add(new Option(data.alt_uom_name, data.alt_uom_id));
        }
    }

    tableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-select')) {
            handleProductChange(e.target.closest('tr'));
        }
    });

    document.getElementById('add-line-btn').addEventListener('click', function() {
        const formIdx = totalFormsInput.value;
        const newRow = emptyRowTemplate.cloneNode(true);
        newRow.removeAttribute('id');
        newRow.style.display = 'table-row';
        newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formIdx);

        newRow.querySelector('.remove-row-btn').addEventListener('click', function() {
            newRow.remove();
        });

        tableBody.appendChild(newRow);
        totalFormsInput.value = parseInt(formIdx) + 1;
    });
});
</script>
{% endblock %}
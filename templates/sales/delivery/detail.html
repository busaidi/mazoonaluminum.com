{# templates/sales/delivery/detail.html #}
{% extends "sales/base_sales.html" %}
{% load i18n %}

{% block title %}
  {{ delivery.display_number }} – {% trans "مذكرة تسليم" %}
{% endblock %}

{% block sales_content %}

{# ======= العنوان + الأكشنز ======= #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h5 fw-bold mb-1">
      {% trans "مذكرة تسليم" %} <span dir="ltr">{{ delivery.display_number }}</span>
    </h1>
    <p class="text-muted small mb-0">
      {% if delivery.order %}
        {% trans "مرتبطة بأمر البيع" %}:
        {# تفاصيل أمر البيع → sales_detail #}
        <a href="{% url 'sales:sales_detail' delivery.order.pk %}"
           class="text-decoration-none" dir="ltr">
          {{ delivery.order.display_number }}
        </a>
        {% if delivery.order.contact %}
          – {{ delivery.order.contact.name }}
        {% endif %}
      {% else %}
        {% trans "لا يوجد أمر بيع مرتبط." %}
      {% endif %}
    </p>
  </div>

  <div class="d-flex flex-wrap gap-2 align-items-center">

    {# حالة مذكرة التسليم #}
    {% if delivery.status == delivery.Status.DRAFT %}
      <span class="badge bg-secondary px-3 py-2">
        {{ delivery.get_status_display }}
      </span>
    {% elif delivery.status == delivery.Status.CONFIRMED %}
      <span class="badge bg-success px-3 py-2">
        {{ delivery.get_status_display }}
      </span>
    {% elif delivery.status == delivery.Status.CANCELLED %}
      <span class="badge bg-danger px-3 py-2">
        {{ delivery.get_status_display }}
      </span>
    {% endif %}

    {# قائمة مذكرات التسليم #}
    <a href="{% url 'sales:delivery_note_list' %}"
       class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-list-ul ms-1"></i>
      {% trans "مذكرات التسليم" %}
    </a>

    {% if delivery.order %}
      {# الرجوع لأمر البيع → sales_detail #}
      <a href="{% url 'sales:sales_detail' delivery.order.pk %}"
         class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-right-short"></i>
        {% trans "أمر البيع" %}
      </a>
    {% endif %}

  </div>
</div>

{# ======= معلومات الرأس ======= #}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body small">

    <div class="row g-3">
      <div class="col-md-4">
        <div class="text-muted mb-1">{% trans "رقم مذكرة التسليم" %}</div>
        <div dir="ltr" class="fw-bold">
          {{ delivery.display_number }}
        </div>
      </div>

      <div class="col-md-4">
        <div class="text-muted mb-1">{% trans "تاريخ التسليم" %}</div>
        <div>
          {{ delivery.date|date:"Y-m-d" }}
        </div>
      </div>

      <div class="col-md-4">
        <div class="text-muted mb-1">{% trans "تاريخ الإنشاء" %}</div>
        <div>
          {{ delivery.created_at|date:"Y-m-d H:i" }}
        </div>
      </div>

      {% if delivery.order %}
        <div class="col-md-6">
          <div class="text-muted mb-1">{% trans "أمر البيع" %}</div>
          <div>
            <a href="{% url 'sales:sales_detail' delivery.order.pk %}"
               class="text-decoration-none" dir="ltr">
              {{ delivery.order.display_number }}
            </a>
          </div>
        </div>

        <div class="col-md-6">
          <div class="text-muted mb-1">{% trans "العميل" %}</div>
          <div>
            {% if delivery.order.contact %}
              <a href="{% url 'contacts:contact_detail' delivery.order.contact.pk %}"
                 class="text-decoration-none">
                {{ delivery.order.contact.name }}
              </a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

  </div>
</div>

{# ======= بنود التسليم ======= #}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <span class="feature-icon">
        <i class="bi bi-box-arrow-down"></i>
      </span>
      <div>
        <h2 class="h6 fw-bold mb-0">
          {% trans "بنود مذكرة التسليم" %}
        </h2>
        <p class="text-muted small mb-0">
          {% trans "المنتجات / العناصر التي تم تسليمها ضمن هذه المذكرة." %}
        </p>
      </div>
    </div>
  </div>

  <div class="card-body small">

    {% if delivery.lines.all %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="small text-muted">{% trans "م" %}</th>
              <th class="small text-muted">{% trans "الوصف" %}</th>
              <th class="small text-muted">{% trans "المنتج" %}</th>
              <th class="small text-muted text-end">{% trans "الكمية المسلّمة" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for line in delivery.lines.all %}
              <tr>
                <td class="small text-nowrap">
                  {{ forloop.counter }}
                </td>
                <td class="small">
                  {{ line.display_name }}
                </td>
                <td class="small">
                  {% if line.product %}
                    {{ line.product.name }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="small text-end text-nowrap">
                  {{ line.quantity }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted mb-0">
        {% trans "لا توجد بنود تسليم مسجلة في هذه المذكرة." %}
      </p>
    {% endif %}

  </div>
</div>

{# ======= الملاحظات ======= #}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-header bg-white border-0">
    <h2 class="h6 fw-bold mb-0">
      {% trans "ملاحظات" %}
    </h2>
  </div>
  <div class="card-body small">
    {% if delivery.notes %}
      <p class="mb-0">
        {{ delivery.notes|linebreaksbr }}
      </p>
    {% else %}
      <p class="text-muted mb-0">
        {% trans "لا توجد ملاحظات مضافة لهذه المذكرة." %}
      </p>
    {% endif %}
  </div>
</div>

{% endblock %}

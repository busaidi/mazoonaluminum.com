{% extends "sales/base_sales.html" %}
{% load i18n humanize %}

{% block title %}{{ delivery.display_number }} | {% trans "تفاصيل التسليم" %}{% endblock %}

{% block sales_content %}

<div class="card shadow-sm border-0">
    {# ================= HEADER ================= #}
    <div class="card-header bg-white py-3">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">

            <div>
                <h1 class="h5 fw-bold mb-1 font-monospace text-body">
                    {{ delivery.display_number }}
                </h1>

                <div class="d-flex align-items-center flex-wrap gap-2">

                    {% if delivery.status == 'draft' %}
                        <span class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle">
                            <i class="bi bi-pencil"></i> {% trans "مسودة" %}
                        </span>
                    {% elif delivery.status == 'confirmed' %}
                        <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">
                            <i class="bi bi-check-circle"></i> {% trans "تم التسليم" %}
                        </span>
                    {% elif delivery.status == 'cancelled' %}
                        <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle">
                            <i class="bi bi-x-circle"></i> {% trans "ملغي" %}
                        </span>
                    {% endif %}

                    <span class="text-muted small">
                        <i class="bi bi-calendar3 me-1"></i>
                        {{ delivery.date|date:"Y-m-d" }}
                    </span>
                </div>
            </div>

            {# ================= ACTIONS (فوق) ================= #}
            <div class="d-flex flex-wrap gap-2">

                {% if delivery.status == 'draft' %}
                    <a href="{% url 'sales:delivery_confirm' delivery.pk %}"
                       class="btn btn-success btn-sm"
                       onclick="return confirm('{% trans "تأكيد التسليم؟ سيتم خصم الكميات فوراً." %}')">
                        <i class="bi bi-check2-all"></i> {% trans "تأكيد" %}
                    </a>
                {% endif %}

                {% if not delivery.order and delivery.contact and link_order_form %}
                    <button class="btn btn-warning btn-sm text-dark"
                            data-bs-toggle="modal" data-bs-target="#linkOrderModal">
                        <i class="bi bi-link-45deg"></i> {% trans "ربط بأمر" %}
                    </button>
                {% endif %}

                <a href="{% url 'sales:delivery_delete' delivery.pk %}"
                   class="btn btn-outline-danger btn-sm"
                   onclick="return confirm('{% trans "هل أنت متأكد من حذف هذا السجل؟" %}')">
                    <i class="bi bi-trash"></i>
                </a>

                <button class="btn btn-light btn-sm border" onclick="window.print()">
                    <i class="bi bi-printer"></i> {% trans "طباعة" %}
                </button>
            </div>

        </div>
    </div>

    {# ================== INFO BLOCK ================== #}
    <div class="card-body bg-body-tertiary border-bottom">
        <div class="row g-3">

            <div class="col-md-6">
                <small class="text-muted fw-semibold d-block mb-1">{% trans "أمر البيع" %}</small>

                {% if delivery.order %}
                    <a href="{% url 'sales:document_detail' delivery.order.pk %}"
                       class="text-decoration-none">
                        <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
                            <i class="bi bi-link-45deg"></i> {{ delivery.order.display_number }}
                        </span>
                    </a>
                {% else %}
                    <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">
                        {% trans "تسليم مباشر" %}
                    </span>
                {% endif %}
            </div>

            <div class="col-md-6">
                <small class="text-muted fw-semibold d-block mb-1">{% trans "العميل" %}</small>
                <div class="fw-semibold">{{ delivery.contact.name }}</div>

                {% if delivery.contact.phone %}
                    <div class="text-muted small">
                        <i class="bi bi-telephone"></i> {{ delivery.contact.phone }}
                    </div>
                {% endif %}
            </div>

            {% if delivery.notes %}
            <div class="col-md-12">
                <small class="text-muted fw-semibold d-block mb-1">{% trans "ملاحظات" %}</small>
                <p class="small mb-0">{{ delivery.notes|linebreaksbr }}</p>
            </div>
            {% endif %}

        </div>
    </div>

    {# ================== LINES TABLE ================== #}
    <div class="table-responsive">
        <table class="table table-striped mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th width="5%">#</th>
                    <th width="45%">{% trans "المنتج / الوصف" %}</th>
                    <th width="15%" class="text-center">{% trans "الكمية" %}</th>
                    <th width="15%" class="text-center">{% trans "الوحدة" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for line in delivery.lines.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <div class="fw-semibold">{{ line.product.name }}</div>
                            {% if line.description %}
                                <div class="small text-muted">{{ line.description }}</div>
                            {% endif %}
                        </td>
                        <td class="text-center fw-bold">{{ line.quantity|floatformat:3 }}</td>
                        <td class="text-center small">{{ line.uom.name }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4 text-muted">
                            {% trans "لا توجد بنود." %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# ================== FOOTER ================== #}
    <div class="card-footer bg-white small text-muted text-end">
        {% trans "تم الإنشاء بواسطة" %}:
        {% if delivery.created_by %}
            {{ delivery.created_by.get_full_name|default:delivery.created_by.username }}
        {% else %}
            <span class="text-muted">{% trans "غير محدد" %}</span>
        {% endif %}
        | {{ delivery.created_at|timesince }}
    </div>
</div>



{# ================== MODAL: ربط بأمر بيع ================== #}
{% if link_order_form %}
<div class="modal fade" id="linkOrderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form method="post" action="{% url 'sales:delivery_link_order' delivery.pk %}">
            {% csrf_token %}
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">{% trans "ربط بأمر بيع موجود" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-info small">
                        {% trans "ستظهر فقط الأوامر المؤكدة الخاصة بهذا العميل." %}
                    </div>

                    {{ link_order_form.order.label_tag }}
                    {{ link_order_form.order }}
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        {% trans "إلغاء" %}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        {% trans "حفظ" %}
                    </button>
                </div>

            </div>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}

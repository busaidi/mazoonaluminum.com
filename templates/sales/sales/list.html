{% extends "sales/base_sales.html" %}
{% load i18n humanize %}

{% block sales_content %}

<div class="card shadow-sm border-0">
  <div class="card-header bg-body py-3 d-flex justify-content-between align-items-center">
    <h5 class="m-0 fw-bold text-body">
      <i class="bi bi-list-ul me-1"></i>
      {% trans "سجل المبيعات" %}
    </h5>
    <a href="{% url 'sales:document_create' %}" class="btn btn-primary btn-sm shadow-sm">
      <i class="bi bi-plus-lg me-1"></i>
      {% trans "مستند جديد" %}
    </a>
  </div>

  <div class="card-body">

    {# ===================== FILTER BAR ===================== #}
    <form method="get" class="row g-2 mb-4 bg-body-secondary p-3 rounded-3">
      <div class="col-md-5">
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-body border-end-0">
            <i class="bi bi-search"></i>
          </span>
          <input type="text"
                 name="q"
                 class="form-control border-start-0"
                 placeholder="{% trans 'بحث برقم المستند، اسم العميل، مرجع العميل...' %}"
                 value="{{ current_q }}">
        </div>
      </div>

      <div class="col-md-3">
        <select name="status" class="form-select form-select-sm">
          <option value="">{% trans "-- كل الحالات --" %}</option>
          {% for key, label in status_choices %}
            <option value="{{ key }}" {% if current_status == key %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <button type="submit" class="btn btn-dark btn-sm w-100">
          {% trans "تصفية" %}
        </button>
      </div>

      {% if current_q or current_status %}
        <div class="col-md-2">
          <a href="{% url 'sales:document_list' %}" class="btn btn-outline-secondary btn-sm w-100">
            {% trans "إلغاء الفلاتر" %}
          </a>
        </div>
      {% endif %}
    </form>

    {# ===================== TABLE ===================== #}
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr class="small text-muted">
            <th width="15%">{% trans "الرقم" %}</th>
            <th width="25%">{% trans "العميل" %}</th>
            <th width="12%">{% trans "التاريخ" %}</th>
            <th width="18%">{% trans "حالة المستند" %}</th>
            <th width="15%" class="text-end">{% trans "الإجمالي" %}</th>
            <th width="15%" class="text-center">{% trans "حالة التسليم" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for doc in documents %}
            <tr>
              {# رقم المستند #}
              <td class="fw-semibold font-monospace">
                <a href="{% url 'sales:document_detail' doc.pk %}"
                   class="text-decoration-none text-body">
                  {{ doc.display_number }}
                </a>
              </td>

              {# العميل + مرجع العميل #}
              <td>
                <div class="fw-semibold text-body">
                  {{ doc.contact.name }}
                </div>
                {% if doc.client_reference %}
                  <div class="text-muted small">
                    <i class="bi bi-hash"></i>
                    {{ doc.client_reference }}
                  </div>
                {% endif %}
              </td>

              {# التاريخ #}
              <td class="text-muted small">
                <i class="bi bi-calendar3 me-1"></i>
                {{ doc.date|date:"Y-m-d" }}
              </td>

              {# حالة المستند #}
              <td>
                {% if doc.status == 'draft' %}
                  <span class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle">
                    {% trans "مسودة" %}
                  </span>
                {% elif doc.status == 'sent' %}
                  <span class="badge rounded-pill bg-info-subtle text-info border border-info-subtle">
                    {% trans "مرسل" %}
                  </span>
                {% elif doc.status == 'confirmed' %}
                  <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">
                    <i class="bi bi-check-circle-fill me-1"></i>
                    {% trans "أمر بيع مؤكد" %}
                  </span>
                {% elif doc.status == 'cancelled' %}
                  <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle">
                    {% trans "ملغي" %}
                  </span>
                {% else %}
                  <span class="badge bg-light text-muted">
                    {{ doc.get_status_display }}
                  </span>
                {% endif %}
              </td>

              {# الإجمالي #}
              <td class="text-end fw-semibold text-body">
                {{ doc.total_amount|floatformat:3|intcomma }}
                <small class="text-muted">
                  {{ doc.currency }}
                </small>
              </td>

              {# حالة التسليم #}
              <td class="text-center">
                {% if doc.is_order %}
                  {% if doc.delivery_status == 'pending' %}
                    <span class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle"
                          title="{% trans 'بانتظار التسليم' %}">
                      <i class="bi bi-hourglass-split me-1"></i>
                      {% trans "قيد الانتظار" %}
                    </span>
                  {% elif doc.delivery_status == 'partial' %}
                    <span class="badge rounded-pill bg-warning-subtle text-warning border border-warning-subtle"
                          title="{% trans 'تسليم جزئي' %}">
                      <i class="bi bi-pie-chart-fill me-1"></i>
                      {% trans "جزئي" %}
                    </span>
                  {% elif doc.delivery_status == 'delivered' %}
                    <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle"
                          title="{% trans 'تم التسليم بالكامل' %}">
                      <i class="bi bi-check-all me-1"></i>
                      {% trans "مكتمل" %}
                    </span>
                  {% else %}
                    <span class="badge bg-light text-muted">
                      {{ doc.get_delivery_status_display }}
                    </span>
                  {% endif %}
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="text-muted mb-3">
                  <i class="bi bi-inbox fs-1"></i>
                </div>
                <h6 class="fw-bold mb-1">
                  {% trans "لا توجد مستندات" %}
                </h6>
                <p class="text-muted small mb-3">
                  {% trans "لم يتم العثور على سجلات تطابق بحثك الحالي." %}
                </p>
                <a href="{% url 'sales:document_create' %}"
                   class="btn btn-sm btn-primary">
                  <i class="bi bi-plus-lg me-1"></i>
                  {% trans "إنشاء مستند جديد" %}
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# ===================== PAGINATION ===================== #}
    {% if is_paginated %}
      <nav class="mt-4">
        <ul class="pagination justify-content-center small mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.previous_page_number }}&q={{ current_q }}&status={{ current_status }}">
                {% trans "السابق" %}
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">
                {% trans "السابق" %}
              </span>
            </li>
          {% endif %}

          <li class="page-item active">
            <span class="page-link">
              {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
            </span>
          </li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.next_page_number }}&q={{ current_q }}&status={{ current_status }}">
                {% trans "التالي" %}
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">
                {% trans "التالي" %}
              </span>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  </div>
</div>

{% endblock %}

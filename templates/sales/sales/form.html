{% extends "sales/base_sales.html" %}
{% load i18n %}

{% block title %}
  {% trans "مستند مبيعات" %}
{% endblock %}

{% block sales_content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h5 fw-bold mb-1">
      {% if document %}
        {% trans "تعديل مستند مبيعات" %}
      {% else %}
        {% trans "إنشاء مستند مبيعات" %}
      {% endif %}
    </h1>
    <p class="text-muted small mb-0">
      {% trans "إدارة عروض الأسعار وأوامر البيع." %}
    </p>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">

    <form method="post" novalidate>
      {% csrf_token %}

      {{ form.non_field_errors }}

      {# ================== Header fields ================== #}
      <div class="row g-3">

        <!-- العميل -->
        <div class="col-md-8">
          <label for="{{ form.contact.id_for_label }}" class="form-label small fw-bold">
            {% trans "العميل" %}
          </label>
          {{ form.contact }}
          <div class="text-danger small">
            {{ form.contact.errors }}
          </div>
        </div>

        <!-- التاريخ -->
        <div class="col-md-4">
          <label for="{{ form.date.id_for_label }}" class="form-label small fw-bold">
            {% trans "التاريخ" %}
          </label>
          {{ form.date }}
          <div class="text-danger small">
            {{ form.date.errors }}
          </div>
        </div>

        <!-- تاريخ الانتهاء -->
        <div class="col-md-4">
          <label for="{{ form.due_date.id_for_label }}" class="form-label small fw-bold">
            {% trans "تاريخ الانتهاء" %}
          </label>
          {{ form.due_date }}
          <div class="text-danger small">
            {{ form.due_date.errors }}
          </div>
        </div>

        <!-- ملاحظات داخلية -->
        <div class="col-12">
          <label for="{{ form.notes.id_for_label }}" class="form-label small fw-bold">
            {% trans "ملاحظات داخلية" %}
          </label>
          {{ form.notes }}
          <div class="text-danger small">
            {{ form.notes.errors }}
          </div>
        </div>

        <!-- ملاحظات للعميل -->
        <div class="col-12">
          <label for="{{ form.customer_notes.id_for_label }}" class="form-label small fw-bold">
            {% trans "ملاحظات للعميل" %}
          </label>
          {{ form.customer_notes }}
          <div class="text-danger small">
            {{ form.customer_notes.errors }}
          </div>
        </div>

      </div>

      {# ================== Lines formset ================== #}
      <hr class="my-4">

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 fw-bold mb-0">
          {% trans "بنود المستند" %}
        </h2>
        <p class="text-muted small mb-0">
          {% trans "أضف المنتجات والكميات والأسعار لهذا المستند." %}
        </p>
      </div>

      {% if lines_formset %}
        {{ lines_formset.management_form }}
        {{ lines_formset.non_form_errors }}

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="small text-muted">{% trans "المنتج" %}</th>
                <th class="small text-muted">{% trans "الوصف" %}</th>
                <th class="small text-muted">{% trans "الوحدات" %}</th>
                <th class="small text-muted text-end">{% trans "الكمية" %}</th>
                <th class="small text-muted text-end">{% trans "سعر الوحدة" %}</th>
                <th class="small text-muted text-end">{% trans "الخصم %" %}</th>
                <th class="small text-muted text-end">{% trans "إجمالي السطر" %}</th>
                <th class="small text-muted text-center">{% trans "حذف" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for line_form in lines_formset %}
                <tr>
                  {# hidden fields (id, DELETE, etc.) #}
                  {% for hidden in line_form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}

                  <td class="small">
                    {{ line_form.product }}
                    <div class="text-danger small">
                      {{ line_form.product.errors }}
                    </div>
                  </td>

                  <td class="small">
                    {{ line_form.description }}
                    <div class="text-danger small">
                      {{ line_form.description.errors }}
                    </div>
                  </td>

                  {# الوحدة الأساسية / البديلة (UI فقط حالياً) #}
                  <td class="small">
                    <select class="form-select form-select-sm uom-select">
                      <option value="">{{ "—" }}</option>
                    </select>
                  </td>

                  <td class="small text-end">
                    {{ line_form.quantity }}
                    <div class="text-danger small">
                      {{ line_form.quantity.errors }}
                    </div>
                  </td>

                  <td class="small text-end">
                    {{ line_form.unit_price }}
                    <div class="text-danger small">
                      {{ line_form.unit_price.errors }}
                    </div>
                  </td>

                  <td class="small text-end">
                    {{ line_form.discount_percent }}
                    <div class="text-danger small">
                      {{ line_form.discount_percent.errors }}
                    </div>
                  </td>

                  <td class="small text-end">
                    {# line_total is read-only (computed on model) #}
                    {% if line_form.instance.pk %}
                      {{ line_form.instance.line_total }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td class="text-center">
                    {% if line_form.can_delete %}
                      <div class="form-check d-flex justify-content-center">
                        {{ line_form.DELETE }}
                      </div>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {# ================== Actions ================== #}
      <div class="d-flex justify-content-end gap-2 mt-4">
        <a href="{% url 'sales:sales_list' %}" class="btn btn-light">
          <i class="bi bi-arrow-right"></i>
          {% trans "رجوع" %}
        </a>

        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check2-circle"></i>
          {% trans "حفظ" %}
        </button>
      </div>

    </form>

  </div>
</div>

{% endblock %}

{# سكربت الوحدات – Vanilla JS #}
{% block extra_body %}
<script>
  (function () {
    // Django سيرندر هذا لشيء مثل: "/ar/sales/api/product-uom/0/"
    const productUomUrlTemplate = "{% url 'sales:product_uom_info' 0 %}";
    const productUomBaseUrl = productUomUrlTemplate.replace(/0\/?$/, "");

    function resetUomSelect(uomSelect) {
      if (!uomSelect) return;
      uomSelect.innerHTML = "";
      uomSelect.dataset.basePrice = "";
      uomSelect.dataset.altPrice = "";

      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "—";
      uomSelect.appendChild(opt);
    }

    function fillUomSelect(uomSelect, data) {
      if (!uomSelect) return;

      uomSelect.innerHTML = "";
      uomSelect.dataset.basePrice = data.base_price || "";
      uomSelect.dataset.altPrice = data.alt_price || "";

      const hasBase = !!data.base_uom;
      const hasAlt = !!data.alt_uom;

      // لا توجد وحدات معرّفة
      if (!hasBase && !hasAlt) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "—";
        uomSelect.appendChild(opt);
        return;
      }

      // نضيف الأساس أولاً
      if (hasBase) {
        const baseOpt = document.createElement("option");
        baseOpt.value = "base";
        baseOpt.textContent = data.base_uom + " – {% trans 'أساسية' %}";
        uomSelect.appendChild(baseOpt);
      }

      // ثم البديلة (إن وجدت)
      if (hasAlt) {
        const altOpt = document.createElement("option");
        altOpt.value = "alt";
        altOpt.textContent = data.alt_uom + " – {% trans 'بديلة' %}";
        uomSelect.appendChild(altOpt);
      }

      // اختيار افتراضي: الأساس إن وُجدت، وإلا البديلة
      if (hasBase) {
        uomSelect.value = "base";
      } else if (hasAlt) {
        uomSelect.value = "alt";
      }

      // بعد ما نضبط الوحدات، نحدّث السعر في السطر
      updateUnitPriceFromUom(uomSelect);
    }

    function updateUnitPriceFromUom(uomSelect) {
      if (!uomSelect) return;

      const row = uomSelect.closest("tr");
      if (!row) return;

      const unitPriceInput = row.querySelector("input[name$='-unit_price']");
      if (!unitPriceInput) return;

      const selected = uomSelect.value; // "base" | "alt" | ""
      const basePrice = uomSelect.dataset.basePrice || "";
      const altPrice = uomSelect.dataset.altPrice || "";

      let priceToUse = "";

      if (selected === "base") {
        priceToUse = basePrice;
      } else if (selected === "alt") {
        priceToUse = altPrice || basePrice; // لو ما فيه سعر بديل نرجع للأساس
      }

      if (priceToUse !== "") {
        unitPriceInput.value = priceToUse;
      }
    }

    function setupRow(row, index) {
      const productSelect = row.querySelector("select[name$='-product']");
      const uomSelect = row.querySelector(".uom-select");

      if (!productSelect || !uomSelect) {
        return;
      }

      function fetchAndUpdateUom(productId) {
        if (!productId) {
          resetUomSelect(uomSelect);
          return;
        }

        const url = productUomBaseUrl + productId + "/";

        fetch(url)
          .then((res) => {
            if (!res.ok) {
              throw new Error("HTTP " + res.status);
            }
            return res.json();
          })
          .then((data) => {
            fillUomSelect(uomSelect, data);
          })
          .catch((err) => {
            console.error("[UoM] Error fetching UoM for product", productId, err);
            resetUomSelect(uomSelect);
          });
      }

      // تحميل أولي (لو السطر محفوظ وعنده منتج)
      if (productSelect.value) {
        fetchAndUpdateUom(productSelect.value);
      } else {
        resetUomSelect(uomSelect);
      }

      // عند تغيير المنتج → نعيد جلب الوحدات والسعر
      productSelect.addEventListener("change", function (e) {
        fetchAndUpdateUom(e.target.value);
      });

      // عند تغيير الوحدة في نفس السطر → نغيّر السعر
      uomSelect.addEventListener("change", function () {
        updateUnitPriceFromUom(uomSelect);
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const rows = document.querySelectorAll("table tbody tr");
      rows.forEach((row, idx) => setupRow(row, idx));
    });
  })();
</script>
{% endblock %}

{% extends "sales/base_sales.html" %}
{% load i18n static %}

{% block title %}
  {% if form.instance.pk %}
    {{ form.instance.display_number }} | {% trans "تعديل" %}
  {% else %}
    {% trans "مستند جديد" %}
  {% endif %}
{% endblock %}

{% block sales_content %}

<div class="card shadow-sm border-0 mb-4">
  {# ================== HEADER ================== #}
  <div class="card-header bg-body py-3">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">

      <div class="d-flex flex-column gap-1">
        <div class="d-flex flex-wrap align-items-center gap-2">
          {% if form.instance.pk %}
            <h1 class="h5 fw-bold mb-0 text-body">
              <i class="bi bi-pencil-square me-1"></i>
              {% trans "تعديل مستند المبيعات" %}
            </h1>
            <span class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle">
              {{ form.instance.display_number }}
            </span>

            {# حالة المستند بادج حديثة #}
            {% if form.instance.status == 'draft' %}
              <span class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle">
                {% trans "مسودة" %}
              </span>
            {% elif form.instance.status == 'sent' %}
              <span class="badge rounded-pill bg-info-subtle text-info border border-info-subtle">
                {% trans "مرسل" %}
              </span>
            {% elif form.instance.status == 'confirmed' %}
              <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">
                {% trans "أمر بيع مؤكد" %}
              </span>
            {% elif form.instance.status == 'cancelled' %}
              <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle">
                {% trans "ملغي" %}
              </span>
            {% endif %}
          {% else %}
            <h1 class="h5 fw-bold mb-0 text-body">
              <i class="bi bi-plus-circle me-1"></i>
              {% trans "إنشاء مستند مبيعات جديد" %}
            </h1>
          {% endif %}
        </div>

        <p class="small text-muted mb-0">
          {% trans "قم بتعبئة بيانات العميل، ثم أضف المنتجات أو الخدمات مع الكميات والأسعار." %}
        </p>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <a href="{% url 'sales:document_list' %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-right-short"></i>
          {% trans "الرجوع للسجل" %}
        </a>
      </div>

    </div>
  </div>

  {# ================== BODY ================== #}
  <div class="card-body">

    <form method="post" id="sales-form">
      {% csrf_token %}

      {# --------- SECTION: رأس المستند --------- #}
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold small">{% trans "العميل" %}</label>
          {{ form.contact }}
          {% if form.contact.errors %}
            <div class="text-danger small mt-1">{{ form.contact.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold small">{% trans "التاريخ" %}</label>
          {{ form.date }}
          {% if form.date.errors %}
            <div class="text-danger small mt-1">{{ form.date.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold small">{% trans "تاريخ الانتهاء" %}</label>
          {{ form.due_date }}
          {% if form.due_date.errors %}
            <div class="text-danger small mt-1">{{ form.due_date.errors }}</div>
          {% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold small">{% trans "العملة" %}</label>
          {{ form.currency }}
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold small">{% trans "مرجع العميل (PO)" %}</label>
          {{ form.client_reference }}
          {% if form.client_reference.errors %}
            <div class="text-danger small mt-1">{{ form.client_reference.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label class="form-label small fw-semibold">{% trans "عنوان الفوترة" %}</label>
          {{ form.billing_address }}
        </div>
        <div class="col-md-6">
          <label class="form-label small fw-semibold">{% trans "عنوان الشحن" %}</label>
          {{ form.shipping_address }}
        </div>
      </div>

      <hr class="my-4">

      {# --------- SECTION: البنود --------- #}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h5 class="mb-0 text-body fw-semibold">
            {% trans "المنتجات / الخدمات" %}
          </h5>
          <p class="small text-muted mb-0">
            {% trans "اختر المنتج، ثم عدّل الكمية والوحدة والسعر والخصم لكل سطر." %}
          </p>
        </div>

        <button type="button"
                class="btn btn-sm btn-outline-primary"
                id="add-line-btn">
          <i class="bi bi-plus-lg me-1"></i>
          {% trans "إضافة سطر" %}
        </button>
      </div>

      {{ lines.management_form }}
      {{ lines.non_form_errors }}

      <div class="table-responsive mb-3">
        <table class="table table-sm table-hover align-middle" id="lines-table">
          <thead class="table-light small text-muted">
            <tr>
              <th style="width: 30%;">{% trans "المنتج / الوصف" %}</th>
              <th style="width: 10%;" class="text-center">{% trans "الكمية" %}</th>
              <th style="width: 12%;" class="text-center">{% trans "الوحدة" %}</th>
              <th style="width: 12%;" class="text-end">{% trans "السعر" %}</th>
              <th style="width: 10%;" class="text-end">{% trans "خصم %" %}</th>
              <th style="width: 13%;" class="text-end">{% trans "الإجمالي" %}</th>
              <th style="width: 5%;" class="text-center">❌</th>
            </tr>
          </thead>
          <tbody>
            {% for line_form in lines %}
              <tr class="line-form-row">
                {# hidden fields (id, etc.) #}
                {% for hidden in line_form.hidden_fields %}
                  {{ hidden }}
                {% endfor %}

                {# المنتج + الوصف في نفس الخانة (مودرن) #}
                <td>
                  <div class="mb-1">
                    {{ line_form.product }}
                  </div>
                  <div class="small text-muted">
                    {{ line_form.description }}
                  </div>
                  {% if line_form.product.errors %}
                    <div class="text-danger small mt-1">{{ line_form.product.errors }}</div>
                  {% endif %}
                </td>

                <td class="text-center">
                  {{ line_form.quantity }}
                </td>

                <td class="text-center">
                  {{ line_form.uom }}
                </td>

                <td class="text-end">
                  {{ line_form.unit_price }}
                </td>

                <td class="text-end">
                  {{ line_form.discount_percent }}
                </td>

                <td class="text-end">
                  {{ line_form.total_display }}
                </td>

                <td class="text-center align-middle">
                  {% if lines.can_delete %}
                    <div class="form-check d-flex justify-content-center">
                      {{ line_form.DELETE }}
                    </div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# --------- SECTION: الملاحظات + الإجماليات --------- #}
      <div class="row g-3 mt-2">
        <div class="col-md-8">
          <div class="mb-3">
            <label class="form-label small fw-semibold">
              {% trans "ملاحظات للعميل" %}
            </label>
            {{ form.customer_notes }}
          </div>
          <div>
            <label class="form-label small fw-semibold text-muted">
              {% trans "ملاحظات داخلية (لا تظهر للعميل)" %}
            </label>
            {{ form.notes }}
          </div>
        </div>

        <div class="col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
              <table class="table table-sm mb-0">
                <tr>
                  <th class="small text-muted">
                    {% trans "الإجمالي قبل الضريبة" %}
                  </th>
                  <td class="text-end fw-semibold font-monospace" id="grand-total-display">
                    0.000
                  </td>
                </tr>
                <tr class="table-primary">
                  <th class="small fw-bold">
                    {% trans "الصافي النهائي" %}
                  </th>
                  <td class="text-end fw-bold h5 mb-0 text-body" id="final-total-display">
                    0.000
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      {# --------- أزرار الحفظ --------- #}
      <div class="d-flex justify-content-center gap-2 mt-4">
        <button type="submit" class="btn btn-primary px-5">
          <i class="bi bi-save me-1"></i>
          {% trans "حفظ" %}
        </button>
        <a href="{% url 'sales:document_list' %}" class="btn btn-outline-secondary px-4">
          {% trans "إلغاء" %}
        </a>
      </div>

    </form>
  </div>
</div>

{# قالب السطر الفارغ لإضافته ديناميكياً #}
<table style="display:none;">
  <tr id="empty-form-row" class="line-form-row">
    <td>
      <div class="mb-1">
        {{ lines.empty_form.product }}
      </div>
      <div class="small text-muted">
        {{ lines.empty_form.description }}
      </div>
    </td>
    <td class="text-center">
      {{ lines.empty_form.quantity }}
    </td>
    <td class="text-center">
      {{ lines.empty_form.uom }}
    </td>
    <td class="text-end">
      {{ lines.empty_form.unit_price }}
    </td>
    <td class="text-end">
      {{ lines.empty_form.discount_percent }}
    </td>
    <td class="text-end">
      <input type="text"
             class="form-control form-control-sm line-total"
             readonly>
    </td>
    <td class="text-center align-middle">
      <button type="button" class="btn btn-outline-danger btn-sm remove-row-btn">
        <i class="bi bi-x-lg"></i>
      </button>
    </td>
  </tr>
</table>

{% endblock %}

{% block extra_body %}
{{ products_dict|json_script:"products-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {

  // --- 1. تهيئة المتغيرات ---
  const productsDataElement = document.getElementById('products-data');
  if (!productsDataElement) return;

  const productsData = JSON.parse(productsDataElement.textContent);
  const tableBody = document.querySelector('#lines-table tbody');
  const totalFormsInput = document.getElementById('id_lines-TOTAL_FORMS');
  const emptyRowTemplate = document.getElementById('empty-form-row');

  // --- 2. عند تغيير المنتج ---
  function handleProductChange(row) {
    const productSelect = row.querySelector('.product-select');
    const productId = productSelect ? productSelect.value : null;
    const uomSelect = row.querySelector('.uom-select');
    const priceInput = row.querySelector('.price-input');

    if (productId && productsData[productId]) {
      const data = productsData[productId];

      // السعر الأساسي
      if (priceInput) {
        priceInput.value = data.price;
      }

      // خيارات الوحدات
      if (uomSelect) {
        uomSelect.innerHTML = '';

        if (data.base_uom_id) {
          const optBase = new Option(data.base_uom_name, data.base_uom_id);
          uomSelect.add(optBase);
        }

        if (data.alt_uom_id) {
          const optAlt = new Option(data.alt_uom_name, data.alt_uom_id);
          uomSelect.add(optAlt);
        }
      }
    }

    calculateRowTotal(row);
  }

  // --- 3. عند تغيير الوحدة (تحديث السعر حسب الـ alt_factor) ---
  function handleUomChange(row) {
    const productSelect = row.querySelector('.product-select');
    const uomSelect = row.querySelector('.uom-select');
    const priceInput = row.querySelector('.price-input');

    const productId = productSelect ? productSelect.value : null;
    const selectedUomId = uomSelect ? parseInt(uomSelect.value) : null;

    if (productId && productsData[productId] && priceInput && uomSelect) {
      const data = productsData[productId];
      let newPrice = data.price;

      if (data.alt_uom_id && selectedUomId === data.alt_uom_id) {
        newPrice = data.price * data.alt_factor;
      }

      priceInput.value = Number(newPrice).toFixed(3);

      priceInput.style.backgroundColor = "#e8f0fe";
      setTimeout(() => priceInput.style.backgroundColor = "", 300);
    }

    calculateRowTotal(row);
  }

  // --- 4. حساب إجمالي السطر ---
  function calculateRowTotal(row) {
    const qtyInput = row.querySelector('.qty-input');
    const priceInput = row.querySelector('.price-input');
    const discountInput = row.querySelector('.discount-input');
    const totalDisplay = row.querySelector('.line-total');

    const qty = qtyInput ? parseFloat(qtyInput.value) || 0 : 0;
    const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
    const discount = discountInput ? parseFloat(discountInput.value) || 0 : 0;

    let total = qty * price;

    if (discount > 0) {
      total = total * (100 - discount) / 100;
    }

    if (totalDisplay) {
      totalDisplay.value = total.toFixed(3);
    }

    calculateGrandTotal();
  }

  // --- 5. حساب الإجمالي الكلي ---
  function calculateGrandTotal() {
    let grandTotal = 0;
    const rows = tableBody.querySelectorAll('.line-form-row');

    rows.forEach(row => {
      const deleteInput = row.querySelector('input[name$="-DELETE"]');
      if (deleteInput && deleteInput.checked) return;
      if (row.style.display === 'none') return;

      const totalField = row.querySelector('.line-total');
      if (totalField) {
        grandTotal += parseFloat(totalField.value) || 0;
      }
    });

    const grandEl = document.getElementById('grand-total-display');
    const finalEl = document.getElementById('final-total-display');

    if (grandEl) grandEl.textContent = grandTotal.toFixed(3);
    if (finalEl) finalEl.textContent = grandTotal.toFixed(3);
  }

  // --- 6. الاستماع للأحداث على جسم الجدول (Event Delegation) ---
  tableBody.addEventListener('change', function(e) {
    const target = e.target;
    const row = target.closest('tr');

    if (!row) return;

    if (target.classList.contains('product-select')) {
      handleProductChange(row);
    } else if (target.classList.contains('uom-select')) {
      handleUomChange(row);
    } else if (
      target.classList.contains('qty-input') ||
      target.classList.contains('price-input') ||
      target.classList.contains('discount-input')
    ) {
      calculateRowTotal(row);
    }
  });

  tableBody.addEventListener('input', function(e) {
    const target = e.target;
    if (
      target.classList.contains('qty-input') ||
      target.classList.contains('discount-input') ||
      target.classList.contains('price-input')
    ) {
      const row = target.closest('tr');
      if (row) calculateRowTotal(row);
    }
  });

  // --- 7. إضافة سطر جديد ---
  const addLineBtn = document.getElementById('add-line-btn');
  if (addLineBtn) {
    addLineBtn.addEventListener('click', function() {
      const formIdx = totalFormsInput.value;
      const newRow = emptyRowTemplate.cloneNode(true);

      newRow.removeAttribute('id');
      newRow.style.display = 'table-row';
      newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formIdx);

      const removeBtn = newRow.querySelector('.remove-row-btn');
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          newRow.remove();
          calculateGrandTotal();
        });
      }

      tableBody.appendChild(newRow);
      totalFormsInput.value = parseInt(formIdx) + 1;
    });
  }

  // --- 8. الحساب الأولي عند تحميل الصفحة (لأسطر موجودة) ---
  const existingRows = tableBody.querySelectorAll('.line-form-row');
  existingRows.forEach(row => calculateRowTotal(row));

});
</script>
{% endblock %}

{% extends "sales/base_sales.html" %}
{% load i18n %}

{% block title %}
    {% trans "Ù…Ø³ØªÙ†Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª" %}
{% endblock %}

{% block sales_content %}

    {# ================== Header ================== #}
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
            <div class="d-flex align-items-center gap-2 mb-1">
                <h1 class="h5 fw-bold mb-0 text-body">
                    {% if document %}
                        {% trans "ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ†Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª" %}
                    {% else %}
                        {% trans "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª" %}
                    {% endif %}
                </h1>
                {% if document %}
                    <span class="badge bg-secondary-subtle text-secondary-emphasis small">
          {% trans "Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯" %}: {{ document.display_number|default:"â€”" }}
        </span>
                {% endif %}
            </div>
            <p class="text-muted small mb-0">
                {% trans "Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª." %}
            </p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'sales:sales_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-right ms-1"></i>
                {% trans "Ø±Ø¬ÙˆØ¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª" %}
            </a>
        </div>
    </div>

    {# ================== Card: Form ================== #}
    <div class="card shadow-sm border-0">
        <div class="card-body">

            <form method="post" novalidate>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger small mb-3">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                {# ================== Section: Basic info ================== #}
                <div class="border rounded-3 p-3 mb-3 bg-body-tertiary">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <div>
                            <h2 class="h6 fw-bold mb-1 text-body">
                                {% trans "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©" %}
                            </h2>
                            <p class="text-muted small mb-0">
                                {% trans "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ­Ø¯Ø¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†ÙˆØ¯." %}
                            </p>
                        </div>
                    </div>

                    <div class="row g-3">

                        {# Ø§Ù„Ø¹Ù…ÙŠÙ„ #}
                        <div class="col-lg-6">
                            <label for="{{ form.contact.id_for_label }}" class="form-label small fw-semibold mb-1">
                                {{ form.contact.label|default:_("Ø§Ù„Ø¹Ù…ÙŠÙ„") }}
                            </label>
                            {{ form.contact }}
                            {% if form.contact.help_text %}
                                <div class="form-text small text-muted mt-1">
                                    {{ form.contact.help_text }}
                                </div>
                            {% endif %}
                            {% if form.contact.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.contact.errors }}
                                </div>
                            {% endif %}
                        </div>

                        {# Ø§Ù„ØªØ§Ø±ÙŠØ® #}
                        <div class="col-sm-6 col-lg-3">
                            <label for="{{ form.date.id_for_label }}" class="form-label small fw-semibold mb-1">
                                {{ form.date.label|default:_("Ø§Ù„ØªØ§Ø±ÙŠØ®") }}
                            </label>
                            {{ form.date }}
                            {% if form.date.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.date.errors }}
                                </div>
                            {% endif %}
                        </div>

                        {# ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ #}
                        <div class="col-sm-6 col-lg-3">
                            <label for="{{ form.due_date.id_for_label }}" class="form-label small fw-semibold mb-1">
                                {{ form.due_date.label|default:_("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡") }}
                            </label>
                            {{ form.due_date }}
                            {% if form.due_date.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.due_date.errors }}
                                </div>
                            {% endif %}
                        </div>

                    </div>
                </div>

                {# ================== Section: Notes ================== #}
                <div class="border rounded-3 p-3 mb-4 bg-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <div>
                            <h2 class="h6 fw-bold mb-1 text-body">
                                {% trans "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" %}
                            </h2>
                            <p class="text-muted small mb-0">
                                {% trans "ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ØŒ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„." %}
                            </p>
                        </div>
                    </div>

                    <div class="row g-3">
                        {# Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© #}
                        <div class="col-md-6">
                            <label for="{{ form.notes.id_for_label }}" class="form-label small fw-semibold mb-1">
                                {{ form.notes.label|default:_("Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©") }}
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.notes.errors }}
                                </div>
                            {% endif %}
                        </div>

                        {# Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„ #}
                        <div class="col-md-6">
                            <label for="{{ form.customer_notes.id_for_label }}"
                                   class="form-label small fw-semibold mb-1">
                                {{ form.customer_notes.label|default:_("Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„") }}
                            </label>
                            {{ form.customer_notes }}
                            {% if form.customer_notes.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.customer_notes.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# ================== Lines formset ================== #}
                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-1">
                    <div class="d-flex align-items-center gap-2">
                        <h2 class="h6 fw-bold mb-0">
                            {% trans "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯" %}
                        </h2>
                        {% if lines_formset %}
                            <span class="badge bg-secondary-subtle text-secondary-emphasis small">
              {{ lines_formset.total_form_count }} {% trans "Ø¨Ù†Ø¯" %}
            </span>
                        {% endif %}
                    </div>
                    <p class="text-muted small mb-0">
                        {% trans "Ø£Ø¶Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±ØŒ ÙˆØ³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø³Ø·Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§." %}
                    </p>
                </div>

                {% if lines_formset %}
                    {{ lines_formset.management_form }}

                    {% if lines_formset.non_form_errors %}
                        <div class="alert alert-danger small mb-3">
                            {{ lines_formset.non_form_errors }}
                        </div>
                    {% endif %}

                    <div class="table-responsive-md border rounded-3 overflow-hidden">
                        <table class="table table-sm align-middle mb-0 table-hover">
                            <thead class="table-light position-sticky top-0" style="z-index: 5;">
                            <tr>
                                <th class="small text-muted" style="min-width: 320px;">
                                    {% trans "Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„ÙƒÙˆØ¯ / Ø§Ù„ÙˆØµÙ" %}
                                </th>
                                <th class="small text-muted" style="width: 140px;">
                                    {% trans "Ø§Ù„ÙˆØ­Ø¯Ø©" %}
                                </th>
                                <th class="small text-muted text-end" style="width: 110px;">
                                    {% trans "Ø§Ù„ÙƒÙ…ÙŠØ©" %}
                                </th>
                                <th class="small text-muted text-end" style="width: 130px;">
                                    {% trans "Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©" %}
                                </th>
                                <th class="small text-muted text-end" style="width: 110px;">
                                    {% trans "Ø§Ù„Ø®ØµÙ… %" %}
                                </th>
                                <th class="small text-muted text-end" style="width: 140px;">
                                    {% trans "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø±" %}
                                </th>
                                <th class="small text-muted text-center" style="width: 70px;">
                                    {% trans "Ø­Ø°Ù" %}
                                </th>
                            </tr>
                            </thead>

                            <tbody>
                            {% for line_form in lines_formset %}
                                <tr>
                                    {# hidden fields (id, Ø¥Ù„Ø®) #}
                                    {% for hidden in line_form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}

                                    {# ================== Ø§Ù„ÙƒÙˆØ¯ + Ø§Ù„Ø§Ø³Ù… + Ø§Ù„ÙˆØµÙ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙˆØ¯ ================== #}
                                    <td class="small" style="min-width: 320px;">

                                        <div class="row g-1 mb-1">

                                            {# -------- Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ (Ø³ÙŠØ±Ø´Ø§Ø¨Ù„ Ø¨Ø§Ù„ÙƒÙˆØ¯) -------- #}
                                            <div class="col-4 position-relative">
                                                <div class="input-group input-group-sm">
                          <span class="input-group-text">
                            <i class="bi bi-upc"></i>
                          </span>
                                                    {{ line_form.product_code }}
                                                </div>

                                                {% if line_form.product_code.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {{ line_form.product_code.errors }}
                                                    </div>
                                                {% endif %}

                                                {# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„ÙƒÙˆØ¯ #}
                                                <div class="list-group position-absolute w-100 shadow-sm small d-none product-code-suggestions"
                                                     style="z-index: 1050; max-height: 220px; overflow-y: auto;">
                                                </div>
                                            </div>

                                            {# -------- Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… (input Ø£ÙˆØªÙˆ) + Ctrl+Click Ù„Ù„ÙˆØµÙ -------- #}
                                            <div class="col-8">
                                                <div class="input-group input-group-sm">
                          <span class="input-group-text">
                            <i class="bi bi-box-seam"></i>
                          </span>
                                                    <input type="text"
                                                           class="form-control form-control-sm product-name-input"
                                                           placeholder="{% trans 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬' %}"
                                                           autocomplete="off"
                                                           readonly>
                                                </div>
                                                <div class="form-text small text-muted">
                                                    {% trans "Ctrl + Ù†Ù‚Ø±Ø© Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙ Ø£Ø³ÙÙ„Ù‡." %}
                                                </div>
                                            </div>
                                        </div>

                                        {# Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (select) Ù…Ø®ÙÙŠ Ù„Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ #}
                                        <div class="d-none">
                                            {{ line_form.product }}
                                        </div>

                                        {# -------- Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙ (ÙŠØ¸Ù‡Ø±/ÙŠØ®ØªÙÙŠ Ø¨Ù€ Ctrl+Click) -------- #}
                                        <div class="mt-1 line-description-container
                                {% if not line_form.description.value and not line_form.description.errors %}d-none{% endif %}">
                                            {{ line_form.description }}
                                            {% if line_form.description.errors %}
                                                <div class="text-danger small mt-1">
                                                    {{ line_form.description.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                    </td>

                                    {# ================== Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© / Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© ================== #}
                                    <td class="small">
                                        <div class="form-floating form-floating-sm">
                                            <select class="form-select form-select-sm uom-select"
                                                    aria-label="{% trans 'Ø§Ù„ÙˆØ­Ø¯Ø©' %}">
                                                <option value="">{% trans "â€”" %}</option>
                                            </select>
                                            <label class="small">{% trans "Ø§Ù„ÙˆØ­Ø¯Ø©" %}</label>
                                        </div>

                                        {# ğŸ”¹ Ø§Ù„Ù…Ù‡Ù… Ù‡Ù†Ø§: Ù†Ø®Ø²Ù† Ù‚ÙŠÙ…Ø© uom_kind Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù€ instance #}
                                        <input type="hidden"
                                               name="{{ line_form.prefix }}-uom_kind"
                                               value="{{ line_form.instance.uom_kind|default_if_none:'' }}"
                                               class="uom-kind-input">
                                    </td>

                                    {# ================== Ø§Ù„ÙƒÙ…ÙŠØ© ================== #}
                                    <td class="small text-end">
                                        <div class="input-group input-group-sm">
                                            {{ line_form.quantity }}
                                        </div>
                                        {% if line_form.quantity.errors %}
                                            <div class="text-danger small mt-1 text-start">
                                                {{ line_form.quantity.errors }}
                                            </div>
                                        {% endif %}
                                    </td>

                                    {# ================== Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ================== #}
                                    <td class="small text-end">
                                        <div class="input-group input-group-sm">
                                            {{ line_form.unit_price }}
                                        </div>
                                        {% if line_form.unit_price.errors %}
                                            <div class="text-danger small mt-1 text-start">
                                                {{ line_form.unit_price.errors }}
                                            </div>
                                        {% endif %}
                                    </td>

                                    {# ================== Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… ================== #}
                                    <td class="small text-end">
                                        <div class="input-group input-group-sm">
                                            {{ line_form.discount_percent }}
                                        </div>
                                        {% if line_form.discount_percent.errors %}
                                            <div class="text-danger small mt-1 text-start">
                                                {{ line_form.discount_percent.errors }}
                                            </div>
                                        {% endif %}
                                    </td>

                                    {# ================== Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø± ================== #}
                                    <td class="small text-end">
                                        {% if line_form.instance.pk %}
                                            <span class="fw-semibold">{{ line_form.instance.line_total }}</span>
                                        {% else %}
                                            <span class="text-muted">â€”</span>
                                        {% endif %}
                                    </td>

                                    {# ================== Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± ================== #}
                                    <td class="text-center">
                                        {% if line_form.can_delete %}
                                            <div class="form-check d-flex justify-content-center">
                                                {{ line_form.DELETE }}
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>

                        </table>
                    </div>
                {% endif %}

                {# ================== Actions ================== #}
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{% url 'sales:sales_list' %}" class="btn btn-light">
                        <i class="bi bi-arrow-right"></i>
                        {% trans "Ø±Ø¬ÙˆØ¹" %}
                    </a>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check2-circle"></i>
                        {% trans "Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯" %}
                    </button>
                </div>

            </form>

        </div>
    </div>

{% endblock %}

{# ================== Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª + Ø¨Ø­Ø« ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ================== #}
{% block extra_body %}
<script>
  (function () {
    // ======== Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù€ API Ø§Ù„Ù…ÙˆØ­Ø¯ ========
    const productApiSearchUrl = "{% url 'sales:product_api_search' %}";
    const productApiUomTemplate = "{% url 'sales:product_api_uom' 0 %}";
    const productApiUomBaseUrl = productApiUomTemplate.replace(/0\/?$/, "");

    document.addEventListener("DOMContentLoaded", function () {
      document
        .querySelectorAll("table tbody tr")
        .forEach(initRow);
    });

    // ================== Helpers Ø¹Ø§Ù…Ø© ==================
    function getEls(row) {
      return {
        row: row,
        productSelect:     row.querySelector("select[name$='-product']"),
        productCodeInput:  row.querySelector("input[name$='-product_code']"),
        codeSuggestionsEl: row.querySelector(".product-code-suggestions"),
        nameInput:         row.querySelector(".product-name-input"),
        descField:         row.querySelector("textarea[name$='-description'], input[name$='-description']"),
        descContainer:     row.querySelector(".line-description-container"),
        uomSelect:         row.querySelector(".uom-select"),
        uomKindInput:      row.querySelector("input[name$='-uom_kind']"),
        unitPriceInput:    row.querySelector("input[name$='-unit_price']")
      };
    }

    function parseLabel(label) {
      if (!label) return { code: "", name: "" };

      const dashIdx = label.indexOf("â€“"); // en dash
      if (dashIdx !== -1) {
        return {
          code: label.slice(0, dashIdx).trim(),
          name: label.slice(dashIdx + 1).trim()
        };
      }

      const spaceIdx = label.indexOf(" ");
      if (spaceIdx !== -1) {
        return {
          code: label.slice(0, spaceIdx).trim(),
          name: label.slice(spaceIdx + 1).trim()
        };
      }

      return { code: label.trim(), name: "" };
    }

    // ================== ØªÙ‡ÙŠØ¦Ø© ØµÙ ÙˆØ§Ø­Ø¯ ==================
    function initRow(row) {
      const els = getEls(row);
      if (!els.productSelect || !els.productCodeInput) return;

      const initialProductId = els.productSelect.value || "";

      // Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…:
      const initialKindFromHidden = (els.uomKindInput && els.uomKindInput.value.trim()) || "";
      const initialKindFromSelect = (els.uomSelect && els.uomSelect.value) || "";
      const initialUomKind = initialKindFromHidden || initialKindFromSelect;

      // ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© (edit / Ø¨Ø¹Ø¯ Ø§Ù„ÙØ§Ù„ÙŠØ¯ÙŠØ´Ù†)
      if (initialProductId) {
        fillFromSelectedOption(els);

        if (els.descField && els.descField.value && els.descContainer) {
          els.descContainer.classList.remove("d-none");
        }

        loadUom(initialProductId, els, {
          uomKind: initialUomKind,
          keepExisting: true
        });
      }

      // --- Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù€ API ---
      els.productCodeInput.addEventListener("input", function () {
        handleCodeSearch(els);
      });

      // ESC / blur Ù„Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
      els.productCodeInput.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && els.codeSuggestionsEl) {
          els.codeSuggestionsEl.classList.add("d-none");
        }
      });

      els.productCodeInput.addEventListener("blur", function () {
        if (!els.codeSuggestionsEl) return;
        setTimeout(function () {
          els.codeSuggestionsEl.classList.add("d-none");
        }, 200);
      });

      // --- Ctrl + Click Ù„ÙØªØ­/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØµÙ ---
      if (els.nameInput) {
        els.nameInput.addEventListener("click", function (e) {
          if (e.ctrlKey) {
            e.preventDefault();
            toggleDescription(els);
          }
        });
      }

      // --- ØªØºÙŠÙŠØ± UoM ---
      if (els.uomSelect) {
        els.uomSelect.addEventListener("change", function () {
          updateUnitPrice(els);
        });
      }
    }

    // ================== ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒÙˆØ¯/Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù€ option ==================
    function fillFromSelectedOption(els) {
      const select = els.productSelect;
      if (!select || !select.value) return;

      const opt    = select.options[select.selectedIndex];
      const parsed = parseLabel(opt ? opt.textContent : "");

      if (parsed.code && !els.productCodeInput.value.trim()) {
        els.productCodeInput.value = parsed.code;
      }
      if (els.nameInput && parsed.name && !els.nameInput.value.trim()) {
        els.nameInput.value = parsed.name;
      }
    }

    // ================== Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ + Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ API) ==================
    function handleCodeSearch(els) {
      const listEl = els.codeSuggestionsEl;
      if (!listEl) return;

      const query = els.productCodeInput.value.trim();
      listEl.innerHTML = "";

      if (!query) {
        listEl.classList.add("d-none");
        return;
      }

      const url = productApiSearchUrl + "?q=" + encodeURIComponent(query);

      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(payload => {
          const results = payload.results || [];
          if (!results.length) {
            listEl.classList.add("d-none");
            return;
          }

          results.slice(0, 15).forEach(item => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "list-group-item list-group-item-action";

            const label = item.name
              ? (item.code + " â€“ " + item.name)
              : (item.code || "");

            btn.textContent = label;

            btn.addEventListener("click", function () {
              applyProductSelection(els, item.id, {
                code: item.code,
                name: item.name || ""
              });
              listEl.classList.add("d-none");
              listEl.innerHTML = "";
            });

            listEl.appendChild(btn);
          });

          listEl.classList.remove("d-none");
        })
        .catch(err => {
          console.error("[Product search] error:", err);
          listEl.classList.add("d-none");
        });
    }

    function applyProductSelection(els, productId, parsed) {
      if (els.productSelect) {
        els.productSelect.value = String(productId);
      }
      if (els.productCodeInput && parsed.code) {
        els.productCodeInput.value = parsed.code;
      }
      if (els.nameInput && parsed.name) {
        els.nameInput.value = parsed.name;
      }

      // Ù„Ø§ Ù†Ù„Ù…Ø³ Ø§Ù„ÙˆØµÙ Ø£Ø¨Ø¯Ø§Ù‹ Ù‡Ù†Ø§

      // reset uom kind + Ø§Ù„Ø³Ø¹Ø±
      if (els.uomKindInput) els.uomKindInput.value = "";
      if (els.unitPriceInput) els.unitPriceInput.value = "";

      loadUom(productId, els, {
        uomKind: "",
        keepExisting: false
      });
    }

    // ================== Ø§Ù„ÙˆØµÙ ==================
    function toggleDescription(els) {
      if (!els.descContainer) return;
      els.descContainer.classList.toggle("d-none");
      if (!els.descContainer.classList.contains("d-none") && els.descField) {
        els.descField.focus();
      }
    }

    // ================== UOM / Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ==================
    function loadUom(productId, els, opts) {
      opts = opts || {};
      if (!els.uomSelect) return;

      if (!productId) {
        resetUom(els);
        return;
      }

      const url = productApiUomBaseUrl + productId + "/";

      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(data => {
          fillUomFromData(els, data, opts);
        })
        .catch(err => {
          console.error("[UoM] Error fetching UoM for product", productId, err);
          resetUom(els);
        });
    }

    function resetUom(els) {
      const select = els.uomSelect;
      if (!select) return;

      select.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "â€”";
      select.appendChild(opt);

      select.dataset.basePrice = "";
      select.dataset.altPrice  = "";

      if (els.uomKindInput)   els.uomKindInput.value   = "";
      if (els.unitPriceInput) els.unitPriceInput.value = "";
    }

    // ======== UoM + Ø§Ù„Ø³Ø¹Ø± (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø³ÙŠØ±ÙØ³) ========
    function fillUomFromData(els, data, opts) {
      const select = els.uomSelect;
      if (!select) return;

      opts = opts || {};
      const keepExisting = !!opts.keepExisting;

      let existingKind = (opts.uomKind || "").trim(); // "base" | "alt" | ""

      // Ù†Ù‚Ø±Ø£ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… (Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
      const currentPriceStr = (els.unitPriceInput && els.unitPriceInput.value.trim()) || "";

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù€ <select> + ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
      select.innerHTML = "";
      select.dataset.basePrice = data.base_price || "";
      select.dataset.altPrice  = data.alt_price  || "";

      const hasBase = !!data.base_uom;
      const hasAlt  = !!data.alt_uom;

      if (!hasBase && !hasAlt) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "â€”";
        select.appendChild(opt);

        if (els.uomKindInput)   els.uomKindInput.value   = "";
        if (els.unitPriceInput) els.unitPriceInput.value = "";
        return;
      }

      if (hasBase) {
        const baseOpt = document.createElement("option");
        baseOpt.value = "base";
        baseOpt.textContent = data.base_uom + " â€“ {% trans 'Ø£Ø³Ø§Ø³ÙŠØ©' %}";
        select.appendChild(baseOpt);
      }

      if (hasAlt) {
        const altOpt = document.createElement("option");
        altOpt.value = "alt";
        altOpt.textContent = data.alt_uom + " â€“ {% trans 'Ø¨Ø¯ÙŠÙ„Ø©' %}";
        select.appendChild(altOpt);
      }

      // ===== Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ / Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© =====
      let shouldUpdatePrice = true;  // Ù‡Ù„ Ù†Ø³Ù…Ø­ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±ØŸ
      const baseStr = select.dataset.basePrice || "";
      const altStr  = select.dataset.altPrice  || "";

      const current = parseFloat(currentPriceStr);
      const baseNum = parseFloat(baseStr);
      const altNum  = parseFloat(altStr);

      let matchesBase = false;
      let matchesAlt  = false;

      if (!isNaN(current)) {
        const eps = 0.0005;
        if (!isNaN(baseNum) && Math.abs(current - baseNum) < eps) {
          matchesBase = true;
        }
        if (!isNaN(altNum) && Math.abs(current - altNum) < eps) {
          matchesAlt = true;
        }
      }

      if (keepExisting && currentPriceStr) {
        // Ù„Ùˆ Ø§Ù„Ø³Ø¹Ø± Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ù„Ø§ base ÙˆÙ„Ø§ alt â†’ Ø³Ø¹Ø± ÙŠØ¯ÙˆÙŠ (Ù…Ø«Ø§Ù„: Ø³ÙŠØ±ÙØ³ 2500 Ùˆ base_price=0)
        if (!matchesBase && !matchesAlt) {
          shouldUpdatePrice = false;  // Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ø§Ù„Ø³Ø¹Ø± Ø£Ø¨Ø¯Ø§Ù‹
        }

        // Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ù†Ø§ Ù†ÙˆØ¹ Ø³Ø§Ø¨Ù‚ Ù„ÙƒÙ† Ø§Ù„Ø³Ø¹Ø± ÙŠØ·Ø§Ø¨Ù‚ base Ø£Ùˆ alt â†’ Ù†Ø³ØªÙ†ØªØ¬ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù†Ù‡
        if (!existingKind) {
          if (matchesAlt) {
            existingKind = "alt";
          } else if (matchesBase) {
            existingKind = "base";
          }
        }
      }

      // Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      let kindToSelect = existingKind;

      // Ù„Ùˆ Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§ Ù†Ø­Ø¯Ù‘Ø¯ØŒ Ù†Ø±Ø¬Ù‘Ø¹ Ù„Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø«Ù… Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
      if (!kindToSelect) {
        if (hasBase)      kindToSelect = "base";
        else if (hasAlt)  kindToSelect = "alt";
      }

      if (kindToSelect) {
        select.value = kindToSelect;
      }

      // Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      if (els.uomKindInput) {
        els.uomKindInput.value = select.value || "";
      }

      // Ø§Ù„Ø³Ø¹Ø±:
      // - Ù„Ùˆ Ø³Ø¹Ø± ÙŠØ¯ÙˆÙŠ (Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ base/alt) â†’ Ù„Ø§ Ù†Ù„Ù…Ø³Ù‡
      // - ØºÙŠØ± Ø°Ù„Ùƒ â†’ Ù†Ø­Ø¯Ù‘Ø«Ù‡ Ø¨Ø­ÙŠØ« ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ÙˆØ­Ø¯Ø©
      if (shouldUpdatePrice) {
        updateUnitPrice(els);
      }
    }

    function updateUnitPrice(els) {
      const select = els.uomSelect;
      const priceInput = els.unitPriceInput;
      if (!select || !priceInput) return;

      const selected  = select.value; // base | alt | ""
      const basePrice = select.dataset.basePrice || "";
      const altPrice  = select.dataset.altPrice  || "";

      let priceToUse = "";
      if (selected === "base") {
        priceToUse = basePrice;
      } else if (selected === "alt") {
        priceToUse = altPrice || basePrice;
      }

      if (priceToUse !== "") {
        const num = parseFloat(priceToUse);
        if (!isNaN(num)) {
          priceInput.value = num.toFixed(3);
        } else {
          priceInput.value = priceToUse;
        }
      } else {
        priceInput.value = "";
      }
    }

  })();
</script>
{% endblock %}

{% extends "sales/base_sales.html" %}
{% load i18n static %}

{% block title %}
  {% if form.instance.pk %}
    {{ form.instance.display_number }} | {% trans "تعديل" %}
  {% else %}
    {% trans "مستند جديد" %}
  {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .description-input {
        background-color: transparent !important;
        border: none !important;
        box-shadow: none !important;
        font-size: 0.9em;
        color: #6c757d;
        padding-inline-start: 0;
        padding-inline-end: 0;
    }
    .description-input:focus {
        border-bottom: 1px dashed #ced4da !important;
    }
    .line-total {
        background-color: #f8f9fa !important;
        border: none;
        font-weight: bold;
        color: #198754;
    }
    .lite-row {
        background-color: rgba(248, 249, 250, 0.5);
    }
</style>
{% endblock %}

{% block sales_content %}

<div class="card shadow-sm border-0 mb-5">
  {# ================== HEADER ================== #}
  <div class="card-header bg-white py-3 border-bottom">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

      <div class="d-flex flex-column">
        <div class="d-flex align-items-center gap-2">
          <h5 class="mb-0 fw-bold text-primary">
            {% if form.instance.pk %}
              <i class="bi bi-pencil-square"></i> {% trans "تعديل مستند" %}
              <span class="text-dark font-monospace mx-1">{{ form.instance.display_number }}</span>
            {% else %}
              <i class="bi bi-plus-circle"></i> {% trans "إنشاء مستند جديد" %}
            {% endif %}
          </h5>

          {% if form.instance.pk %}
            {% if form.instance.status == 'draft' %}
                <span class="badge bg-secondary-subtle text-secondary border">{% trans "مسودة" %}</span>
            {% elif form.instance.status == 'confirmed' %}
                <span class="badge bg-success-subtle text-success border">{% trans "أمر بيع" %}</span>
            {% elif form.instance.status == 'cancelled' %}
                <span class="badge bg-danger-subtle text-danger border">{% trans "ملغي" %}</span>
            {% endif %}
          {% endif %}
        </div>
      </div>

      <a href="{% url 'sales:document_list' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-return-right"></i> {% trans "عودة" %}
      </a>
    </div>
  </div>

  {# ================== BODY ================== #}
  <div class="card-body p-4">
    <form method="post" id="sales-form">
      {% csrf_token %}

      {# --------- SECTION 1: بيانات المستند --------- #}
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label fw-bold small text-muted">{% trans "العميل" %}</label>
          {{ form.contact }}
          {{ form.contact.errors }}
        </div>
        <div class="col-md-2">
          <label class="form-label fw-bold small text-muted">{% trans "التاريخ" %}</label>
          {{ form.date }}
          {{ form.date.errors }}
        </div>
        <div class="col-md-2">
          <label class="form-label fw-bold small text-muted">{% trans "العملة" %}</label>
          {{ form.currency }}
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold small text-muted">{% trans "مرجع العميل (PO)" %}</label>
          {{ form.client_reference }}
        </div>
      </div>

      <div class="row g-3 mb-4 bg-light p-3 rounded-3 border-0">
        <div class="col-md-6">
          <label class="form-label small fw-bold">{% trans "عنوان الفوترة" %}</label>
          {{ form.billing_address }}
        </div>
        <div class="col-md-6">
          <label class="form-label small fw-bold">{% trans "عنوان الشحن" %}</label>
          {{ form.shipping_address }}
        </div>
      </div>

      <hr class="my-4 text-muted opacity-25">

      {# --------- SECTION 3: جدول المنتجات (Lines) --------- #}
      <div class="d-flex justify-content-between align-items-end mb-2">
        <h5 class="fw-bold text-dark mb-0">{% trans "المنتجات والخدمات" %}</h5>
        <button type="button" class="btn btn-sm btn-primary shadow-sm" id="add-line-btn">
          <i class="bi bi-plus-lg"></i> {% trans "إضافة سطر" %}
        </button>
      </div>

      {{ lines.management_form }}
      {{ lines.non_form_errors }}

      <div class="table-responsive border rounded-3 mb-4">
        <table class="table table-sm table-hover align-middle mb-0" id="lines-table">
          <thead class="table-light text-muted small">
            <tr>
              <th style="width: 35%;" class="ps-3">{% trans "المنتج" %}</th>
              <th style="width: 10%;" class="text-center">{% trans "الكمية" %}</th>
              <th style="width: 12%;" class="text-center">{% trans "الوحدة" %}</th>
              <th style="width: 12%;" class="text-end">{% trans "السعر" %}</th>
              <th style="width: 10%;" class="text-end">{% trans "خصم %" %}</th>
              <th style="width: 15%;" class="text-end pe-3">{% trans "الإجمالي" %}</th>
              <th style="width: 6%;" class="text-center"></th>
            </tr>
          </thead>
          <tbody>
            {% for line_form in lines %}
              {# === الصف الرئيسي === #}
              <tr class="line-form-row main-line-row">
                {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}

                <td class="ps-3 position-relative">
                  <div class="d-flex gap-2">
                    <div class="flex-grow-1">
                      {{ line_form.product }}
                    </div>
                    <button type="button"
                            class="btn btn-sm btn-link text-decoration-none text-muted toggle-desc-btn p-0"
                            title="{% trans 'إضافة وصف' %}">
                      <i class="bi bi-card-text"></i>
                    </button>
                  </div>
                  {% if line_form.product.errors %}
                    <div class="text-danger small mt-1">{{ line_form.product.errors }}</div>
                  {% endif %}
                </td>

                <td class="text-center">{{ line_form.quantity }}</td>
                <td class="text-center">{{ line_form.uom }}</td>
                <td class="text-end">{{ line_form.unit_price }}</td>
                <td class="text-end">{{ line_form.discount_percent }}</td>

                <td class="text-end pe-3">
                  {% with widget=line_form.total_display %}
                    <input type="text"
                           name="{{ widget.html_name }}"
                           value="{{ widget.value|default:'0.000' }}"
                           class="form-control form-control-sm text-end line-total"
                           readonly
                           id="{{ widget.id_for_label }}">
                  {% endwith %}
                </td>

                <td class="text-center">
                  {% if lines.can_delete %}
                    <div class="d-none">{{ line_form.DELETE }}</div>
                    <button type="button" class="btn btn-sm text-danger remove-row-btn" title="{% trans 'حذف' %}">
                      <i class="bi bi-trash"></i>
                    </button>
                  {% endif %}
                </td>
              </tr>

              {# === صف الوصف تحت السطر === #}
              <tr class="description-row {% if not line_form.description.value %}d-none{% endif %} lite-row">
                <td colspan="7" class="border-0 p-0">
                  <div class="d-flex align-items-center px-4 py-1">
                    <i class="bi bi-arrow-return-right text-muted small me-2 opacity-50"></i>
                    <div class="flex-grow-1">
                      {% with widget=line_form.description %}
                        <input type="text"
                               name="{{ widget.html_name }}"
                               value="{{ widget.value|default:'' }}"
                               class="form-control description-input"
                               id="{{ widget.id_for_label }}">
                      {% endwith %}
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# --------- SECTION 4: الملاحظات والإجماليات --------- #}
      <div class="row">
        <div class="col-lg-7">
          <div class="mb-3">
            <label class="form-label fw-bold small text-muted">{% trans "ملاحظات للعميل" %}</label>
            {{ form.customer_notes }}
          </div>
          <div>
            <label class="form-label fw-bold small text-muted">{% trans "ملاحظات داخلية" %}</label>
            {{ form.notes }}
          </div>
        </div>
        <div class="col-lg-1"></div>
        <div class="col-lg-4">
          <div class="card bg-light border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">{% trans "الإجمالي قبل الضريبة" %}</span>
                <span class="fw-bold font-monospace" id="grand-total-display">0.000</span>
              </div>
              <hr class="my-2">
              <div class="d-flex justify-content-between align-items-center">
                <span class="h6 mb-0 fw-bold text-dark">{% trans "الصافي النهائي" %}</span>
                <span class="h4 mb-0 fw-bold text-primary font-monospace" id="final-total-display">0.000</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-center gap-3 mt-5">
        <button type="submit" class="btn btn-primary px-5 py-2 fw-bold shadow-sm">
          <i class="bi bi-check-lg"></i> {% trans "حفظ المستند" %}
        </button>
        <a href="{% url 'sales:document_list' %}" class="btn btn-outline-secondary px-4 py-2">
          {% trans "إلغاء" %}
        </a>
      </div>

    </form>
  </div>
</div>

{# ====== قوالب النسخ (Hidden Templates) ====== #}
<table style="display:none;">
  <tbody id="empty-rows-container">

    <tr id="empty-main-row" class="line-form-row main-line-row">
      <td class="ps-3">
        <div class="d-flex gap-2">
          <div class="flex-grow-1">{{ lines.empty_form.product }}</div>
          <button type="button" class="btn btn-sm btn-link text-decoration-none text-muted toggle-desc-btn p-0">
            <i class="bi bi-card-text"></i>
          </button>
        </div>
      </td>
      <td class="text-center">{{ lines.empty_form.quantity }}</td>
      <td class="text-center">{{ lines.empty_form.uom }}</td>
      <td class="text-end">{{ lines.empty_form.unit_price }}</td>
      <td class="text-end">{{ lines.empty_form.discount_percent }}</td>

      <td class="text-end pe-3">
        {% with widget=lines.empty_form.total_display %}
          <input type="text"
                 name="{{ widget.html_name }}"
                 value="{{ widget.value|default:'0.000' }}"
                 class="form-control form-control-sm text-end line-total"
                 readonly
                 id="{{ widget.id_for_label }}">
        {% endwith %}
      </td>

      <td class="text-center">
        <button type="button" class="btn btn-sm text-danger remove-row-btn">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </tr>

    <tr id="empty-desc-row" class="description-row d-none lite-row">
      <td colspan="7" class="border-0 p-0">
        <div class="d-flex align-items-center px-4 py-1">
          <i class="bi bi-arrow-return-right text-muted small me-2 opacity-50"></i>
          <div class="flex-grow-1">
            {% with widget=lines.empty_form.description %}
              <input type="text"
                     name="{{ widget.html_name }}"
                     value="{{ widget.value|default:'' }}"
                     class="form-control description-input"
                     id="{{ widget.id_for_label }}">
            {% endwith %}
          </div>
        </div>
      </td>
    </tr>

  </tbody>
</table>

{% endblock %}

{% block extra_body %}
{{ products_dict|json_script:"products-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {

  const productsDataElement = document.getElementById('products-data');
  if (!productsDataElement) return;

  const productsData = JSON.parse(productsDataElement.textContent);
  const tableBody = document.querySelector('#lines-table tbody');
  const totalFormsInput = document.getElementById('id_lines-TOTAL_FORMS');
  const emptyMainTemplate = document.getElementById('empty-main-row');
  const emptyDescTemplate = document.getElementById('empty-desc-row');

  // --- 1. إظهار/إخفاء الوصف + الحذف ---
  tableBody.addEventListener('click', function(e) {
    const toggleBtn = e.target.closest('.toggle-desc-btn');
    if (toggleBtn) {
      const mainRow = toggleBtn.closest('.main-line-row');
      const descRow = mainRow.nextElementSibling;
      if (descRow && descRow.classList.contains('description-row')) {
        descRow.classList.toggle('d-none');
        if (!descRow.classList.contains('d-none')) {
          const input = descRow.querySelector('input');
          if (input) input.focus();
        }
      }
      return;
    }

    const removeBtn = e.target.closest('.remove-row-btn');
    if (removeBtn) {
      const mainRow = removeBtn.closest('.main-line-row');
      const descRow = mainRow.nextElementSibling;

      const deleteCheckbox = mainRow.querySelector('input[name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        mainRow.style.display = 'none';
        if (descRow) descRow.style.display = 'none';
      } else {
        mainRow.remove();
        if (descRow) descRow.remove();
      }
      calculateGrandTotal();
    }
  });

  // --- 2. تغيير المنتج ---
  function handleProductChange(row) {
    const productSelect = row.querySelector('.product-select');
    const productId = productSelect ? productSelect.value : null;
    const uomSelect = row.querySelector('.uom-select');
    const priceInput = row.querySelector('.price-input');

    if (productId && productsData[productId]) {
      const data = productsData[productId];
      if (priceInput) priceInput.value = data.price;
      if (uomSelect) {
        uomSelect.innerHTML = '';
        if (data.base_uom_id) uomSelect.add(new Option(data.base_uom_name, data.base_uom_id));
        if (data.alt_uom_id) uomSelect.add(new Option(data.alt_uom_name, data.alt_uom_id));
      }
    }
    calculateRowTotal(row);
  }

  // --- 3. تغيير الوحدة ---
  function handleUomChange(row) {
    const productSelect = row.querySelector('.product-select');
    const uomSelect = row.querySelector('.uom-select');
    const priceInput = row.querySelector('.price-input');

    const productId = productSelect ? productSelect.value : null;
    const selectedUomId = uomSelect ? parseInt(uomSelect.value) : null;

    if (productId && productsData[productId] && priceInput && uomSelect) {
      const data = productsData[productId];
      let newPrice = data.price;

      if (data.alt_uom_id && selectedUomId === data.alt_uom_id) {
        newPrice = data.price * data.alt_factor;
      }

      priceInput.value = Number(newPrice).toFixed(3);
      priceInput.style.backgroundColor = "#e8f0fe";
      setTimeout(() => priceInput.style.backgroundColor = "", 300);
    }
    calculateRowTotal(row);
  }

  // --- 4. حساب إجمالي السطر ---
  function calculateRowTotal(row) {
    const qty = parseFloat(row.querySelector('.qty-input')?.value || 0);
    const price = parseFloat(row.querySelector('.price-input')?.value || 0);
    const discount = parseFloat(row.querySelector('.discount-input')?.value || 0);
    const totalDisplay = row.querySelector('.line-total');

    let total = qty * price;
    if (discount > 0) {
      total = total * (100 - discount) / 100;
    }

    if (totalDisplay) totalDisplay.value = total.toFixed(3);
    calculateGrandTotal();
  }

  // --- 5. الإجمالي الكلي ---
  function calculateGrandTotal() {
    let grandTotal = 0;
    const mainRows = tableBody.querySelectorAll('.main-line-row');

    mainRows.forEach(row => {
      const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
      if (deleteCheckbox && deleteCheckbox.checked) return;
      if (row.style.display === 'none') return;

      const totalField = row.querySelector('.line-total');
      if (totalField) {
        grandTotal += parseFloat(totalField.value) || 0;
      }
    });

    const grandEl = document.getElementById('grand-total-display');
    const finalEl = document.getElementById('final-total-display');

    if (grandEl) grandEl.textContent = grandTotal.toFixed(3);
    if (finalEl) finalEl.textContent = grandTotal.toFixed(3);
  }

  // --- 6. مراقبة الأحداث على الحقول الرقمية ---
  tableBody.addEventListener('change', function(e) {
    const target = e.target;
    const row = target.closest('.main-line-row');
    if (!row) return;

    if (target.classList.contains('product-select')) {
      handleProductChange(row);
    } else if (target.classList.contains('uom-select')) {
      handleUomChange(row);
    } else if (target.matches('.qty-input, .price-input, .discount-input')) {
      calculateRowTotal(row);
    }
  });

  tableBody.addEventListener('input', function(e) {
    const target = e.target;
    const row = target.closest('.main-line-row');
    if (row && target.matches('.qty-input, .price-input, .discount-input')) {
      calculateRowTotal(row);
    }
  });

  // --- 7. إضافة سطر جديد ---
  const addLineBtn = document.getElementById('add-line-btn');
  if (addLineBtn) {
    addLineBtn.addEventListener('click', function() {
      const formIdx = totalFormsInput.value;

      const newMain = emptyMainTemplate.cloneNode(true);
      const newDesc = emptyDescTemplate.cloneNode(true);

      newMain.removeAttribute('id');
      newDesc.removeAttribute('id');

      newMain.style.display = '';
      // نخلي الوصف مخفي افتراضياً:
      newDesc.classList.add('d-none');

      newMain.innerHTML = newMain.innerHTML.replace(/__prefix__/g, formIdx);
      newDesc.innerHTML = newDesc.innerHTML.replace(/__prefix__/g, formIdx);

      tableBody.appendChild(newMain);
      tableBody.appendChild(newDesc);

      totalFormsInput.value = parseInt(formIdx) + 1;
    });
  }

  // --- 8. تشغيل أولي لحساب الإجماليات للأسطر الموجودة ---
  const existingRows = tableBody.querySelectorAll('.main-line-row');
  existingRows.forEach(row => calculateRowTotal(row));

});
</script>
{% endblock %}

{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "عرض سعر" %} {{ document.number|default:document.pk }}{% endblock %}

{% block content %}

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <div class="d-flex align-items-center gap-2 mb-2">
      <span class="badge bg-dark-subtle text-dark-emphasis small">
        {% trans "المبيعات" %}
      </span>
      <span class="badge bg-warning-subtle text-warning-emphasis small">
        {% trans "عرض سعر" %}
      </span>
      <span class="badge bg-light border small">
        {{ document.status_label|default:_("غير محدد") }}
      </span>
    </div>

    <h1 class="h4 fw-bold mb-1">
      {% trans "عرض سعر" %} {{ document.number|default:document.pk }}
    </h1>

    <p class="text-muted small mb-0">
      {% if document.contact %}
        {{ document.contact.name }}
      {% else %}
        {% trans "مستند مبيعات في نظام Mazoon ERP" %}
      {% endif %}
    </p>
  </div>

  <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
    <a href="{% url 'sales:quotation_list' %}"
       class="btn btn-outline-secondary.btn-sm">
      <i class="bi bi-arrow-right"></i>
      {% trans "رجوع للقائمة" %}
    </a>

    {# زر تعديل عرض السعر #}
    <a href="{% url 'sales:quotation_edit' document.pk %}"
       class="btn btn-primary btn-sm">
      <i class="bi bi-pencil"></i>
      {% trans "تعديل" %}
    </a>

    {# تحويل إلى طلب بيع (فقط لو ممكن التحويل) #}
    {% if document.can_be_converted_to_order %}
      <form method="post"
            action="{% url 'sales:quotation_convert_to_order' document.pk %}"
            class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-success btn-sm">
          <i class="bi bi-arrow-left-right"></i>
          {% trans "تحويل إلى طلب بيع" %}
        </button>
      </form>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">

    <!-- ========== معلومات المستند + ملاحظات العميل ========== -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-3">{% trans "معلومات عرض السعر" %}</h2>

        <div class="row g-3 small">
          <div class="col-md-6">
            <div class="text-muted mb-1">{% trans "رقم المستند" %}</div>
            <div class="fw-semibold">
              {{ document.number|default:document.pk }}
            </div>
          </div>

          <div class="col-md-6">
            <div class="text-muted mb-1">{% trans "التاريخ" %}</div>
            <div class="fw-semibold">
              {{ document.date|date:"Y-m-d" }}
            </div>
          </div>

          <div class="col-md-6">
            <div class="text-muted mb-1">{% trans "تاريخ الاستحقاق" %}</div>
            <div class="fw-semibold">
              {% if document.due_date %}
                {{ document.due_date|date:"Y-m-d" }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="text-muted mb-1">{% trans "العملة" %}</div>
            <div class="fw-semibold">
              {{ document.currency|default:"OMR" }}
            </div>
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-3 small">
          <div class="col-12">
            <div class="text-muted mb-1">{% trans "ملاحظات للعميل" %}</div>
            {% if document.customer_notes %}
              <div class="small">
                {{ document.customer_notes|linebreaksbr }}
              </div>
            {% else %}
              <div class="text-muted small">—</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- ========== بنود عرض السعر ========== -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-3">{% trans "بنود عرض السعر" %}</h2>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="small text-muted">{% trans "الوصف" %}</th>
                <th class="small text-muted text-center">{% trans "الكمية" %}</th>
                <th class="small text-muted text-center">{% trans "سعر الوحدة" %}</th>
                <th class="small text-muted text-center">{% trans "الخصم ٪" %}</th>
                <th class="small text-muted text-end">{% trans "الإجمالي" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for line in document.lines.all %}
                <tr>
                  <td class="small">
                    {% if line.product %}
                      <div class="fw-semibold">{{ line.product.name }}</div>
                    {% endif %}
                    {% if line.description %}
                      <div class="text-muted">{{ line.description }}</div>
                    {% endif %}
                  </td>
                  <td class="small text-center text-nowrap">
                    {{ line.quantity }}
                  </td>
                  <td class="small text-center text-nowrap">
                    {{ line.unit_price }}
                  </td>
                  <td class="small text-center text-nowrap">
                    {{ line.discount_percent|default:"0" }}
                  </td>
                  <td class="small text-end text-nowrap">
                    {{ line.line_total }}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted small py-3">
                    {% trans "لا توجد بنود في هذا العرض." %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- ========== ملاحظات داخلية ========== -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-3">{% trans "ملاحظات داخلية" %}</h2>
        {% if document.notes %}
          <div class="small">
            {{ document.notes|linebreaksbr }}
          </div>
        {% else %}
          <p class="text-muted small mb-0">
            {% trans "لا توجد ملاحظات داخلية مسجلة لهذا العرض." %}
          </p>
        {% endif %}
        <p class="text-muted small mt-2 mb-0">
          {% trans "هذه الملاحظات للاستخدام الداخلي فقط ولا تظهر للعميل." %}
        </p>
      </div>
    </div>

  </div>

  <div class="col-lg-4">

    <!-- ========== تفاصيل العميل ========== -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 fw-semibold.mb-3">{% trans "تفاصيل العميل" %}</h2>
        {% if document.contact %}
          <div class="small mb-2">
            <span class="text-muted d-block mb-1">{% trans "الاسم" %}</span>
            <span class="fw-semibold">
              <a href="{% url 'contacts:contact_detail' document.contact.pk %}"
                 class="text-mazoon text-decoration-none">
                {{ document.contact.name }}
              </a>
            </span>
          </div>

          <div class="small mb-2">
            <span class="text-muted d-block mb-1">{% trans "الهاتف" %}</span>
            <span class="fw-semibold">
              {{ document.contact.phone|default:"—" }}
            </span>
          </div>

          <div class="small mb-2">
            <span class="text-muted d-block mb-1">{% trans "البريد الإلكتروني" %}</span>
            <span class="fw-semibold">
              {{ document.contact.email|default:"—" }}
            </span>
          </div>

          <div class="small">
            <span class="text-muted d-block mb-1">{% trans "الرقم الضريبي" %}</span>
            <span class="fw-semibold">
              {{ document.contact.tax_number|default:"—" }}
            </span>
          </div>
        {% else %}
          <p class="text-muted small mb-0">
            {% trans "لا توجد جهة اتصال مرتبطة بهذا العرض." %}
          </p>
        {% endif %}
      </div>
    </div>

    <!-- ========== ملخص مالي ========== -->
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-3">{% trans "ملخص مالي" %}</h2>

        <div class="d-flex flex-column gap-2 small">
          <div class="d-flex justify-content-between">
            <span class="text-muted">{% trans "الإجمالي قبل الضريبة" %}</span>
            <span class="fw-semibold">
              {{ document.total_before_tax|default:document.total_amount }} {{ document.currency|default:"OMR" }}
            </span>
          </div>

          <div class="d-flex justify-content-between">
            <span class="text-muted">{% trans "الضريبة" %}</span>
            <span class="fw-semibold">
              {{ document.total_tax|default:"0.000" }} {{ document.currency|default:"OMR" }}
            </span>
          </div>

          <div class="d-flex justify-content-between border-top pt-2">
            <span class="text-muted">{% trans "الإجمالي النهائي" %}</span>
            <span class="fw-bold">
              {{ document.total_amount }} {{ document.currency|default:"OMR" }}
            </span>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}

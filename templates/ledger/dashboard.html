{% extends "ledger/base_ledger.html" %}
{% load i18n %}

{% block ledger_content %}
<div class="mb-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
  <div>
    <h2 class="h5 mb-1">{% trans "الملخص العام" %}</h2>
    <p class="text-muted small mb-0 alert alert-primary">
      {% blocktrans with start=month_start end=today %}
        نظرة سريعة على الحسابات والقيود من {{ start }} إلى {{ end }}.
      {% endblocktrans %}

    </p>
  </div>
</div>

{# ===== كروت الإحصائيات الأساسية ===== #}
<div class="row g-3 mb-4">

  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body py-3">
        <p class="text-muted small mb-1">{% trans "عدد الحسابات" %}</p>
        <h2 class="h4 mb-0">{{ accounts_count }}</h2>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body py-3">
        <p class="text-muted small mb-1">{% trans "إجمالي القيود المُرحّلة" %}</p>
        <h2 class="h4 mb-0">{{ entries_count }}</h2>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body py-3">
        <p class="text-muted small mb-1">{% trans "قيود هذا الشهر" %}</p>
        <p class="text-muted small mb-2">
          <span class="badge bg-light text-muted border">
            {{ month_start }} → {{ today }}
          </span>
        </p>
        <h2 class="h4 mb-0">{{ month_entries_count }}</h2>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body py-3">
        <p class="text-muted small mb-2">{% trans "إجمالي حركة الشهر" %}</p>

        <div class="d-flex justify-content-between small mb-1">
          <span class="text-muted">{% trans "مدين" %}</span>
          <strong>{{ month_debit }}</strong>
        </div>
        <div class="d-flex justify-content-between small mb-2">
          <span class="text-muted">{% trans "دائن" %}</span>
          <strong>{{ month_credit }}</strong>
        </div>

        {% if month_debit != month_credit %}
          <div class="alert alert-warning py-1 px-2 mb-0 small">
            {% trans "تنبيه: إجمالي المدين لا يساوي إجمالي الدائن خلال الفترة المحددة." %}
          </div>
        {% else %}
          <div class="alert alert-success py-1 px-2 mb-0 small">
            {% trans "الحركة الشهرية متوازنة (مدين = دائن)." %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

{# ===== صف ثنائي: إجراءات سريعة + أحدث القيود ===== #}
<div class="row g-3 mb-4">
{% comment %}{% if effective_fiscal_year %}
<div class="alert alert-info d-flex justify-content-between align-items-center py-2 px-3 mb-3">
  <div>
    <strong>{% trans "السنة الافتراضية للتقارير:" %}</strong>
    {{ effective_fiscal_year.year }}
    <span class="text-muted small">
      ({{ effective_fiscal_year.start_date }} — {{ effective_fiscal_year.end_date }})
    </span>
  </div>
  <a href="{% url 'ledger:fiscal_year_list' %}" class="btn btn-sm btn-outline-primary">
    {% trans "تغيير السنة" %}
  </a>
</div>
{% endif %}{% endcomment %}

  {# إجراءات سريعة #}
  <div class="col-md-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h2 class="h6 mb-3">{% trans "إجراءات سريعة" %}</h2>
        <ul class="list-unstyled mb-0 small">
            <li class="mb-2">
              <a href="{% url 'ledger:fiscal_year_list' %}" class="link-dark text-decoration-none">
                   ▸ {% trans "إدارة السنوات المالية" %}
              </a>
          </li>
          <li class="mb-2">
            <a href="{% url 'ledger:account_create' %}"
               class="link-dark text-decoration-none">
              ▸ {% trans "إنشاء حساب جديد" %}
            </a>
          </li>
          <li class="mb-2">
            <a href="{% url 'ledger:journalentry_create' %}"
               class="link-dark text-decoration-none">
              ▸ {% trans "إنشاء قيد جديد" %}
            </a>
          </li>
          <li class="mb-2">
            <a href="{% url 'ledger:trial_balance' %}"
               class="link-dark text-decoration-none">
              ▸ {% trans "عرض ميزان المراجعة" %}
            </a>
          </li>
          <li class="mb-2">
            <a href="{% url 'ledger:account_ledger' %}"
               class="link-dark text-decoration-none">
              ▸ {% trans "عرض دفتر حساب" %}
            </a>
          </li>
          <li class="mb-2">
            <a href="{% url 'ledger:account_list' %}"
               class="link-dark text-decoration-none">
              ▸ {% trans "عرض دليل الحسابات" %}
            </a>
          </li>
          <li class="mb-2">
            <a href="{% url 'ledger:journalentry_list' %}"
               class="link-dark text-decoration-none">
              ▸ {% trans "عرض جميع القيود" %}
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  {# أحدث القيود #}
  <div class="col-md-8">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">{% trans "أحدث القيود المُرحّلة" %}</h2>
          <a href="{% url 'ledger:journalentry_list' %}"
             class="btn btn-sm btn-outline-secondary">
            {% trans "عرض كل القيود" %}
          </a>
        </div>

        {% if recent_entries %}
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0">
              <thead class="table-light">
              <tr>
                <th class="text-nowrap">{% trans "رقم القيد" %}</th>
                <th class="text-nowrap">{% trans "التاريخ" %}</th>
                <th class="text-nowrap">{% trans "الدفتر" %}</th>
                <th class="text-nowrap">{% trans "المرجع" %}</th>
                <th class="text-nowrap">{% trans "الوصف" %}</th>
                <th class="text-nowrap">{% trans "الإجمالي" %}</th>
                <th class="text-end text-nowrap">{% trans "إجراءات" %}</th>
              </tr>
              </thead>
              <tbody>
              {% for e in recent_entries %}
                <tr>
                  <td class="text-nowrap">
                    {% if e.number %}
                      {{ e.number }}
                    {% else %}
                      JE-{{ e.id }}
                    {% endif %}
                  </td>
                  <td class="text-nowrap">{{ e.date|date:"SHORT_DATE_FORMAT" }}</td>
                  <td class="text-nowrap">
                    {% if e.journal %}
                      <span class="badge bg-light text-muted border small">
                        {{ e.journal.code }}
                      </span>
                    {% else %}
                      <span class="text-muted small">-</span>
                    {% endif %}
                  </td>
                  <td class="text-nowrap">{{ e.reference|default:"-" }}</td>
                  <td class="small">
                    {{ e.description|default:"-"|truncatechars:60 }}
                  </td>
                  <td class="text-nowrap">
                    {{ e.total_debit }}
                  </td>
                  <td class="text-end text-nowrap">
                    <a href="{% url 'ledger:journalentry_detail' e.pk %}"
                       class="btn btn-outline-secondary btn-sm">
                      {% trans "عرض" %}
                    </a>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted small mb-0">
            {% trans "لا توجد قيود حتى الآن." %}
          </p>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}

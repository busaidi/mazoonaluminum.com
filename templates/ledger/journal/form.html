{% extends "ledger/base_ledger.html" %}
{% load i18n %}

{% block ledger_content %}
<div class="mb-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
  <div>
    {% if is_update %}
      <h2 class="h5 mb-1">
        {% blocktrans with entry_id=entry.id %}تعديل قيد يومية JE-{{ entry_id }}{% endblocktrans %}
      </h2>
      <p class="text-muted small mb-0">
        {% trans "يمكنك تعديل بيانات القيد غير المُرحّل وتصحيح الأسطر ثم إعادة ترحيله." %}
      </p>
    {% else %}
      <h2 class="h5 mb-1">{% trans "إنشاء قيد يومية" %}</h2>
      <p class="text-muted small mb-0">
        {% trans "أدخل بيانات القيد ورتّب الأسطر بحيث يتساوى مجموع المدين مع مجموع الدائن." %}
      </p>
    {% endif %}
  </div>

  <div>
    <a href="{% url 'ledger:journalentry_list' %}" class="btn btn-light btn-sm">
      {% trans "رجوع إلى القيود" %}
    </a>
  </div>
</div>

<form method="post" class="card shadow-sm border-0">
  <div class="card-body">
    {% csrf_token %}

    {# أخطاء عامة لرأس القيد #}
    {% if entry_form.non_field_errors %}
      <div class="alert alert-danger small">
        {{ entry_form.non_field_errors }}
      </div>
    {% endif %}

    {# ===== رأس القيد ===== #}
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label class="form-label form-label-sm" for="{{ entry_form.date.id_for_label }}">
          {% trans "التاريخ" %}
        </label>
        {{ entry_form.date }}
        {% for error in entry_form.date.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-md-3">
        <label class="form-label form-label-sm" for="{{ entry_form.reference.id_for_label }}">
          {% trans "المرجع" %}
        </label>
        {{ entry_form.reference }}
        {% for error in entry_form.reference.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-md-3">
        <label class="form-label form-label-sm" for="{{ entry_form.journal.id_for_label }}">
          {% trans "دفتر اليومية" %}
        </label>
        {{ entry_form.journal }}
        {% for error in entry_form.journal.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-md-3">
        <label class="form-label form-label-sm" for="{{ entry_form.description.id_for_label }}">
          {% trans "الوصف" %}
        </label>
        {{ entry_form.description }}
        {% for error in entry_form.description.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

    <hr class="my-3">

    {# ===== أسطر القيد ===== #}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">{% trans "أسطر القيد" %}</h6>
      <small class="text-muted">
        {% trans "يجب أن يكون مجموع المدين مساويًا لمجموع الدائن قبل الحفظ." %}
      </small>
    </div>

    {% if line_formset.non_form_errors %}
      <div class="alert alert-danger small mb-2">
        {{ line_formset.non_form_errors }}
      </div>
    {% endif %}

    {{ line_formset.management_form }}

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-2" id="lines-table">
        <thead class="table-light">
          <tr>
            <th style="width: 35%">{% trans "الحساب" %}</th>
            <th style="width: 25%">{% trans "الوصف" %}</th>
            <th style="width: 15%" class="text-end">{% trans "مدين" %}</th>
            <th style="width: 15%" class="text-end">{% trans "دائن" %}</th>
            <th style="width: 10%"></th>
          </tr>
        </thead>
        <tbody id="lines-body">
          {% for form in line_formset %}
            <tr class="line-row">
              {# حقول مخفية (مثل id / DELETE) #}
              {% for hidden in form.hidden_fields %}
                {{ hidden }}
              {% endfor %}

              <td>
                {{ form.account }}
                {% for error in form.account.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.description }}
                {% for error in form.description.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.debit }}
                {% for error in form.debit.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.credit }}
                {% for error in form.credit.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td class="text-end">
                {% if forloop.first %}
                  {# لا نحذف أول صف افتراضي #}
                {% else %}
                  <button type="button" class="btn btn-outline-danger btn-sm remove-row">
                    &times;
                  </button>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-2 mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
      <button type="button" id="add-row" class="btn btn-outline-primary btn-sm">
        + {% trans "إضافة سطر" %}
      </button>
      <small class="text-muted">
        {% trans "يمكنك إضافة أكثر من سطر، وترك الأسطر الفارغة بدون حساب أو مبالغ." %}
      </small>
    </div>

    <hr class="my-3">

    <div class="d-flex justify-content-between">
      <a href="{% url 'ledger:journalentry_list' %}" class="btn btn-light btn-sm">
        {% trans "رجوع" %}
      </a>

      <button type="submit" class="btn btn-primary btn-sm">
        {% if is_update %}
          {% trans "تحديث القيد" %}
        {% else %}
          {% trans "حفظ القيد" %}
        {% endif %}
      </button>
    </div>
  </div>
</form>

{# ===== JavaScript لإضافة/حذف الصفوف ===== #}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const addBtn = document.getElementById("add-row");
  const linesBody = document.getElementById("lines-body");

  // نلقط حقل TOTAL_FORMS للفورمست
  const totalFormsInput = document.querySelector("input[name$='-TOTAL_FORMS']");

  if (!addBtn || !linesBody || !totalFormsInput) {
    return;
  }

  // prefix حق الفورمست (مثلاً: "form")
  const prefix = totalFormsInput.name.replace("-TOTAL_FORMS", "");

  addBtn.addEventListener("click", function () {
    const currentCount = parseInt(totalFormsInput.value, 10);

    const firstRow = linesBody.querySelector(".line-row");
    if (!firstRow) return;

    const newRow = firstRow.cloneNode(true);

    // نفرغ القيم + نحدّث name/id بالتسلسل الجديد
    newRow.querySelectorAll("input, select, textarea").forEach((el) => {
      // تفريغ القيمة
      if (el.type === "checkbox" || el.type === "radio") {
        el.checked = false;
      } else {
        el.value = "";
      }

      // تحديث name
      if (el.name) {
        el.name = el.name.replace(
          new RegExp(prefix + "-\\d+"),
          prefix + "-" + currentCount
        );
      }

      // تحديث id
      if (el.id) {
        el.id = el.id.replace(
          new RegExp(prefix + "-\\d+"),
          prefix + "-" + currentCount
        );
      }
    });

    // آخر عمود: زر إزالة
    const lastTd = newRow.querySelector("td:last-child");
    if (lastTd) {
      lastTd.innerHTML = `
        <button type="button" class="btn btn-outline-danger btn-sm remove-row">
          &times;
        </button>
      `;
    }

    linesBody.appendChild(newRow);

    // زيادة عدد الفورمات
    totalFormsInput.value = currentCount + 1;
  });

  // حذف صف (فقط في الواجهة، نمنع حذف آخر صف)
  linesBody.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-row")) {
      const row = e.target.closest("tr");
      if (!row) return;

      const rows = linesBody.querySelectorAll(".line-row");
      if (rows.length <= 1) {
        return;
      }

      row.remove();
    }
  });
});
</script>

{% endblock %}

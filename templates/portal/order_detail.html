{% extends "base.html" %}
{% load i18n %}

{% block title %}طلب #{{ order.id }}{% endblock %}

{% block content %}
<div class="py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">تفاصيل الطلب #{{ order.id }}</h1>
    <a href="{% url 'portal:order_list' %}" class="btn btn-secondary btn-sm">
      رجوع لطلباتي
    </a>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">معلومات الطلب</h5>
          <p class="mb-1"><strong>رقم الطلب:</strong> {{ order.id }}</p>
          <p class="mb-1"><strong>التاريخ:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>
          <p class="mb-1"><strong>الحالة:</strong> {{ order.get_status_display }}</p>
          <p class="mb-0">
            <strong>إجمالي الطلب:</strong>
            {{ order.total_amount|floatformat:3 }}
          </p>
        </div>
      </div>
    </div>

    {% if order.invoice %}
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">الفاتورة المرتبطة</h5>
          <p class="mb-1"><strong>رقم الفاتورة:</strong> {{ order.invoice.number }}</p>
          <p class="mb-1"><strong>تاريخ الإصدار:</strong> {{ order.invoice.issued_at|date:"Y-m-d" }}</p>
          <p class="mb-0">
            <strong>المبلغ:</strong>
            {{ order.invoice.total_amount|floatformat:3 }}
          </p>
          <div class="mt-2">
            <a href="{% url 'portal:invoice_detail' number=order.invoice.number %}"
               class="btn btn-outline-primary btn-sm">
              عرض الفاتورة
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  {% if order.notes %}
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">ملاحظات</h5>
      <p class="mb-0">{{ order.notes|linebreaksbr }}</p>
    </div>
  </div>
  {% endif %}

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">بنود الطلب</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>المنتج</th>
              <th class="text-center">الكمية</th>
              <th class="text-end">سعر الوحدة</th>
              <th class="text-end">الإجمالي</th>
            </tr>
          </thead>
          <tbody>
            {% get_current_language as LANGUAGE_CODE %}
            {% for item in order.items.all %}
            <tr>
              <td>
                {# عرض اسم المنتج حسب اللغة إن متوفر #}
                {% if LANGUAGE_CODE == "ar" and item.product.name_ar %}
                  {{ item.product.name_ar }}
                {% elif LANGUAGE_CODE == "en" and item.product.name_en %}
                  {{ item.product.name_en }}
                {% else %}
                  {{ item.product }}
                {% endif %}
              </td>
              <td class="text-center">{{ item.quantity }}</td>
              <td class="text-end">{{ item.unit_price|floatformat:3 }}</td>
              <td class="text-end">{{ item.subtotal|floatformat:3 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">
                لا توجد بنود في هذا الطلب.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

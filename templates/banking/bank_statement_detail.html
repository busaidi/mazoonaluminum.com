{% extends "accounting/base_accounting.html" %}
{% load i18n %}

{% block accounting_content %}

{# ===================== HEADER ===================== #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="h5 mb-1">
      {{ title|default:_("تفاصيل كشف البنك") }}
    </h2>
    <div class="text-muted small">
      {{ statement.bank_account.name }} –
      {{ statement.date|date:"Y-m-d" }}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'banking:bank_statement_list' %}"
       class="btn btn-outline-secondary btn-sm">
      {% trans "رجوع إلى الكشوفات" %}
    </a>

    {# زر الذهاب لتسوية الحساب البنكي المرتبط بهذا الكشف #}
    <a href="{% url 'banking:reconciliation_dashboard' pk=statement.bank_account.id %}"
       class="btn btn-primary btn-sm">
      {% trans "تسوية الحساب البنكي" %}
    </a>
  </div>
</div>

{# ===================== SUMMARY CARD ===================== #}
<div class="row g-3 mb-3">

  <div class="col-md-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">
          {% trans "الحساب البنكي" %}
        </div>
        <div class="fw-semibold">
          {{ statement.bank_account.name }}
        </div>
        <div class="text-muted small">
          {{ statement.bank_account.account.code }} – {{ statement.bank_account.account.name }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">
          {% trans "الرصيد الافتتاحي / الختامي" %}
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted small">{% trans "افتتاحي:" %}</span>
          <span class="fw-semibold">{{ statement.start_balance }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted small">{% trans "ختامي (مدخل):" %}</span>
          <span class="fw-semibold">{{ statement.end_balance }}</span>
        </div>
      </div>
    </div>
  </div>

  {% with computed=statement.computed_balance %}
  <div class="col-md-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="small text-muted mb-1">
          {% trans "الرصيد المحسوب من الحركات" %}
        </div>
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="fw-semibold">{{ computed }}</span>
          {% if statement.is_valid %}
            <span class="badge bg-success-subtle text-success-emphasis">
              {% trans "متطابق" %}
            </span>
          {% else %}
            <span class="badge bg-danger-subtle text-danger-emphasis">
              {% trans "غير متطابق" %}
            </span>
          {% endif %}
        </div>

        {% if not statement.is_valid %}
          <div class="small text-muted">
            {% trans "هناك فرق بين الرصيد الختامي المدخل والرصيد المحسوب من الحركات." %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endwith %}

</div>

{# ===================== LINES TABLE ===================== #}
<div class="card shadow-sm border-0">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="fw-semibold">
      {% trans "حركات الكشف" %}
    </span>
    <span class="badge bg-secondary-subtle text-secondary-emphasis small">
      {{ lines|length }} {% trans "حركة" %}
    </span>
  </div>

  <div class="card-body p-0">
    {% if lines %}
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>{% trans "التاريخ" %}</th>
              <th>{% trans "البيان" %}</th>
              <th>{% trans "المرجع" %}</th>
              <th class="text-end">{% trans "المبلغ" %}</th>
              <th class="text-end">{% trans "المتبقي للتسوية" %}</th>
              <th class="text-center">{% trans "الحالة" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for line in lines %}
              <tr>
                <td class="text-muted small">{{ forloop.counter }}</td>
                <td>{{ line.date|date:"Y-m-d" }}</td>
                <td class="small">
                  {{ line.label }}
                  {% if line.partner_name %}
                    <div class="text-muted small">
                      {% trans "شريك:" %} {{ line.partner_name }}
                    </div>
                  {% endif %}
                </td>
                <td class="small">
                  {{ line.ref|default:"—" }}
                </td>
                <td class="text-end">
                  {{ line.amount }}
                </td>
                <td class="text-end">
                  {{ line.amount_residual }}
                </td>
                <td class="text-center">
                  {% if line.is_reconciled %}
                    <span class="badge bg-success-subtle text-success-emphasis">
                      {% trans "مُسوّى" %}
                    </span>
                  {% else %}
                    <span class="badge bg-warning-subtle text-warning-emphasis">
                      {% trans "غير مُسوّى" %}
                    </span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-4 text-center text-muted small">
        {% trans "لا توجد حركات مسجلة في هذا الكشف." %}
      </div>
    {% endif %}
  </div>
</div>

{% endblock accounting_content %}
